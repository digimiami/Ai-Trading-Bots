{"version":3,"mappings":"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","names":["OpenAIService","__publicField","savedProvider","apiKey","provider","isAvailable","storedOpenAI","storedDeepSeek","supabase","__vitePreload","data","error","_a","_b","status","storedKey","botId","performanceData","prompt","response","symbol","marketData","historicalTrades","strategies","recentTrades","performanceMetrics","strategySize","advancedSize","tradesSize","t","metrics","strategyStrSize","advancedStrSize","e","strategySummary","advancedSummary","strategyStr","advancedStr","winRate","totalPnL","profitFactor","sharpeRatio","maxDrawdown","s","sd","o","p","rsi","adx","strategyObj","wr","pnl","pf","trades","sym","out","useJsonMode","promptTokens","parts","aiConfig","body","errorMsg","requestStartTime","requestDuration","errorText","content","_c","parsed","jsonMatch","currentStrategies","optimizedStrategy","optimizedAdvancedConfig","openAIService"],"sources":["../../src/services/openai.ts"],"sourcesContent":["/**\r\n * OpenAI Integration Service\r\n * Provides self-learning capabilities for trading bots\r\n */\r\n\r\nimport type { TradingStrategy, AdvancedStrategyConfig } from '../types/trading';\r\n\r\ninterface TradeAnalysis {\r\n  symbol: string;\r\n  side?: string; // Optional: 'buy' or 'sell'\r\n  entryPrice: number;\r\n  exitPrice?: number; // Optional: may not be set for open positions\r\n  pnl: number;\r\n  indicators: {\r\n    rsi: number;\r\n    adx: number;\r\n    bbWidth: number;\r\n    volume: number;\r\n  };\r\n  outcome: 'win' | 'loss';\r\n  timestamp: string;\r\n}\r\n\r\ninterface PerformanceData {\r\n  totalTrades: number;\r\n  winRate: number;\r\n  totalPnL: number;\r\n  avgWinPnL: number;\r\n  avgLossPnL: number;\r\n  maxDrawdown: number;\r\n  sharpeRatio: number;\r\n  bestPerformingPair: string;\r\n  worstPerformingPair: string;\r\n  recentTrades: TradeAnalysis[];\r\n  timeRange: string;\r\n}\r\n\r\ninterface AIRecommendation {\r\n  recommended: boolean;\r\n  confidence: number;\r\n  reasoning: string;\r\n  suggestedParameters: {\r\n    rsiThreshold?: number;\r\n    adxThreshold?: number;\r\n    stopLoss?: number;\r\n    takeProfit?: number;\r\n    leverage?: number;\r\n  };\r\n  expectedImprovement: string;\r\n  riskAssessment: string;\r\n}\r\n\r\nclass OpenAIService {\r\n  private apiKey: string;\r\n  private baseUrl: string = 'https://api.openai.com/v1';\r\n  private deepseekApiKey: string;\r\n  private deepseekBaseUrl: string = 'https://api.deepseek.com/v1';\r\n  private useDeepSeek: boolean = false;\r\n\r\n  constructor() {\r\n    // Load API keys from environment variables or localStorage\r\n    this.apiKey = import.meta.env.VITE_OPENAI_API_KEY || localStorage.getItem('ai_openai_api_key') || '';\r\n    this.deepseekApiKey = import.meta.env.VITE_DEEPSEEK_API_KEY || localStorage.getItem('ai_deepseek_api_key') || '';\r\n    \r\n    // Load provider preference from localStorage, default to DeepSeek if available\r\n    const savedProvider = localStorage.getItem('ai_provider_preference');\r\n    if (savedProvider === 'openai' || savedProvider === 'deepseek') {\r\n      this.useDeepSeek = savedProvider === 'deepseek';\r\n    } else {\r\n      // Auto-detect: Prefer DeepSeek if available\r\n      this.useDeepSeek = !!this.deepseekApiKey;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set OpenAI API key (for UI configuration)\r\n   */\r\n  setOpenAIKey(apiKey: string): void {\r\n    this.apiKey = apiKey;\r\n    if (apiKey) {\r\n      localStorage.setItem('ai_openai_api_key', apiKey);\r\n      console.log('‚úÖ OpenAI API key saved');\r\n    } else {\r\n      localStorage.removeItem('ai_openai_api_key');\r\n      console.log('‚úÖ OpenAI API key removed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Set DeepSeek API key (for UI configuration)\r\n   */\r\n  setDeepSeekKey(apiKey: string): void {\r\n    this.deepseekApiKey = apiKey;\r\n    if (apiKey) {\r\n      localStorage.setItem('ai_deepseek_api_key', apiKey);\r\n      console.log('‚úÖ DeepSeek API key saved');\r\n    } else {\r\n      localStorage.removeItem('ai_deepseek_api_key');\r\n      console.log('‚úÖ DeepSeek API key removed');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get current API keys (masked for security)\r\n   */\r\n  getApiKeys(): { openai: string; deepseek: string } {\r\n    return {\r\n      openai: this.apiKey ? `${this.apiKey.substring(0, 7)}...${this.apiKey.substring(this.apiKey.length - 4)}` : '',\r\n      deepseek: this.deepseekApiKey ? `${this.deepseekApiKey.substring(0, 7)}...${this.deepseekApiKey.substring(this.deepseekApiKey.length - 4)}` : ''\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Set AI provider preference\r\n   */\r\n  setProvider(provider: 'openai' | 'deepseek'): void {\r\n    // Check availability using the method that checks Edge Function secrets first\r\n    // This ensures keys stored in Edge Function secrets are recognized\r\n    const isAvailable = this.isProviderAvailable(provider);\r\n    \r\n    if (!isAvailable) {\r\n      console.warn(`${provider === 'deepseek' ? 'DeepSeek' : 'OpenAI'} API key not configured`);\r\n      // Still allow setting the preference, but warn the user\r\n      // The UI should handle disabling unavailable providers\r\n    }\r\n    \r\n    this.useDeepSeek = provider === 'deepseek';\r\n    localStorage.setItem('ai_provider_preference', provider);\r\n    console.log(`‚úÖ AI Provider set to: ${provider}${isAvailable ? '' : ' (key not configured, may not work)'}`);\r\n  }\r\n\r\n  /**\r\n   * Get current AI provider preference\r\n   */\r\n  getProvider(): 'openai' | 'deepseek' {\r\n    return this.useDeepSeek ? 'deepseek' : 'openai';\r\n  }\r\n\r\n  /**\r\n   * Refresh API keys from localStorage (useful after saving via UI)\r\n   */\r\n  refreshKeys(): void {\r\n    // Always reload from localStorage first (user-set keys take precedence)\r\n    const storedOpenAI = localStorage.getItem('ai_openai_api_key');\r\n    const storedDeepSeek = localStorage.getItem('ai_deepseek_api_key');\r\n    \r\n    // Only use env vars if localStorage doesn't have the key\r\n    if (storedOpenAI) {\r\n      this.apiKey = storedOpenAI;\r\n      console.log('‚úÖ OpenAI key refreshed from localStorage');\r\n    } else if (import.meta.env.VITE_OPENAI_API_KEY) {\r\n      this.apiKey = import.meta.env.VITE_OPENAI_API_KEY;\r\n      console.log('‚úÖ OpenAI key loaded from env var');\r\n    } else {\r\n      this.apiKey = '';\r\n    }\r\n    \r\n    if (storedDeepSeek) {\r\n      this.deepseekApiKey = storedDeepSeek;\r\n      console.log('‚úÖ DeepSeek key refreshed from localStorage');\r\n    } else if (import.meta.env.VITE_DEEPSEEK_API_KEY) {\r\n      this.deepseekApiKey = import.meta.env.VITE_DEEPSEEK_API_KEY;\r\n      console.log('‚úÖ DeepSeek key loaded from env var');\r\n    } else {\r\n      this.deepseekApiKey = '';\r\n    }\r\n    \r\n    console.log('üîÑ AI API keys refreshed:', {\r\n      openai: !!this.apiKey,\r\n      deepseek: !!this.deepseekApiKey\r\n    });\r\n  }\r\n\r\n  private aiKeysStatus: { openai: boolean; deepseek: boolean } | null = null;\r\n  private aiKeysCheckPromise: Promise<void> | null = null;\r\n\r\n  /**\r\n   * Check AI keys availability from Edge Function secrets (async)\r\n   */\r\n  async checkKeysFromEdgeFunction(): Promise<{ openai: boolean; deepseek: boolean }> {\r\n    // Return cached status if available\r\n    if (this.aiKeysStatus !== null) {\r\n      return this.aiKeysStatus;\r\n    }\r\n\r\n    // If check is already in progress, wait for it\r\n    if (this.aiKeysCheckPromise) {\r\n      await this.aiKeysCheckPromise;\r\n      return this.aiKeysStatus || { openai: false, deepseek: false };\r\n    }\r\n\r\n    // Start new check\r\n    this.aiKeysCheckPromise = (async () => {\r\n      try {\r\n        // Use supabase.functions.invoke() - this automatically handles authentication\r\n        const { supabase } = await import('../lib/supabase');\r\n        \r\n        const { data, error } = await supabase.functions.invoke('check-ai-keys', {\r\n          method: 'GET'\r\n        });\r\n\r\n        if (error) {\r\n          console.error('‚ö†Ô∏è Failed to check AI keys from Edge Function:', error);\r\n          this.aiKeysStatus = { openai: false, deepseek: false };\r\n          return;\r\n        }\r\n\r\n        if (data) {\r\n          this.aiKeysStatus = {\r\n            openai: data.openai?.available || false,\r\n            deepseek: data.deepseek?.available || false\r\n          };\r\n          console.log('‚úÖ AI keys status from Edge Function:', this.aiKeysStatus);\r\n          if (data.debug) {\r\n            console.log('üîç Debug info from Edge Function:', data.debug);\r\n            console.log(`   DeepSeek key present: ${data.debug.deepseekKeyPresent}, length: ${data.debug.deepseekKeyLength}`);\r\n            console.log(`   OpenAI key present: ${data.debug.openaiKeyPresent}, length: ${data.debug.openaiKeyLength}`);\r\n          }\r\n        } else {\r\n          console.warn('‚ö†Ô∏è No data returned from Edge Function');\r\n          this.aiKeysStatus = { openai: false, deepseek: false };\r\n        }\r\n      } catch (error) {\r\n        console.error('‚ùå Error checking AI keys from Edge Function:', error);\r\n        this.aiKeysStatus = { openai: false, deepseek: false };\r\n      } finally {\r\n        this.aiKeysCheckPromise = null;\r\n      }\r\n    })();\r\n\r\n    await this.aiKeysCheckPromise;\r\n    return this.aiKeysStatus || { openai: false, deepseek: false };\r\n  }\r\n\r\n  /**\r\n   * Check if a provider is available (checks Edge Function secrets first, then fallback to localStorage)\r\n   */\r\n  async isProviderAvailableAsync(provider: 'openai' | 'deepseek'): Promise<boolean> {\r\n    // Check Edge Function secrets first\r\n    const status = await this.checkKeysFromEdgeFunction();\r\n    if (provider === 'deepseek' && status.deepseek) {\r\n      return true;\r\n    }\r\n    if (provider === 'openai' && status.openai) {\r\n      return true;\r\n    }\r\n\r\n    // Fallback to localStorage/client-side keys\r\n    let storedKey = '';\r\n    if (provider === 'deepseek') {\r\n      storedKey = localStorage.getItem('ai_deepseek_api_key') || import.meta.env.VITE_DEEPSEEK_API_KEY || '';\r\n      if (storedKey && storedKey !== this.deepseekApiKey) {\r\n        this.deepseekApiKey = storedKey;\r\n      }\r\n    } else {\r\n      storedKey = localStorage.getItem('ai_openai_api_key') || import.meta.env.VITE_OPENAI_API_KEY || '';\r\n      if (storedKey && storedKey !== this.apiKey) {\r\n        this.apiKey = storedKey;\r\n      }\r\n    }\r\n    \r\n    return !!storedKey || (provider === 'deepseek' ? !!this.deepseekApiKey : !!this.apiKey);\r\n  }\r\n\r\n  /**\r\n   * Synchronous version (for backwards compatibility, uses cached status or localStorage)\r\n   */\r\n  isProviderAvailable(provider: 'openai' | 'deepseek'): boolean {\r\n    // Use cached Edge Function status if available\r\n    if (this.aiKeysStatus) {\r\n      if (provider === 'deepseek' && this.aiKeysStatus.deepseek) return true;\r\n      if (provider === 'openai' && this.aiKeysStatus.openai) return true;\r\n    }\r\n\r\n    // Fallback to localStorage/client-side check\r\n    let storedKey = '';\r\n    if (provider === 'deepseek') {\r\n      storedKey = localStorage.getItem('ai_deepseek_api_key') || import.meta.env.VITE_DEEPSEEK_API_KEY || '';\r\n      if (storedKey && storedKey !== this.deepseekApiKey) {\r\n        this.deepseekApiKey = storedKey;\r\n      }\r\n    } else {\r\n      storedKey = localStorage.getItem('ai_openai_api_key') || import.meta.env.VITE_OPENAI_API_KEY || '';\r\n      if (storedKey && storedKey !== this.apiKey) {\r\n        this.apiKey = storedKey;\r\n      }\r\n    }\r\n    \r\n    return !!storedKey || (provider === 'deepseek' ? !!this.deepseekApiKey : !!this.apiKey);\r\n  }\r\n\r\n  /**\r\n   * Analyze bot performance and generate strategy recommendations\r\n   */\r\n  async analyzeBotPerformance(botId: string, performanceData: PerformanceData): Promise<AIRecommendation> {\r\n    const aiConfig = this.getAIConfig();\r\n    if (!aiConfig.apiKey) {\r\n      console.warn('AI API key not configured (neither DeepSeek nor OpenAI)');\r\n      return this.getDefaultRecommendation();\r\n    }\r\n\r\n    try {\r\n      const prompt = this.buildAnalysisPrompt(botId, performanceData);\r\n      const response = await this.callOpenAI(prompt);\r\n      \r\n      return this.parseAIResponse(response);\r\n    } catch (error) {\r\n      console.error('Error analyzing bot performance:', error);\r\n      return this.getDefaultRecommendation();\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Get trading signal prediction based on current market conditions\r\n   */\r\n  async predictTradeSignal(\r\n    symbol: string,\r\n    marketData: any,\r\n    historicalTrades: TradeAnalysis[]\r\n  ): Promise<{ signal: 'buy' | 'sell' | 'hold'; confidence: number; reasoning: string }> {\r\n    const aiConfig = this.getAIConfig();\r\n    if (!aiConfig.apiKey) {\r\n      return { signal: 'hold', confidence: 0.5, reasoning: 'AI not configured' };\r\n    }\r\n\r\n    try {\r\n      const prompt = this.buildPredictionPrompt(symbol, marketData, historicalTrades);\r\n      const response = await this.callOpenAI(prompt);\r\n      \r\n      return this.parsePredictionResponse(response);\r\n    } catch (error) {\r\n      console.error('Error predicting trade signal:', error);\r\n      return { signal: 'hold', confidence: 0.5, reasoning: 'Prediction failed' };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Learn from trades and suggest parameter optimizations\r\n   * Now supports both TradingStrategy and AdvancedStrategyConfig\r\n   */\r\n  async optimizeStrategy(\r\n    strategies: {\r\n      strategy: TradingStrategy;\r\n      advancedConfig?: AdvancedStrategyConfig;\r\n    },\r\n    recentTrades: TradeAnalysis[],\r\n    performanceMetrics: any\r\n  ): Promise<{\r\n    strategy: TradingStrategy;\r\n    advancedConfig?: AdvancedStrategyConfig;\r\n    reasoning: string;\r\n    expectedImprovement: string;\r\n    confidence: number;\r\n  }> {\r\n    const aiConfig = this.getAIConfig();\r\n    if (!aiConfig.apiKey) {\r\n      return {\r\n        strategy: strategies.strategy,\r\n        advancedConfig: strategies.advancedConfig,\r\n        reasoning: 'AI optimization not available - configure DeepSeek API key or OpenAI API key',\r\n        expectedImprovement: 'N/A',\r\n        confidence: 0\r\n      };\r\n    }\r\n\r\n    try {\r\n      // Debug: Check input sizes BEFORE building prompt\r\n      const strategySize = JSON.stringify(strategies.strategy || {}).length;\r\n      const advancedSize = strategies.advancedConfig ? JSON.stringify(strategies.advancedConfig).length : 0;\r\n      const tradesSize = JSON.stringify(recentTrades || []).length;\r\n      \r\n      console.log(`üìä [OpenAI] Input sizes: strategy=${Math.round(strategySize/1024)}KB, advanced=${Math.round(advancedSize/1024)}KB, trades=${Math.round(tradesSize/1024)}KB, total=${Math.round((strategySize + advancedSize + tradesSize)/1024)}KB`);\r\n      \r\n      if (strategySize > 50000 || advancedSize > 50000 || tradesSize > 50000) {\r\n        console.warn(`‚ö†Ô∏è [OpenAI] Large input detected! Strategy: ${Math.round(strategySize/1024)}KB, Advanced: ${Math.round(advancedSize/1024)}KB, Trades: ${Math.round(tradesSize/1024)}KB`);\r\n      }\r\n      \r\n      const prompt = this.buildOptimizationPrompt(strategies, recentTrades, performanceMetrics);\r\n      console.log(`üìä [OpenAI] Final prompt size: ${Math.round(prompt.length/1024)}KB (${Math.round(prompt.length * 0.75 / 1000)}K tokens estimated)`);\r\n      \r\n      const response = await this.callOpenAI(prompt);\r\n      \r\n      return this.parseOptimizationResponse(response, strategies);\r\n    } catch (error) {\r\n      console.error('Error optimizing strategy:', error);\r\n      return {\r\n        strategy: strategies.strategy,\r\n        advancedConfig: strategies.advancedConfig,\r\n        reasoning: 'Optimization failed',\r\n        expectedImprovement: 'Unknown',\r\n        confidence: 0\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Build analysis prompt for OpenAI\r\n   */\r\n  private buildAnalysisPrompt(botId: string, performanceData: PerformanceData): string {\r\n    return `\r\nYou are an advanced trading bot AI advisor. Analyze the following bot performance and provide recommendations.\r\n\r\nBot Performance Data:\r\n- Total Trades: ${performanceData.totalTrades}\r\n- Win Rate: ${performanceData.winRate}%\r\n- Total PnL: $${performanceData.totalPnL}\r\n- Sharpe Ratio: ${performanceData.sharpeRatio}\r\n- Best Pair: ${performanceData.bestPerformingPair}\r\n- Worst Pair: ${performanceData.worstPerformingPair}\r\n- Max Drawdown: ${performanceData.maxDrawdown}%\r\n\r\nRecent Trades Summary:\r\n${performanceData.recentTrades.slice(-10).map(t => \r\n  `- ${t.symbol}: ${t.outcome} (PnL: $${t.pnl.toFixed(2)})`\r\n).join('\\n')}\r\n\r\nProvide a JSON response with:\r\n{\r\n  \"recommended\": boolean,\r\n  \"confidence\": number (0-1),\r\n  \"reasoning\": \"Detailed explanation\",\r\n  \"suggestedParameters\": {\r\n    \"rsiThreshold\": number,\r\n    \"adxThreshold\": number,\r\n    \"stopLoss\": number,\r\n    \"takeProfit\": number,\r\n    \"leverage\": number\r\n  },\r\n  \"expectedImprovement\": \"Expected performance improvement\",\r\n  \"riskAssessment\": \"Risk level assessment\"\r\n}\r\n`.trim();\r\n  }\r\n\r\n  /**\r\n   * Build prediction prompt for trade signals\r\n   */\r\n  private buildPredictionPrompt(symbol: string, marketData: any, historicalTrades: TradeAnalysis[]): string {\r\n    return `\r\nAnalyze market data for ${symbol} and provide a trading recommendation.\r\n\r\nCurrent Market Data:\r\n- RSI: ${marketData.rsi}\r\n- ADX: ${marketData.adx}\r\n- BB Width: ${marketData.bbWidth}\r\n- Volume: ${marketData.volume}\r\n\r\nRecent Trade History (this bot):\r\n${historicalTrades.slice(-5).map(t => \r\n  `- ${t.symbol}: ${t.outcome}, PnL: $${t.pnl.toFixed(2)}`\r\n).join('\\n')}\r\n\r\nProvide a JSON response with:\r\n{\r\n  \"signal\": \"buy|sell|hold\",\r\n  \"confidence\": number (0-1),\r\n  \"reasoning\": \"Why this signal\"\r\n}\r\n`.trim();\r\n  }\r\n\r\n  /**\r\n   * Build optimization prompt for both strategy types\r\n   */\r\n  private buildOptimizationPrompt(\r\n    strategies: { strategy: TradingStrategy; advancedConfig?: AdvancedStrategyConfig },\r\n    recentTrades: TradeAnalysis[],\r\n    metrics: any\r\n  ): string {\r\n    // Check input size first - if strategies are huge, use minimal format immediately\r\n    // Use try-catch in case strategy has circular references or huge nested objects\r\n    let strategyStrSize = 0;\r\n    let advancedStrSize = 0;\r\n    try {\r\n      strategyStrSize = JSON.stringify(strategies.strategy || {}).length;\r\n      advancedStrSize = strategies.advancedConfig ? JSON.stringify(strategies.advancedConfig).length : 0;\r\n    } catch (e) {\r\n      console.error('Error stringifying strategies:', e);\r\n      // If stringify fails (circular refs, etc), use minimal format\r\n      return this.buildMinimalPrompt(strategies, metrics, recentTrades);\r\n    }\r\n    \r\n    // If input is already too large (over 50KB), use minimal format\r\n    if (strategyStrSize + advancedStrSize > 50000) {\r\n      console.warn(`‚ö†Ô∏è Input strategies too large (${Math.round((strategyStrSize + advancedStrSize)/1024)}KB). Using minimal format.`);\r\n      return this.buildMinimalPrompt(strategies, metrics, recentTrades);\r\n    }\r\n\r\n    // Extract only essential numeric values to minimize size\r\n    const strategySummary = {\r\n      rsi: strategies.strategy.rsiThreshold,\r\n      adx: strategies.strategy.adxThreshold,\r\n      bbw: strategies.strategy.bbWidthThreshold,\r\n      ema: strategies.strategy.emaSlope,\r\n      atr: strategies.strategy.atrPercentage,\r\n      vwap: strategies.strategy.vwapDistance,\r\n      mom: strategies.strategy.momentumThreshold,\r\n      ml: strategies.strategy.useMLPrediction\r\n    };\r\n    \r\n    const advancedSummary = strategies.advancedConfig ? {\r\n      bias: strategies.advancedConfig.bias_mode,\r\n      risk: strategies.advancedConfig.risk_per_trade_pct,\r\n      adxHtf: strategies.advancedConfig.adx_min_htf,\r\n      regime: strategies.advancedConfig.regime_mode,\r\n      sl: strategies.advancedConfig.sl_atr_mult,\r\n      tp1: strategies.advancedConfig.tp1_r,\r\n      tp2: strategies.advancedConfig.tp2_r\r\n    } : null;\r\n\r\n    // Build compact summary strings (no JSON overhead)\r\n    const strategyStr = `rsi:${strategySummary.rsi},adx:${strategySummary.adx},bbw:${strategySummary.bbw},ema:${strategySummary.ema},atr:${strategySummary.atr},vwap:${strategySummary.vwap},mom:${strategySummary.mom},ml:${strategySummary.ml}`;\r\n    const advancedStr = advancedSummary ? \r\n      `bias:${advancedSummary.bias},risk:${advancedSummary.risk},adxHtf:${advancedSummary.adxHtf},regime:${advancedSummary.regime},sl:${advancedSummary.sl},tp1:${advancedSummary.tp1},tp2:${advancedSummary.tp2}` : '';\r\n\r\n    // Safely extract metrics with defaults to prevent undefined errors\r\n    const winRate = metrics?.winRate ?? 0;\r\n    const totalPnL = metrics?.totalPnL ?? 0;\r\n    const profitFactor = metrics?.profitFactor ?? 0;\r\n    const sharpeRatio = metrics?.sharpeRatio ?? 0;\r\n    const maxDrawdown = metrics?.maxDrawdown ?? 0;\r\n\r\n    return `\r\nOptimize trading strategy.\r\n\r\nCURRENT:\r\nS:${strategyStr}\r\n${advancedStr ? `A:${advancedStr}` : ''}\r\n\r\nPERF:\r\nWR:${Math.round(winRate)}% PnL:$${Math.round(totalPnL)} PF:${profitFactor.toFixed(2)} SR:${sharpeRatio.toFixed(2)} DD:${Math.round(maxDrawdown)}%\r\n\r\nTRADES (last 3):\r\n${recentTrades.slice(-3).map(t => {\r\n  const s = (t.symbol || 'X').substring(0, 3);\r\n  const sd = t.side ? t.side[0] : '?';\r\n  const o = (t.outcome || 'u')[0];\r\n  const p = Math.round(t.pnl || 0);\r\n  return `${s}${sd}:${o}$${p}`;\r\n}).join(' ')}\r\n\r\nReturn JSON:\r\n{\r\n  \"strategy\": {\"rsiThreshold\":num,\"adxThreshold\":num,\"bbWidthThreshold\":num,\"emaSlope\":num,\"atrPercentage\":num,\"vwapDistance\":num,\"momentumThreshold\":num,\"useMLPrediction\":bool,\"minSamplesForML\":num},\r\n  ${advancedSummary ? `\"advancedConfig\": {\"bias_mode\":\"str\",\"risk_per_trade_pct\":num,\"adx_min_htf\":num,\"regime_mode\":\"str\",\"sl_atr_mult\":num,\"tp1_r\":num,\"tp2_r\":num},` : ''}\r\n  \"reasoning\": \"brief\",\r\n  \"expectedImprovement\": \"brief\",\r\n  \"confidence\": num\r\n}\r\n`.trim();\r\n  }\r\n\r\n  /**\r\n   * Build ultra-minimal prompt for very large inputs\r\n   */\r\n  private buildMinimalPrompt(\r\n    strategies: { strategy: TradingStrategy; advancedConfig?: AdvancedStrategyConfig },\r\n    metrics: any,\r\n    recentTrades: TradeAnalysis[]\r\n  ): string {\r\n    // Extract only key numbers - handle both object and potentially string formats\r\n    let rsi = 0;\r\n    let adx = 0;\r\n    \r\n    try {\r\n      // Handle if strategy is a string (double-encoded) or object\r\n      let strategyObj = strategies.strategy;\r\n      if (typeof strategyObj === 'string') {\r\n        try {\r\n          strategyObj = JSON.parse(strategyObj);\r\n          // Check if still string (double-encoded)\r\n          if (typeof strategyObj === 'string') {\r\n            strategyObj = JSON.parse(strategyObj);\r\n          }\r\n        } catch (e) {\r\n          console.warn('Could not parse strategy string:', e);\r\n        }\r\n      }\r\n      \r\n      // Extract values safely\r\n      rsi = (strategyObj as any)?.rsiThreshold || (strategyObj as any)?.rsi || 0;\r\n      adx = (strategyObj as any)?.adxThreshold || (strategyObj as any)?.adx || 0;\r\n    } catch (e) {\r\n      console.warn('Error extracting strategy values:', e);\r\n    }\r\n    \r\n    const wr = Math.round(metrics?.winRate || 0);\r\n    const pnl = Math.round(metrics?.totalPnL || 0);\r\n    const pf = parseFloat((metrics?.profitFactor || 0).toFixed(1));\r\n    \r\n    // Last 2 trades only, minimal format\r\n    const trades = recentTrades.slice(-2).map(t => {\r\n      const sym = (t.symbol || 'X').substring(0, 2);\r\n      const out = (t.outcome || 'u')[0];\r\n      const p = Math.round(t.pnl || 0);\r\n      return `${sym}${out}$${p}`;\r\n    }).join(',');\r\n    \r\n    const prompt = `Opt: rsi:${rsi},adx:${adx} WR:${wr}% PnL:$${pnl} PF:${pf} Trades:${trades}. Return JSON: strategy params, reasoning, confidence.`;\r\n    \r\n    console.log(`üìä [Minimal Prompt] Size: ${Math.round(prompt.length/1024)}KB, Content: ${prompt.substring(0, 200)}...`);\r\n    \r\n    return prompt;\r\n  }\r\n\r\n  /**\r\n   * Get the active AI provider configuration\r\n   */\r\n  private getAIConfig(): { apiKey: string; baseUrl: string; model: string; provider: string } {\r\n    if (this.useDeepSeek && this.deepseekApiKey) {\r\n      console.log(`üîë [getAIConfig] Using DeepSeek API key (length: ${this.deepseekApiKey.length})`);\r\n      return {\r\n        apiKey: this.deepseekApiKey,\r\n        baseUrl: this.deepseekBaseUrl,\r\n        model: 'deepseek-chat',\r\n        provider: 'DeepSeek'\r\n      };\r\n    }\r\n    \r\n    if (!this.apiKey) {\r\n      console.error('‚ùå [getAIConfig] OpenAI API key is missing! Keys must be stored in localStorage or env vars for client-side API calls.');\r\n      console.log('üí° Tip: Edge Function secrets are server-side only. For client-side recommendations, add your API keys in Settings ‚Üí AI Recommendations.');\r\n    } else {\r\n      console.log(`üîë [getAIConfig] Using OpenAI API key (length: ${this.apiKey.length})`);\r\n    }\r\n    \r\n    return {\r\n      apiKey: this.apiKey,\r\n      baseUrl: this.baseUrl,\r\n      model: 'gpt-4o',\r\n      provider: 'OpenAI'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Call AI API (DeepSeek or OpenAI) with JSON mode support\r\n   */\r\n  private async callOpenAI(prompt: string, useJsonMode: boolean = true): Promise<any> {\r\n      // Check prompt size and warn if too large\r\n      // More accurate token estimate: ~0.75 tokens per character for English text\r\n      const promptTokens = Math.ceil(prompt.length * 0.75);\r\n      if (promptTokens > 50000) {\r\n        console.warn(`‚ö†Ô∏è Large prompt detected (~${Math.round(promptTokens/1000)}K tokens). Prompt size: ${Math.round(prompt.length/1024)}KB`);\r\n        // If still too large, truncate prompt more aggressively\r\n        if (promptTokens > 100000) {\r\n          console.error(`‚ùå Prompt too large (${Math.round(promptTokens/1000)}K tokens). Truncating...`);\r\n          // Keep only essential parts - remove advanced config entirely if too large\r\n          const parts = prompt.split('ADVANCED');\r\n          if (parts.length > 1) {\r\n            prompt = parts[0] + 'PERFORMANCE: [metrics summary only]';\r\n          } else {\r\n            // If no ADVANCED section, just keep first 50000 chars\r\n            prompt = prompt.substring(0, 50000);\r\n          }\r\n        }\r\n      }\r\n\r\n      const aiConfig = this.getAIConfig();\r\n      const body: any = {\r\n      model: aiConfig.model,\r\n      messages: [\r\n        { \r\n          role: 'system', \r\n          content: 'You are a professional trading analyst. Provide data-driven recommendations. Always respond with valid JSON only.' \r\n        },\r\n        { role: 'user', content: prompt }\r\n      ],\r\n      temperature: 0.3, // Lower temperature for more consistent, logical responses\r\n      max_tokens: 1000 // Reduced to prevent token limit issues\r\n    };\r\n\r\n    // Use JSON mode if available (for better JSON parsing)\r\n    if (useJsonMode) {\r\n      body.response_format = { type: 'json_object' };\r\n    }\r\n\r\n    console.log(`ü§ñ Using ${aiConfig.provider} API (${aiConfig.model}) for optimization`);\r\n    console.log(`üåê [API Call] Making request to ${aiConfig.baseUrl}/chat/completions`);\r\n    console.log(`üîë [API Call] API key present: ${!!aiConfig.apiKey} (length: ${aiConfig.apiKey?.length || 0})`);\r\n\r\n    if (!aiConfig.apiKey) {\r\n      const errorMsg = `‚ùå ${aiConfig.provider} API key is missing! Cannot make API call.`;\r\n      console.error(errorMsg);\r\n      console.error('üí° Note: API keys stored in Edge Function secrets are server-side only.');\r\n      console.error('üí° For client-side recommendations, you must add API keys in Settings ‚Üí AI Recommendations.');\r\n      throw new Error(errorMsg);\r\n    }\r\n\r\n    const requestStartTime = Date.now();\r\n    const response = await fetch(`${aiConfig.baseUrl}/chat/completions`, {\r\n      method: 'POST',\r\n      headers: {\r\n        'Content-Type': 'application/json',\r\n        'Authorization': `Bearer ${aiConfig.apiKey}`\r\n      },\r\n      body: JSON.stringify(body)\r\n    });\r\n\r\n    const requestDuration = Date.now() - requestStartTime;\r\n    console.log(`‚è±Ô∏è [API Call] Response received in ${requestDuration}ms, status: ${response.status}`);\r\n\r\n    if (!response.ok) {\r\n      const errorText = await response.text();\r\n      console.error(`‚ùå ${aiConfig.provider} API error:`, response.status, errorText);\r\n      throw new Error(`${aiConfig.provider} API error: ${response.status}`);\r\n    }\r\n\r\n    console.log(`‚úÖ [API Call] ${aiConfig.provider} API call successful!`);\r\n\r\n    const data = await response.json();\r\n    const content = data.choices[0]?.message?.content;\r\n    \r\n    console.log(`üì¶ [API Call] Response parsed, content length: ${content?.length || 0} chars`);\r\n    \r\n    if (!content) {\r\n      console.error(`‚ùå [API Call] No content in ${aiConfig.provider} response:`, data);\r\n      throw new Error('No content in OpenAI response');\r\n    }\r\n\r\n    try {\r\n      const parsed = JSON.parse(content);\r\n      console.log(`‚úÖ [API Call] Successfully parsed JSON response from ${aiConfig.provider}`);\r\n      return parsed;\r\n    } catch (parseError) {\r\n      console.warn(`‚ö†Ô∏è [API Call] JSON parse error, attempting to extract JSON from content`);\r\n      // Try to extract JSON from markdown code blocks\r\n      const jsonMatch = content.match(/```json\\s*(\\{.*\\})\\s*```/s) || content.match(/(\\{.*\\})/s);\r\n      if (jsonMatch) {\r\n        return JSON.parse(jsonMatch[1]);\r\n      }\r\n      throw new Error('Failed to parse OpenAI response as JSON');\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Parse AI response for recommendations\r\n   */\r\n  private parseAIResponse(response: any): AIRecommendation {\r\n    return {\r\n      recommended: response.recommended || false,\r\n      confidence: response.confidence || 0.5,\r\n      reasoning: response.reasoning || 'No analysis available',\r\n      suggestedParameters: response.suggestedParameters || {},\r\n      expectedImprovement: response.expectedImprovement || 'Unknown',\r\n      riskAssessment: response.riskAssessment || 'Unknown'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Parse prediction response\r\n   */\r\n  private parsePredictionResponse(response: any): { signal: 'buy' | 'sell' | 'hold'; confidence: number; reasoning: string } {\r\n    return {\r\n      signal: response.signal || 'hold',\r\n      confidence: response.confidence || 0.5,\r\n      reasoning: response.reasoning || 'No prediction available'\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Parse optimization response for both strategy types\r\n   */\r\n  private parseOptimizationResponse(\r\n    response: any, \r\n    currentStrategies: { strategy: TradingStrategy; advancedConfig?: AdvancedStrategyConfig }\r\n  ): {\r\n    strategy: TradingStrategy;\r\n    advancedConfig?: AdvancedStrategyConfig;\r\n    reasoning: string;\r\n    expectedImprovement: string;\r\n    confidence: number;\r\n  } {\r\n    // Merge suggested strategy parameters with current strategy\r\n    const optimizedStrategy: TradingStrategy = {\r\n      ...currentStrategies.strategy,\r\n      ...(response.strategy || response.suggestedParameters || {})\r\n    };\r\n\r\n    // Merge advanced config if provided\r\n    let optimizedAdvancedConfig: AdvancedStrategyConfig | undefined;\r\n    if (currentStrategies.advancedConfig || response.advancedConfig) {\r\n      optimizedAdvancedConfig = {\r\n        ...currentStrategies.advancedConfig,\r\n        ...(response.advancedConfig || {})\r\n      };\r\n    }\r\n\r\n    return {\r\n      strategy: optimizedStrategy,\r\n      advancedConfig: optimizedAdvancedConfig,\r\n      reasoning: response.reasoning || 'AI-generated optimization',\r\n      expectedImprovement: response.expectedImprovement || 'Performance improvement expected',\r\n      confidence: response.confidence || 0.7\r\n    };\r\n  }\r\n\r\n  /**\r\n   * Get default recommendation when API is not available\r\n   */\r\n  private getDefaultRecommendation(): AIRecommendation {\r\n    return {\r\n      recommended: false,\r\n      confidence: 0.5,\r\n      reasoning: 'AI analysis not available. Configure OpenAI API key to enable self-learning features.',\r\n      suggestedParameters: {},\r\n      expectedImprovement: 'N/A',\r\n      riskAssessment: 'Unable to assess without AI'\r\n    };\r\n  }\r\n}\r\n\r\nexport const openAIService = new OpenAIService();\r\n\r\n"],"file":"assets/openai-7985918e.js"}