import{r as y,s as J,j as t}from"./index-3620eb22.js";import{H as G}from"./Header-6e104d49.js";import{N as K}from"./Navigation-959f7d1e.js";import{C as u}from"./Card-e9afd4b0.js";import{P as X}from"./PaperTradingPerformance-4126e13f.js";import"./Button-76fb1a28.js";function ne(v,w,N){const[O,f]=y.useState(!0),[C,k]=y.useState(null),[z,$]=y.useState(null),[F,r]=y.useState(null),U=async()=>{var P;F&&F.abort();const T=new AbortController;r(T);try{f(!0),k(null);const b=w||new Date,p=v||new Date(Date.now()-7*24*60*60*1e3);let I=J.from("trades").select("*, trading_bots(symbol, trading_type)").gte("created_at",p.toISOString()).lte("created_at",b.toISOString()).order("created_at",{ascending:!1}).limit(1e4);const{data:V,error:A}=await I;if(T.signal.aborted)return;if(A)throw A;let x=V||[];if(N&&N!=="all"){const e=N==="perpetuals"?"futures":"spot";x=x.filter(s=>{var n;return((n=s.trading_bots)==null?void 0:n.trading_type)===e})}if(!x||x.length===0){$({overview:{totalPnL:0,tradingVolume:0,totalTrades:0,winRate:0,avgWin:0,avgLoss:0,profitableDays:0,totalDays:0},dailyPnL:[],symbolRanking:[]});return}if(x.length>0){const e=x[0],s=[...new Set(x.map(o=>o.status))],n=[...new Set(x.map(o=>o.side))],l=x.filter(o=>o.exit_price).length;console.log(`ðŸ“Š Sample trade data: Count=${x.length}, Statuses=[${s.join(", ")}], Sides=[${n.join(", ")}], HasExitPrice=${l}/${x.length}`),console.log(`ðŸ“Š First trade: ID=${(P=e.id)==null?void 0:P.substring(0,8)}, Status=${e.status}, Side=${e.side}, Entry=${e.entry_price||e.price}, Exit=${e.exit_price||"none"}, Size=${e.size||e.amount}, PnL=${e.pnl||0}`)}const R=x.filter(e=>e.status==="filled"||e.status==="closed"||e.status==="completed"),E=new Map;R.forEach(e=>{var n;const s=e.symbol||((n=e.trading_bots)==null?void 0:n.symbol);E.has(s)||E.set(s,[]),E.get(s).push(e)});const a=new Map;E.forEach((e,s)=>{e.sort((d,i)=>{const j=new Date(d.executed_at||d.created_at||d.timestamp||0).getTime(),h=new Date(i.executed_at||i.created_at||i.timestamp||0).getTime();return j-h});const n=[],l=[];e.forEach(d=>{const i=(d.side||"long").toLowerCase();i==="long"||i==="buy"?n.push(d):(i==="short"||i==="sell")&&l.push(d)});let o=0;l.forEach(d=>{for(;o<n.length;){const i=n[o],j=parseFloat(i.entry_price||i.price||0),h=parseFloat(d.entry_price||d.price||0),D=parseFloat(i.size||i.amount||0),_=parseFloat(d.size||d.amount||0);if(j>0&&h>0&&D>0&&_>0){const B=Math.min(D,_),M=(h-j)*B;if(!a.has(i.id))a.set(i.id,{...i,pnl:M,matched:!0});else{const W=a.get(i.id);a.set(i.id,{...W,pnl:(W.pnl||0)+M})}if(!a.has(d.id))a.set(d.id,{...d,pnl:M,matched:!0});else{const W=a.get(d.id);a.set(d.id,{...W,pnl:(W.pnl||0)+M})}if(_>=D){o++;break}else{n[o]={...i,size:D-_};break}}else o++}})});const c=R.map(e=>{var j;if(a.has(e.id))return a.get(e.id);if(e.pnl!==null&&e.pnl!==void 0&&parseFloat(e.pnl)!==0)return e;const s=parseFloat(e.entry_price||e.price||0),n=parseFloat(e.exit_price||0),l=parseFloat(e.size||e.amount||0),o=(e.side||"long").toLowerCase(),d=parseFloat(e.fee||0);if(R.length>0&&!e.pnl&&R.indexOf(e)<3){const h=n?s===0?"Missing entry_price":l===0?"Missing size":"Unknown":"Missing exit_price";console.log(`ðŸ“Š Trade PnL calculation (first 3): ID=${((j=e.id)==null?void 0:j.substring(0,8))||"unknown"}, Status=${e.status}, Side=${o}, Entry=${s}, Exit=${n}, Size=${l}, Reason="${h}", CanCalculate=${s>0&&n>0&&l>0}`)}if(s>0&&n>0&&l>0){let h=0;return o==="long"?h=(n-s)*l-d:h=(s-n)*l-d,{...e,pnl:h}}return e}),g=c.filter(e=>{const s=parseFloat(e.pnl||0);return!isNaN(s)&&s!==0}),m=g.filter(e=>(parseFloat(e.pnl)||0)>0),S=g.filter(e=>(parseFloat(e.pnl)||0)<=0),H=g.reduce((e,s)=>e+(parseFloat(s.pnl)||0),0),Y=x.reduce((e,s)=>{const n=parseFloat(s.amount||s.size||0),l=parseFloat(s.price||s.entry_price||0);return e+n*l},0),Z=g.length>0?m.length/g.length*100:0,ee=m.length>0?m.reduce((e,s)=>e+(parseFloat(s.pnl)||0),0)/m.length:0,te=S.length>0?S.reduce((e,s)=>e+Math.abs(parseFloat(s.pnl)||0),0)/S.length:0,q=new Map;c.forEach(e=>{const s=e.executed_at||e.created_at||e.timestamp,n=new Date(s).toISOString().split("T")[0];q.has(n)||q.set(n,{date:n,pnl:0,volume:0,trades:0,profit:0,loss:0});const l=q.get(n);let o=parseFloat(e.pnl)||0;if(o===0){const h=parseFloat(e.entry_price||e.price||0),D=parseFloat(e.exit_price||0),_=parseFloat(e.size||e.amount||0),B=(e.side||"long").toLowerCase(),M=parseFloat(e.fee||0);h>0&&D>0&&_>0&&(B==="long"?o=(D-h)*_-M:o=(h-D)*_-M)}const d=parseFloat(e.amount||e.size||0),i=parseFloat(e.price||e.entry_price||0),j=d*i;l.pnl+=o,l.volume+=j,l.trades+=1,o>0?l.profit+=o:o<0&&(l.loss+=Math.abs(o))});const Q=Array.from(q.values()).sort((e,s)=>e.date.localeCompare(s.date)).map(e=>({...e,pnl:parseFloat(e.pnl.toFixed(2)),volume:parseFloat(e.volume.toFixed(2))})),ae=Q.filter(e=>e.pnl>0).length,L=new Map;g.forEach(e=>{const s=e.symbol,n=parseFloat(e.pnl)||0,l=parseFloat(e.amount||e.size||0),o=parseFloat(e.price||e.entry_price||0),d=l*o;L.has(s)||L.set(s,{symbol:s,pnl:0,volume:0,trades:0,winRate:0});const i=L.get(s);i.pnl+=n,i.volume+=d,i.trades+=1}),x.forEach(e=>{const s=e.symbol;L.has(s)||L.set(s,{symbol:s,pnl:0,volume:0,trades:0,winRate:0});const n=L.get(s);if(!g.find(l=>l.id===e.id)){const l=parseFloat(e.amount||e.size||0),o=parseFloat(e.price||e.entry_price||0);n.volume+=l*o}n.trades+=1}),L.forEach((e,s)=>{const n=g.filter(l=>l.symbol===s);if(n.length>0){const l=n.filter(o=>(parseFloat(o.pnl)||0)>0).length;e.winRate=l/n.length*100}});const se=Array.from(L.values()).sort((e,s)=>e.pnl-s.pnl).map(e=>({...e,pnl:parseFloat(e.pnl.toFixed(2)),volume:parseFloat(e.volume.toFixed(2)),winRate:parseFloat(e.winRate.toFixed(2))})),re=Math.ceil((b.getTime()-p.getTime())/(1e3*60*60*24));$({overview:{totalPnL:parseFloat(H.toFixed(2)),tradingVolume:parseFloat(Y.toFixed(2)),totalTrades:x.length,winRate:parseFloat(Z.toFixed(2)),avgWin:parseFloat(ee.toFixed(2)),avgLoss:parseFloat(te.toFixed(2)),profitableDays:ae,totalDays:re},dailyPnL:Q,symbolRanking:se})}catch(b){if((b==null?void 0:b.name)==="AbortError"||T.signal.aborted)return;console.error("Error fetching performance data:",b),k(b instanceof Error?b.message:"Failed to fetch performance data")}finally{T.signal.aborted||f(!1)}};return y.useEffect(()=>{if(!(!v||!w||isNaN(v.getTime())||isNaN(w.getTime())))return U(),()=>{F&&F.abort()}},[v==null?void 0:v.getTime(),w==null?void 0:w.getTime(),N]),{metrics:z,loading:O,error:C,refetch:U}}function ge(){var V,A,x,R,E;const[v,w]=y.useState("all"),[N,O]=y.useState("7d"),[f,C]=y.useState(""),[k,z]=y.useState([]),$=y.useCallback(async()=>{try{const{data:{user:a}}=await J.auth.getUser();if(!a){z([]),C("");return}const{data:c}=await J.from("paper_trading_positions").select("symbol").eq("user_id",a.id).eq("status","open"),g=c&&c.length>0?[...new Set(c.map(m=>m.symbol))].sort():[];z(g),C(m=>g.length===0?"":m==="all"?"all":m&&g.includes(m)?m:"")}catch(a){console.error("Error fetching pairs:",a),z([]),C("")}},[]);y.useEffect(()=>{$()},[$]);const F=y.useMemo(()=>{const a=new Date;let c=new Date;switch(N){case"7d":c=new Date(Date.now()-7*24*60*60*1e3);break;case"30d":c=new Date(Date.now()-30*24*60*60*1e3);break;case"60d":c=new Date(Date.now()-60*24*60*60*1e3);break;case"90d":c=new Date(Date.now()-90*24*60*60*1e3);break;case"180d":c=new Date(Date.now()-180*24*60*60*1e3);break;default:c=new Date(Date.now()-7*24*60*60*1e3)}return{start:c,end:a}},[N]),{metrics:r,loading:U,error:T}=ne(F.start,F.end,v),P=a=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(a),b=a=>a>=1e6?`${(a/1e6).toFixed(2)}M`:a>=1e3?`${(a/1e3).toFixed(2)}K`:a.toFixed(2),p=(r==null?void 0:r.dailyPnL)||[],I=Math.max(...p.map(a=>Math.abs(a.pnl))||[0],1);return Math.min(...p.map(a=>a.pnl)||[0],0),(V=r==null?void 0:r.symbolRanking)!=null&&V[0],(A=r==null?void 0:r.symbolRanking)!=null&&A[(r==null?void 0:r.symbolRanking.length)-1],U?t.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[t.jsx(G,{title:"Performance & P&L Analysis"}),t.jsx("div",{className:"pt-20 pb-20 px-4",children:t.jsxs("div",{className:"text-center py-12",children:[t.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),t.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:"Loading performance data..."})]})}),t.jsx(K,{})]}):T?t.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[t.jsx(G,{title:"Performance & P&L Analysis"}),t.jsx("div",{className:"pt-20 pb-20 px-4",children:t.jsxs(u,{className:"p-6 text-center",children:[t.jsx("i",{className:"ri-error-warning-line text-4xl text-red-500 mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"Error Loading Data"}),t.jsx("p",{className:"text-gray-600 dark:text-gray-400",children:T})]})}),t.jsx(K,{})]}):t.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[t.jsx(G,{title:"Performance & P&L Analysis"}),t.jsxs("div",{className:"pt-20 pb-20 px-4 space-y-6",children:[k.length>0&&t.jsxs(u,{className:"p-4",children:[t.jsx("label",{className:"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2",children:"Select Trading Pair"}),t.jsxs("select",{value:f,onChange:a=>C(a.target.value),className:"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 bg-white dark:bg-gray-800 text-gray-900 dark:text-white",children:[t.jsx("option",{value:"",children:"-- Select a Pair --"}),t.jsx("option",{value:"all",children:"Select All"}),k.map(a=>t.jsx("option",{value:a,children:a},a))]}),f&&t.jsx("p",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2",children:f==="all"?`Showing report for all pairs (${k.length} pairs)`:t.jsxs(t.Fragment,{children:["Showing report for ",t.jsx("span",{className:"font-semibold",children:f})]})})]}),f?t.jsx(X,{selectedPair:f==="all"?"":f,onReset:$}):k.length>0?t.jsxs(u,{className:"p-6 text-center",children:[t.jsx("i",{className:"ri-search-line text-4xl text-gray-300 dark:text-gray-600 mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"Select a Trading Pair"}),t.jsxs("p",{className:"text-gray-500 dark:text-gray-400",children:["Choose a pair from the dropdown above to view detailed performance report and open positions (",k.length," pairs available)."]})]}):t.jsx(X,{selectedPair:f,onReset:$}),t.jsxs(u,{className:"p-4",children:[t.jsx("div",{className:"flex space-x-2 mb-4",children:[{key:"all",label:"All Assets"},{key:"perpetuals",label:"Perpetuals & Futures"},{key:"spot",label:"Spot"}].map(({key:a,label:c})=>t.jsx("button",{onClick:()=>w(a),className:`px-4 py-2 rounded-lg text-sm font-medium transition-colors ${v===a?"bg-blue-600 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:c},a))}),t.jsx("div",{className:"flex space-x-2",children:[{key:"7d",label:"Last 7 D"},{key:"30d",label:"Last 30 D"},{key:"60d",label:"Last 60 D"},{key:"90d",label:"Last 90 D"},{key:"180d",label:"Last 180 D"}].map(({key:a,label:c})=>t.jsx("button",{onClick:()=>O(a),className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${N===a?"bg-blue-600 text-white":"bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-600"}`,children:c},a))})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsx(u,{className:"p-6",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:`text-3xl font-bold mb-2 ${((r==null?void 0:r.overview.totalPnL)||0)>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:P((r==null?void 0:r.overview.totalPnL)||0)}),t.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Total P&L"})]})}),t.jsx(u,{className:"p-6",children:t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"text-3xl font-bold text-blue-600 dark:text-blue-400 mb-2",children:["+",b((r==null?void 0:r.overview.tradingVolume)||0)]}),t.jsx("div",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Trading Volume"})]})})]}),p.length>0&&t.jsxs(u,{className:"p-6",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"P&L Chart"}),t.jsxs("div",{className:"relative h-64 bg-gray-50 dark:bg-gray-800 rounded-lg p-4",children:[t.jsxs("svg",{className:"w-full h-full",viewBox:`0 0 ${p.length*40} 200`,preserveAspectRatio:"none",children:[t.jsx("line",{x1:"0",y1:"100",x2:p.length*40,y2:"100",stroke:"currentColor",strokeWidth:"1",className:"text-gray-300 dark:text-gray-600"}),t.jsx("polyline",{points:p.map((a,c)=>{const g=c*40+20,m=100-a.pnl/I*80;return`${g},${m}`}).join(" "),fill:"none",stroke:(r==null?void 0:r.overview.totalPnL)>=0?"#10b981":"#ef4444",strokeWidth:"2",className:"dark:opacity-80"}),p.map((a,c)=>{const g=c*40+20,m=100-a.pnl/I*80,S=100-m;return t.jsx("rect",{x:g-15,y:m,width:"30",height:S,fill:a.pnl>=0?"rgba(16, 185, 129, 0.2)":"rgba(239, 68, 68, 0.2)",className:"dark:opacity-50"},c)})]}),t.jsxs("div",{className:"absolute bottom-2 left-0 right-0 flex justify-between px-4 text-xs text-gray-500 dark:text-gray-400",children:[t.jsx("span",{children:new Date((x=p[0])==null?void 0:x.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})}),p.length>1&&t.jsx("span",{children:new Date((R=p[Math.floor(p.length/2)])==null?void 0:R.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})}),p.length>2&&t.jsx("span",{children:new Date((E=p[p.length-1])==null?void 0:E.date).toLocaleDateString("en-US",{month:"short",day:"numeric"})})]})]}),t.jsxs("div",{className:"text-xs text-gray-500 dark:text-gray-400 mt-2 text-right",children:["Data as of ",F.end.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"})," (UTC)"]})]}),(r==null?void 0:r.symbolRanking)&&r.symbolRanking.length>0&&t.jsxs(u,{className:"p-6",children:[t.jsx("h3",{className:"text-lg font-semibold text-gray-900 dark:text-white mb-4",children:"P&L Ranking"}),t.jsx("div",{className:"space-y-3",children:r.symbolRanking.map((a,c)=>{const g=Math.min(...r.symbolRanking.map(H=>H.pnl)),m=Math.abs(a.pnl/g)*100,S=a.pnl>=0;return t.jsxs("div",{className:"space-y-1",children:[t.jsxs("div",{className:"flex items-center justify-between text-sm",children:[t.jsx("span",{className:"font-medium text-gray-900 dark:text-white",children:a.symbol}),t.jsx("span",{className:`font-medium ${S?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:P(a.pnl)})]}),t.jsx("div",{className:"relative h-2 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden",children:t.jsx("div",{className:`absolute left-0 top-0 h-full ${S?"bg-green-500 dark:bg-green-400":"bg-red-500 dark:bg-red-400"}`,style:{width:`${Math.min(m,100)}%`}})}),t.jsxs("div",{className:"flex items-center justify-between text-xs text-gray-500 dark:text-gray-400",children:[t.jsxs("span",{children:["Volume: ",P(a.volume)]}),t.jsxs("span",{children:["Trades: ",a.trades," | WR: ",a.winRate.toFixed(1),"%"]})]})]},a.symbol)})})]}),t.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[t.jsx(u,{className:"p-4",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-1",children:(r==null?void 0:r.overview.totalTrades)||0}),t.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Total Trades"})]})}),t.jsx(u,{className:"p-4",children:t.jsxs("div",{className:"text-center",children:[t.jsxs("div",{className:"text-2xl font-bold text-gray-900 dark:text-white mb-1",children:[(r==null?void 0:r.overview.winRate.toFixed(1))||"0.0","%"]}),t.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Win Rate"})]})}),t.jsx(u,{className:"p-4",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-2xl font-bold text-green-600 dark:text-green-400 mb-1",children:P((r==null?void 0:r.overview.avgWin)||0)}),t.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Avg Win"})]})}),t.jsx(u,{className:"p-4",children:t.jsxs("div",{className:"text-center",children:[t.jsx("div",{className:"text-2xl font-bold text-red-600 dark:text-red-400 mb-1",children:P((r==null?void 0:r.overview.avgLoss)||0)}),t.jsx("div",{className:"text-xs text-gray-500 dark:text-gray-400",children:"Avg Loss"})]})})]}),(!r||r.overview.totalTrades===0)&&t.jsxs(u,{className:"p-8 text-center",children:[t.jsx("i",{className:"ri-line-chart-line text-4xl text-gray-300 dark:text-gray-600 mb-4"}),t.jsx("h3",{className:"text-lg font-medium text-gray-900 dark:text-white mb-2",children:"No Performance Data"}),t.jsx("p",{className:"text-gray-500 dark:text-gray-400",children:"Start trading to see your performance metrics here."})]})]}),t.jsx(K,{})]})}export{ge as default};
//# sourceMappingURL=page-c044bbb4.js.map
