{"version":3,"file":"useAcademy-d0542efd.js","sources":["../../src/hooks/useAcademy.ts"],"sourcesContent":["import { useEffect, useMemo, useState } from 'react';\r\nimport { supabase } from '../lib/supabase';\r\nimport { useAuth } from './useAuth';\r\n\r\nexport type LessonType = 'video' | 'guide' | 'quiz';\r\n\r\nexport interface ModuleLesson {\r\n  id: string;\r\n  module_id: string;\r\n  title: string;\r\n  slug: string;\r\n  type: LessonType;\r\n  content_md: string | null;\r\n  media_url: string | null;\r\n  order_index: number;\r\n}\r\n\r\nexport interface CourseModule {\r\n  id: string;\r\n  title: string;\r\n  slug: string;\r\n  audience: string | null;\r\n  summary: string | null;\r\n  media_url: string | null;\r\n  duration_minutes: number | null;\r\n  order_index: number;\r\n  lessons: ModuleLesson[];\r\n}\r\n\r\nexport interface LessonProgress {\r\n  id: string;\r\n  lesson_id: string | null;\r\n  module_id: string;\r\n  status: 'not_started' | 'in_progress' | 'completed';\r\n  completed_at: string | null;\r\n  quiz_score?: number | null;\r\n}\r\n\r\nexport interface AcademySummary {\r\n  user_id: string;\r\n  modules_completed: number;\r\n  modules_available: number;\r\n  lessons_completed: number;\r\n  badge_foundation_finisher: boolean;\r\n  current_status: string | null;\r\n}\r\n\r\ninterface AcademyState {\r\n  modules: CourseModule[];\r\n  loading: boolean;\r\n  error: string | null;\r\n  lessonProgress: LessonProgress[];\r\n  summary: AcademySummary | null;\r\n  refresh: () => Promise<void>;\r\n  recordProgress: (moduleSlug: string, lessonSlug: string | null, status: LessonProgress['status'], quizScore?: number | null) => Promise<void>;\r\n}\r\n\r\nconst emptyState: AcademyState = {\r\n  modules: [],\r\n  loading: false,\r\n  error: null,\r\n  lessonProgress: [],\r\n  summary: null,\r\n  refresh: async () => {},\r\n  recordProgress: async () => {},\r\n};\r\n\r\nexport function useAcademy(): AcademyState {\r\n  const { user } = useAuth();\r\n  const [modules, setModules] = useState<CourseModule[]>([]);\r\n  const [lessonProgress, setLessonProgress] = useState<LessonProgress[]>([]);\r\n  const [summary, setSummary] = useState<AcademySummary | null>(null);\r\n  const [loading, setLoading] = useState<boolean>(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  const fetchModules = async () => {\r\n    const { data, error } = await supabase\r\n      .from('course_modules')\r\n      .select(\r\n        `\r\n          id,\r\n          title,\r\n          slug,\r\n          audience,\r\n          summary,\r\n          media_url,\r\n          duration_minutes,\r\n          order_index,\r\n          module_lessons (\r\n            id,\r\n            module_id,\r\n            title,\r\n            slug,\r\n            type,\r\n            content_md,\r\n            media_url,\r\n            order_index\r\n          )\r\n        `\r\n      )\r\n      .order('order_index', { ascending: true });\r\n\r\n    if (error) throw error;\r\n\r\n    const formatted: CourseModule[] =\r\n      (data || []).map((module) => ({\r\n        ...module,\r\n        lessons: (module.module_lessons || []).sort((a, b) => (a.order_index ?? 0) - (b.order_index ?? 0)),\r\n      })) ?? [];\r\n\r\n    setModules(formatted);\r\n  };\r\n\r\n  const fetchProgress = async () => {\r\n    if (!user) {\r\n      setLessonProgress([]);\r\n      setSummary(null);\r\n      return;\r\n    }\r\n\r\n    const [progressRes, summaryRes] = await Promise.all([\r\n      supabase\r\n        .from('user_course_progress')\r\n        .select('id, module_id, lesson_id, status, completed_at, quiz_score')\r\n        .eq('user_id', user.id),\r\n      supabase\r\n        .from('user_academy_summary')\r\n        .select('*')\r\n        .eq('user_id', user.id)\r\n        .maybeSingle(),\r\n    ]);\r\n\r\n    if (progressRes.error) throw progressRes.error;\r\n    if (summaryRes.error && summaryRes.error.code !== 'PGRST116') throw summaryRes.error;\r\n\r\n    setLessonProgress(progressRes.data || []);\r\n    setSummary(summaryRes.data || null);\r\n  };\r\n\r\n  const refresh = async () => {\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n      await Promise.all([fetchModules(), fetchProgress()]);\r\n    } catch (err: any) {\r\n      console.error('Failed to load academy data', err);\r\n      setError(err?.message || 'Failed to load academy content');\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  useEffect(() => {\r\n    refresh();\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n  }, [user?.id]);\r\n\r\n  const recordProgress = async (\r\n    moduleSlug: string,\r\n    lessonSlug: string | null,\r\n    status: LessonProgress['status'],\r\n    quizScore?: number | null\r\n  ) => {\r\n    await supabase.rpc('record_lesson_progress', {\r\n      p_module_slug: moduleSlug,\r\n      p_lesson_slug: lessonSlug,\r\n      p_status: status,\r\n      p_quiz_score: quizScore ?? null,\r\n    });\r\n    await fetchProgress();\r\n  };\r\n\r\n  return useMemo(\r\n    () => ({\r\n      modules,\r\n      lessonProgress,\r\n      summary,\r\n      loading,\r\n      error,\r\n      refresh,\r\n      recordProgress,\r\n    }),\r\n    // eslint-disable-next-line react-hooks/exhaustive-deps\r\n    [modules, lessonProgress, summary, loading, error]\r\n  );\r\n}\r\n\r\nexport function getLessonStatus(\r\n  progress: LessonProgress[],\r\n  moduleId: string,\r\n  lessonId?: string | null\r\n): LessonProgress['status'] {\r\n  if (!progress.length) return 'not_started';\r\n  const match = progress.find((entry) => entry.module_id === moduleId && (lessonId ? entry.lesson_id === lessonId : entry.lesson_id === null));\r\n  return match?.status ?? 'not_started';\r\n}\r\n\r\nexport function isModuleCompleted(module: CourseModule, progress: LessonProgress[]): boolean {\r\n  if (!module.lessons.length) return false;\r\n  return module.lessons.every((lesson) => {\r\n    const entry = progress.find((p) => p.lesson_id === lesson.id);\r\n    return entry?.status === 'completed';\r\n  });\r\n}\r\n"],"names":["useAcademy","user","useAuth","modules","setModules","useState","lessonProgress","setLessonProgress","summary","setSummary","loading","setLoading","error","setError","fetchModules","data","supabase","formatted","module","a","b","fetchProgress","progressRes","summaryRes","refresh","err","useEffect","recordProgress","moduleSlug","lessonSlug","status","quizScore","useMemo","getLessonStatus","progress","moduleId","lessonId","match","entry","isModuleCompleted","lesson","p"],"mappings":"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"}