import{r as d,u as k,h as A,s as $}from"./index-b0fe075c.js";const U=()=>{const[p,i]=d.useState([]),[T,l]=d.useState(!0),[m,g]=d.useState(null),{user:u,loading:h}=k(),c=async()=>{let s=await A();if(!s)try{const{data:{session:t}}=await $.auth.getSession();s=(t==null?void 0:t.access_token)??null}catch(t){console.warn("useBots: getSession fallback failed",t)}if(!s)throw new Error("No active session");return s},w=async()=>{try{console.log("useBots: Fetching bots"),l(!0),g(null);const s=await c(),t=await fetch(`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/bot-management`,{method:"GET",headers:{Authorization:`Bearer ${s}`}});if(!t.ok){const o=await t.text();throw console.error("Bot fetch error:",t.status,o),new Error(`Failed to fetch bots: ${t.status}`)}const e=await t.json();i(Array.isArray(e.bots)?e.bots:[])}catch(s){console.error("Error fetching bots:",s),g(s instanceof Error?s.message:"Failed to fetch bots"),i([])}finally{l(!1)}},b=async s=>{try{const t=await c();console.log("useBots: About to send bot data:",s),console.log("useBots: Exchange value:",s.exchange,"Type:",typeof s.exchange);const e=await fetch(`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/bot-management?action=create`,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify(s)});if(console.log("useBots: Response status:",e.status),!e.ok){const r=await e.text();throw console.error("Bot creation error:",e.status,r),new Error(`Failed to create bot: ${e.status}`)}const o=await e.json();if(o.bot)return i(r=>[o.bot,...r]),o.bot;throw new Error("No bot data returned")}catch(t){throw console.error("Error creating bot:",t),t}},E=async s=>{try{const t=await c(),e=`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/bot-management?action=start`;console.log("ðŸš€ Starting bot:",{botId:s,url:e,origin:window.location.origin});const o=await fetch(e,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({id:s})});if(console.log("ðŸ“¡ Response status:",o.status,o.statusText),!o.ok){const a=await o.text();throw console.error("âŒ Bot start error:",{status:o.status,statusText:o.statusText,errorText:a,headers:Object.fromEntries(o.headers.entries())}),o.status===0||a.includes("CORS")||a.includes("cors")?new Error("CORS error: Failed to connect to server. This might be a domain configuration issue."):new Error(`Failed to start bot: ${o.status} - ${a||o.statusText}`)}const r=await o.json();if(console.log("âœ… Bot started successfully:",r),r.bot)return i(a=>a.map(n=>n.id===s?r.bot:n)),r.bot;throw new Error("No bot data returned")}catch(t){throw console.error("âŒ Error starting bot:",{error:t,message:t==null?void 0:t.message,name:t==null?void 0:t.name,stack:t==null?void 0:t.stack}),t}},B=async s=>{try{const t=await c(),e=`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/bot-management?action=stop`;console.log("ðŸ›‘ Stopping bot:",{botId:s,url:e,origin:window.location.origin});const o=await fetch(e,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({id:s})});if(console.log("ðŸ“¡ Response status:",o.status,o.statusText),!o.ok){const a=await o.text();throw console.error("âŒ Bot stop error:",{status:o.status,statusText:o.statusText,errorText:a,headers:Object.fromEntries(o.headers.entries())}),o.status===0||a.includes("CORS")||a.includes("cors")?new Error("CORS error: Failed to connect to server. This might be a domain configuration issue."):new Error(`Failed to stop bot: ${o.status} - ${a||o.statusText}`)}const r=await o.json();if(console.log("âœ… Bot stopped successfully:",r),r.bot)return i(a=>a.map(n=>n.id===s?r.bot:n)),r.bot;throw new Error("No bot data returned")}catch(t){throw console.error("âŒ Error stopping bot:",{error:t,message:t==null?void 0:t.message,name:t==null?void 0:t.name,stack:t==null?void 0:t.stack}),t}},y=async s=>{try{const t=await c(),e=`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/bot-management?action=pause`;console.log("â¸ï¸ Pausing bot:",{botId:s,url:e,origin:window.location.origin});const o=await fetch(e,{method:"POST",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({id:s})});if(console.log("ðŸ“¡ Response status:",o.status,o.statusText),!o.ok){const a=await o.text();throw console.error("âŒ Bot pause error:",{status:o.status,statusText:o.statusText,errorText:a,headers:Object.fromEntries(o.headers.entries())}),o.status===0||a.includes("CORS")||a.includes("cors")?new Error("CORS error: Failed to connect to server. This might be a domain configuration issue."):new Error(`Failed to pause bot: ${o.status} - ${a||o.statusText}`)}const r=await o.json();if(console.log("âœ… Bot paused successfully:",r),r.bot)return i(a=>a.map(n=>n.id===s?r.bot:n)),r.bot;throw new Error("No bot data returned")}catch(t){throw console.error("âŒ Error pausing bot:",{error:t,message:t==null?void 0:t.message,name:t==null?void 0:t.name,stack:t==null?void 0:t.stack}),t}},S=async(s,t)=>{try{const e=await c(),o=`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/bot-management?action=update`;console.log("ðŸ“ Updating bot:",{botId:s,url:o,origin:window.location.origin,updates:t});const r=await fetch(o,{method:"POST",headers:{Authorization:`Bearer ${e}`,"Content-Type":"application/json"},body:JSON.stringify({id:s,...t})});if(console.log("ðŸ“¡ Response status:",r.status,r.statusText),!r.ok){const n=await r.text();throw console.error("âŒ Bot update error:",{status:r.status,statusText:r.statusText,errorText:n,headers:Object.fromEntries(r.headers.entries())}),r.status===0||n.includes("CORS")||n.includes("cors")?new Error("CORS error: Failed to connect to server. This might be a domain configuration issue."):new Error(`Failed to update bot: ${r.status} - ${n||r.statusText}`)}const a=await r.json();if(console.log("âœ… Bot updated successfully:",a),a.bot)return i(n=>n.map(f=>f.id===s?a.bot:f)),a.bot;throw new Error("No bot data returned")}catch(e){throw console.error("âŒ Error updating bot:",{error:e,message:e==null?void 0:e.message,name:e==null?void 0:e.name,stack:e==null?void 0:e.stack}),e}},x=async s=>{try{const t=await c(),e=await fetch(`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/bot-management`,{method:"DELETE",headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"},body:JSON.stringify({id:s})});if(!e.ok){const o=await e.text();throw console.error("Bot deletion error:",e.status,o),new Error(`Failed to delete bot: ${e.status}`)}i(o=>o.filter(r=>r.id!==s))}catch(t){throw console.error("Error deleting bot:",t),t}};return d.useEffect(()=>{if(console.log("useBots: authLoading:",h),console.log("useBots: user:",u),h){l(!0);return}if(!u){i([]),l(!1);return}w()},[h,u==null?void 0:u.id]),{bots:p,loading:T,error:m,fetchBots:w,createBot:b,startBot:E,stopBot:B,pauseBot:y,updateBot:S,deleteBot:x}};export{U as u};
