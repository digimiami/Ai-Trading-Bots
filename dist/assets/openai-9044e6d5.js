import{_ as A}from"./index-b0fe075c.js";class I{constructor(){this.baseUrl="https://api.openai.com/v1",this.deepseekBaseUrl="https://api.deepseek.com/v1",this.useDeepSeek=!1,this.aiKeysStatus=null,this.aiKeysCheckPromise=null,this.apiKey={}.VITE_OPENAI_API_KEY||localStorage.getItem("ai_openai_api_key")||"",this.deepseekApiKey={}.VITE_DEEPSEEK_API_KEY||localStorage.getItem("ai_deepseek_api_key")||"";const e=localStorage.getItem("ai_provider_preference");e==="openai"||e==="deepseek"?this.useDeepSeek=e==="deepseek":this.useDeepSeek=!!this.deepseekApiKey}setOpenAIKey(e){this.apiKey=e,e?(localStorage.setItem("ai_openai_api_key",e),console.log("‚úÖ OpenAI API key saved")):(localStorage.removeItem("ai_openai_api_key"),console.log("‚úÖ OpenAI API key removed"))}setDeepSeekKey(e){this.deepseekApiKey=e,e?(localStorage.setItem("ai_deepseek_api_key",e),console.log("‚úÖ DeepSeek API key saved")):(localStorage.removeItem("ai_deepseek_api_key"),console.log("‚úÖ DeepSeek API key removed"))}getApiKeys(){return{openai:this.apiKey?`${this.apiKey.substring(0,7)}...${this.apiKey.substring(this.apiKey.length-4)}`:"",deepseek:this.deepseekApiKey?`${this.deepseekApiKey.substring(0,7)}...${this.deepseekApiKey.substring(this.deepseekApiKey.length-4)}`:""}}setProvider(e){const o=this.isProviderAvailable(e);o||console.warn(`${e==="deepseek"?"DeepSeek":"OpenAI"} API key not configured`),this.useDeepSeek=e==="deepseek",localStorage.setItem("ai_provider_preference",e),console.log(`‚úÖ AI Provider set to: ${e}${o?"":" (key not configured, may not work)"}`)}getProvider(){return this.useDeepSeek?"deepseek":"openai"}refreshKeys(){const e=localStorage.getItem("ai_openai_api_key"),o=localStorage.getItem("ai_deepseek_api_key");e?(this.apiKey=e,console.log("‚úÖ OpenAI key refreshed from localStorage")):{}.VITE_OPENAI_API_KEY?(this.apiKey={}.VITE_OPENAI_API_KEY,console.log("‚úÖ OpenAI key loaded from env var")):this.apiKey="",o?(this.deepseekApiKey=o,console.log("‚úÖ DeepSeek key refreshed from localStorage")):{}.VITE_DEEPSEEK_API_KEY?(this.deepseekApiKey={}.VITE_DEEPSEEK_API_KEY,console.log("‚úÖ DeepSeek key loaded from env var")):this.deepseekApiKey="",console.log("üîÑ AI API keys refreshed:",{openai:!!this.apiKey,deepseek:!!this.deepseekApiKey})}async checkKeysFromEdgeFunction(){return this.aiKeysStatus!==null?this.aiKeysStatus:this.aiKeysCheckPromise?(await this.aiKeysCheckPromise,this.aiKeysStatus||{openai:!1,deepseek:!1}):(this.aiKeysCheckPromise=(async()=>{var e,o;try{const{supabase:n}=await A(()=>import("./index-b0fe075c.js").then(r=>r.i),["assets/index-b0fe075c.js","assets/index-78fa8516.css"]),{data:t,error:a}=await n.functions.invoke("check-ai-keys",{method:"GET"});if(a){console.error("‚ö†Ô∏è Failed to check AI keys from Edge Function:",a),this.aiKeysStatus={openai:!1,deepseek:!1};return}t?(this.aiKeysStatus={openai:((e=t.openai)==null?void 0:e.available)||!1,deepseek:((o=t.deepseek)==null?void 0:o.available)||!1},console.log("‚úÖ AI keys status from Edge Function:",this.aiKeysStatus),t.debug&&(console.log("üîç Debug info from Edge Function:",t.debug),console.log(`   DeepSeek key present: ${t.debug.deepseekKeyPresent}, length: ${t.debug.deepseekKeyLength}`),console.log(`   OpenAI key present: ${t.debug.openaiKeyPresent}, length: ${t.debug.openaiKeyLength}`))):(console.warn("‚ö†Ô∏è No data returned from Edge Function"),this.aiKeysStatus={openai:!1,deepseek:!1})}catch(n){console.error("‚ùå Error checking AI keys from Edge Function:",n),this.aiKeysStatus={openai:!1,deepseek:!1}}finally{this.aiKeysCheckPromise=null}})(),await this.aiKeysCheckPromise,this.aiKeysStatus||{openai:!1,deepseek:!1})}async isProviderAvailableAsync(e){const o=await this.checkKeysFromEdgeFunction();if(e==="deepseek"&&o.deepseek||e==="openai"&&o.openai)return!0;let n="";return e==="deepseek"?(n=localStorage.getItem("ai_deepseek_api_key")||{}.VITE_DEEPSEEK_API_KEY||"",n&&n!==this.deepseekApiKey&&(this.deepseekApiKey=n)):(n=localStorage.getItem("ai_openai_api_key")||{}.VITE_OPENAI_API_KEY||"",n&&n!==this.apiKey&&(this.apiKey=n)),!!n||(e==="deepseek"?!!this.deepseekApiKey:!!this.apiKey)}isProviderAvailable(e){if(this.aiKeysStatus&&(e==="deepseek"&&this.aiKeysStatus.deepseek||e==="openai"&&this.aiKeysStatus.openai))return!0;let o="";return e==="deepseek"?(o=localStorage.getItem("ai_deepseek_api_key")||{}.VITE_DEEPSEEK_API_KEY||"",o&&o!==this.deepseekApiKey&&(this.deepseekApiKey=o)):(o=localStorage.getItem("ai_openai_api_key")||{}.VITE_OPENAI_API_KEY||"",o&&o!==this.apiKey&&(this.apiKey=o)),!!o||(e==="deepseek"?!!this.deepseekApiKey:!!this.apiKey)}async analyzeBotPerformance(e,o){if(!this.getAIConfig().apiKey)return console.warn("AI API key not configured (neither DeepSeek nor OpenAI)"),this.getDefaultRecommendation();try{const t=this.buildAnalysisPrompt(e,o),a=await this.callOpenAI(t);return this.parseAIResponse(a)}catch(t){return console.error("Error analyzing bot performance:",t),this.getDefaultRecommendation()}}async predictTradeSignal(e,o,n){if(!this.getAIConfig().apiKey)return{signal:"hold",confidence:.5,reasoning:"AI not configured"};try{const a=this.buildPredictionPrompt(e,o,n),r=await this.callOpenAI(a);return this.parsePredictionResponse(r)}catch(a){return console.error("Error predicting trade signal:",a),{signal:"hold",confidence:.5,reasoning:"Prediction failed"}}}async optimizeStrategy(e,o,n){if(!this.getAIConfig().apiKey)return{strategy:e.strategy,advancedConfig:e.advancedConfig,reasoning:"AI optimization not available - configure DeepSeek API key or OpenAI API key",expectedImprovement:"N/A",confidence:0};try{const a=JSON.stringify(e.strategy||{}).length,r=e.advancedConfig?JSON.stringify(e.advancedConfig).length:0,i=JSON.stringify(o||[]).length;console.log(`üìä [OpenAI] Input sizes: strategy=${Math.round(a/1024)}KB, advanced=${Math.round(r/1024)}KB, trades=${Math.round(i/1024)}KB, total=${Math.round((a+r+i)/1024)}KB`),(a>5e4||r>5e4||i>5e4)&&console.warn(`‚ö†Ô∏è [OpenAI] Large input detected! Strategy: ${Math.round(a/1024)}KB, Advanced: ${Math.round(r/1024)}KB, Trades: ${Math.round(i/1024)}KB`);const c=this.buildOptimizationPrompt(e,o,n);console.log(`üìä [OpenAI] Final prompt size: ${Math.round(c.length/1024)}KB (${Math.round(c.length*.75/1e3)}K tokens estimated)`);const g=await this.callOpenAI(c);return this.parseOptimizationResponse(g,e)}catch(a){return console.error("Error optimizing strategy:",a),{strategy:e.strategy,advancedConfig:e.advancedConfig,reasoning:"Optimization failed",expectedImprovement:"Unknown",confidence:0}}}buildAnalysisPrompt(e,o){return`
You are an advanced trading bot AI advisor. Analyze the following bot performance and provide recommendations.

Bot Performance Data:
- Total Trades: ${o.totalTrades}
- Win Rate: ${o.winRate}%
- Total PnL: $${o.totalPnL}
- Sharpe Ratio: ${o.sharpeRatio}
- Best Pair: ${o.bestPerformingPair}
- Worst Pair: ${o.worstPerformingPair}
- Max Drawdown: ${o.maxDrawdown}%

Recent Trades Summary:
${o.recentTrades.slice(-10).map(n=>`- ${n.symbol}: ${n.outcome} (PnL: $${n.pnl.toFixed(2)})`).join(`
`)}

Provide a JSON response with:
{
  "recommended": boolean,
  "confidence": number (0-1),
  "reasoning": "Detailed explanation",
  "suggestedParameters": {
    "rsiThreshold": number,
    "adxThreshold": number,
    "stopLoss": number,
    "takeProfit": number,
    "leverage": number
  },
  "expectedImprovement": "Expected performance improvement",
  "riskAssessment": "Risk level assessment"
}
`.trim()}buildPredictionPrompt(e,o,n){return`
Analyze market data for ${e} and provide a trading recommendation.

Current Market Data:
- RSI: ${o.rsi}
- ADX: ${o.adx}
- BB Width: ${o.bbWidth}
- Volume: ${o.volume}

Recent Trade History (this bot):
${n.slice(-5).map(t=>`- ${t.symbol}: ${t.outcome}, PnL: $${t.pnl.toFixed(2)}`).join(`
`)}

Provide a JSON response with:
{
  "signal": "buy|sell|hold",
  "confidence": number (0-1),
  "reasoning": "Why this signal"
}
`.trim()}buildOptimizationPrompt(e,o,n){let t=0,a=0;try{t=JSON.stringify(e.strategy||{}).length,a=e.advancedConfig?JSON.stringify(e.advancedConfig).length:0}catch(p){return console.error("Error stringifying strategies:",p),this.buildMinimalPrompt(e,n,o)}if(t+a>5e4)return console.warn(`‚ö†Ô∏è Input strategies too large (${Math.round((t+a)/1024)}KB). Using minimal format.`),this.buildMinimalPrompt(e,n,o);const r={rsi:e.strategy.rsiThreshold,adx:e.strategy.adxThreshold,bbw:e.strategy.bbWidthThreshold,ema:e.strategy.emaSlope,atr:e.strategy.atrPercentage,vwap:e.strategy.vwapDistance,mom:e.strategy.momentumThreshold,ml:e.strategy.useMLPrediction},i=e.advancedConfig?{bias:e.advancedConfig.bias_mode,risk:e.advancedConfig.risk_per_trade_pct,adxHtf:e.advancedConfig.adx_min_htf,regime:e.advancedConfig.regime_mode,sl:e.advancedConfig.sl_atr_mult,tp1:e.advancedConfig.tp1_r,tp2:e.advancedConfig.tp2_r}:null,c=`rsi:${r.rsi},adx:${r.adx},bbw:${r.bbw},ema:${r.ema},atr:${r.atr},vwap:${r.vwap},mom:${r.mom},ml:${r.ml}`,g=i?`bias:${i.bias},risk:${i.risk},adxHtf:${i.adxHtf},regime:${i.regime},sl:${i.sl},tp1:${i.tp1},tp2:${i.tp2}`:"",d=(n==null?void 0:n.winRate)??0,s=(n==null?void 0:n.totalPnL)??0,h=(n==null?void 0:n.profitFactor)??0,u=(n==null?void 0:n.sharpeRatio)??0,l=(n==null?void 0:n.maxDrawdown)??0;return`
Optimize trading strategy.

CURRENT:
S:${c}
${g?`A:${g}`:""}

PERF:
WR:${Math.round(d)}% PnL:$${Math.round(s)} PF:${h.toFixed(2)} SR:${u.toFixed(2)} DD:${Math.round(l)}%

TRADES (last 3):
${o.slice(-3).map(p=>{const m=(p.symbol||"X").substring(0,3),y=p.side?p.side[0]:"?",f=(p.outcome||"u")[0],k=Math.round(p.pnl||0);return`${m}${y}:${f}$${k}`}).join(" ")}

Return JSON:
{
  "strategy": {"rsiThreshold":num,"adxThreshold":num,"bbWidthThreshold":num,"emaSlope":num,"atrPercentage":num,"vwapDistance":num,"momentumThreshold":num,"useMLPrediction":bool,"minSamplesForML":num},
  ${i?'"advancedConfig": {"bias_mode":"str","risk_per_trade_pct":num,"adx_min_htf":num,"regime_mode":"str","sl_atr_mult":num,"tp1_r":num,"tp2_r":num},':""}
  "reasoning": "brief",
  "expectedImprovement": "brief",
  "confidence": num
}
`.trim()}buildMinimalPrompt(e,o,n){let t=0,a=0;try{let s=e.strategy;if(typeof s=="string")try{s=JSON.parse(s),typeof s=="string"&&(s=JSON.parse(s))}catch(h){console.warn("Could not parse strategy string:",h)}t=(s==null?void 0:s.rsiThreshold)||(s==null?void 0:s.rsi)||0,a=(s==null?void 0:s.adxThreshold)||(s==null?void 0:s.adx)||0}catch(s){console.warn("Error extracting strategy values:",s)}const r=Math.round((o==null?void 0:o.winRate)||0),i=Math.round((o==null?void 0:o.totalPnL)||0),c=parseFloat(((o==null?void 0:o.profitFactor)||0).toFixed(1)),g=n.slice(-2).map(s=>{const h=(s.symbol||"X").substring(0,2),u=(s.outcome||"u")[0],l=Math.round(s.pnl||0);return`${h}${u}$${l}`}).join(","),d=`Opt: rsi:${t},adx:${a} WR:${r}% PnL:$${i} PF:${c} Trades:${g}. Return JSON: strategy params, reasoning, confidence.`;return console.log(`üìä [Minimal Prompt] Size: ${Math.round(d.length/1024)}KB, Content: ${d.substring(0,200)}...`),d}getAIConfig(){return this.useDeepSeek&&this.deepseekApiKey?(console.log(`üîë [getAIConfig] Using DeepSeek API key (length: ${this.deepseekApiKey.length})`),{apiKey:this.deepseekApiKey,baseUrl:this.deepseekBaseUrl,model:"deepseek-chat",provider:"DeepSeek"}):(this.apiKey?console.log(`üîë [getAIConfig] Using OpenAI API key (length: ${this.apiKey.length})`):(console.error("‚ùå [getAIConfig] OpenAI API key is missing! Keys must be stored in localStorage or env vars for client-side API calls."),console.log("üí° Tip: Edge Function secrets are server-side only. For client-side recommendations, add your API keys in Settings ‚Üí AI Recommendations.")),{apiKey:this.apiKey,baseUrl:this.baseUrl,model:"gpt-4o",provider:"OpenAI"})}async callOpenAI(e,o=!0){var s,h,u;const n=Math.ceil(e.length*.75);if(n>5e4&&(console.warn(`‚ö†Ô∏è Large prompt detected (~${Math.round(n/1e3)}K tokens). Prompt size: ${Math.round(e.length/1024)}KB`),n>1e5)){console.error(`‚ùå Prompt too large (${Math.round(n/1e3)}K tokens). Truncating...`);const l=e.split("ADVANCED");l.length>1?e=l[0]+"PERFORMANCE: [metrics summary only]":e=e.substring(0,5e4)}const t=this.getAIConfig(),a={model:t.model,messages:[{role:"system",content:"You are a professional trading analyst. Provide data-driven recommendations. Always respond with valid JSON only."},{role:"user",content:e}],temperature:.3,max_tokens:1e3};if(o&&(a.response_format={type:"json_object"}),console.log(`ü§ñ Using ${t.provider} API (${t.model}) for optimization`),console.log(`üåê [API Call] Making request to ${t.baseUrl}/chat/completions`),console.log(`üîë [API Call] API key present: ${!!t.apiKey} (length: ${((s=t.apiKey)==null?void 0:s.length)||0})`),!t.apiKey){const l=`‚ùå ${t.provider} API key is missing! Cannot make API call.`;throw console.error(l),console.error("üí° Note: API keys stored in Edge Function secrets are server-side only."),console.error("üí° For client-side recommendations, you must add API keys in Settings ‚Üí AI Recommendations."),new Error(l)}const r=Date.now(),i=await fetch(`${t.baseUrl}/chat/completions`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${t.apiKey}`},body:JSON.stringify(a)}),c=Date.now()-r;if(console.log(`‚è±Ô∏è [API Call] Response received in ${c}ms, status: ${i.status}`),!i.ok){const l=await i.text();throw console.error(`‚ùå ${t.provider} API error:`,i.status,l),new Error(`${t.provider} API error: ${i.status}`)}console.log(`‚úÖ [API Call] ${t.provider} API call successful!`);const g=await i.json(),d=(u=(h=g.choices[0])==null?void 0:h.message)==null?void 0:u.content;if(console.log(`üì¶ [API Call] Response parsed, content length: ${(d==null?void 0:d.length)||0} chars`),!d)throw console.error(`‚ùå [API Call] No content in ${t.provider} response:`,g),new Error("No content in OpenAI response");try{const l=JSON.parse(d);return console.log(`‚úÖ [API Call] Successfully parsed JSON response from ${t.provider}`),l}catch{console.warn("‚ö†Ô∏è [API Call] JSON parse error, attempting to extract JSON from content");const p=d.match(/```json\s*(\{.*\})\s*```/s)||d.match(/(\{.*\})/s);if(p)return JSON.parse(p[1]);throw new Error("Failed to parse OpenAI response as JSON")}}parseAIResponse(e){return{recommended:e.recommended||!1,confidence:e.confidence||.5,reasoning:e.reasoning||"No analysis available",suggestedParameters:e.suggestedParameters||{},expectedImprovement:e.expectedImprovement||"Unknown",riskAssessment:e.riskAssessment||"Unknown"}}parsePredictionResponse(e){return{signal:e.signal||"hold",confidence:e.confidence||.5,reasoning:e.reasoning||"No prediction available"}}parseOptimizationResponse(e,o){const n={...o.strategy,...e.strategy||e.suggestedParameters||{}};let t;return(o.advancedConfig||e.advancedConfig)&&(t={...o.advancedConfig,...e.advancedConfig||{}}),{strategy:n,advancedConfig:t,reasoning:e.reasoning||"AI-generated optimization",expectedImprovement:e.expectedImprovement||"Performance improvement expected",confidence:e.confidence||.7}}getDefaultRecommendation(){return{recommended:!1,confidence:.5,reasoning:"AI analysis not available. Configure OpenAI API key to enable self-learning features.",suggestedParameters:{},expectedImprovement:"N/A",riskAssessment:"Unable to assess without AI"}}}const K=new I;export{K as o};
