import{r as o,a as z,u as D,j as e,s as v}from"./index-617375de.js";import{B}from"./Button-0907088e.js";import{C as V}from"./Card-015d7526.js";function H(){const[l,S]=o.useState(!0),[g,b]=o.useState(""),[h,A]=o.useState(""),[c,C]=o.useState(""),[p,d]=o.useState(!1),[y,r]=o.useState(null),[s,w]=o.useState(null),[R,P]=o.useState(!1),I=z(),{user:k,loading:j,signIn:$,signUp:O}=D();if(o.useEffect(()=>{!j&&k&&I("/dashboard")},[k,j,I]),o.useEffect(()=>{const t=new URLSearchParams(window.location.search).get("invite");t&&(C(t),S(!1),E(t))},[]),j)return e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center",children:e.jsx(V,{title:"Loading...",children:e.jsx("div",{className:"text-center",children:e.jsx("p",{className:"text-gray-600",children:"Checking authentication..."})})})});const E=async i=>{try{const{data:{session:t}}=await v.auth.getSession(),u={}.VITE_PUBLIC_SUPABASE_URL,m=await(await fetch(`${u}/functions/v1/invitation-management?action=validate`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(t==null?void 0:t.access_token)||""}`},body:JSON.stringify({code:i})})).json();w(m.valid),m.valid&&m.invitation.email&&b(m.invitation.email)}catch{w(!1)}},q=async()=>{d(!0),r(null);try{const i={}.VITE_PUBLIC_SUPABASE_URL,u=await(await fetch(`${i}/functions/v1/fix-auth-final`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({email:"digimiami@gmail.com",password:"lagina123"})})).json();u.success?(r(null),alert("Admin account fixed! You can now login with: digimiami@gmail.com / lagina123"),b("digimiami@gmail.com"),A("lagina123"),P(!1)):r(u.error||"Failed to fix admin account")}catch{r("Failed to fix admin account")}finally{d(!1)}},J=async i=>{var t,u,N,m,U,F,L;i.preventDefault(),d(!0),r(null);try{let a;if(l){if(a=await $(g,h),!a.error&&((t=a.data)!=null&&t.user)){await new Promise(f=>setTimeout(f,500));const{data:{session:n}}=await v.auth.getSession();if(n!=null&&n.user)return}}else{if(!c||!c.trim()){r("Invitation code is required to create an account. Please contact an admin for an invitation code."),d(!1);return}if(s===!1){r("Invalid or expired invitation code. Please check your invitation code and try again."),d(!1);return}if(s===null&&(await new Promise(n=>setTimeout(n,500)),s===!1)){r("Invalid or expired invitation code. Please check your invitation code and try again."),d(!1);return}if(a=await O(g,h),!a.error&&((u=a.data)!=null&&u.user)&&c)try{let n=((N=a.data)==null?void 0:N.session)||null;if(!n){const x=await v.auth.signInWithPassword({email:g,password:h});x.error?console.warn("Auto sign-in after signup failed:",x.error):n=((m=x.data)==null?void 0:m.session)||null}const{data:{session:f}}=await v.auth.getSession(),T=(f==null?void 0:f.access_token)||(n==null?void 0:n.access_token);if(T){const x={}.VITE_PUBLIC_SUPABASE_URL,_=await fetch(`${x}/functions/v1/invitation-management?action=use`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${T}`},body:JSON.stringify({code:c,userId:(F=(U=a.data)==null?void 0:U.user)==null?void 0:F.id})});_.ok||console.error("Failed to mark invitation as used:",await _.text())}else console.warn("No access token available to mark invitation as used.")}catch(n){console.error("Failed to mark invitation as used:",n)}}a.error?(r(a.error.message||"Authentication failed"),d(!1)):l&&((L=a.data)!=null&&L.user)||d(!1)}catch(a){console.error("Auth error:",a),r(a instanceof Error?a.message:"An unexpected error occurred"),d(!1)}};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center p-4",children:e.jsxs(V,{className:"w-full max-w-md p-8",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900 mb-2",children:l?"Welcome Back":"Create Account"}),e.jsx("p",{className:"text-gray-600",children:l?"Sign in to your trading account":"Start your trading journey"}),c&&e.jsx("div",{className:`mt-3 p-2 rounded-lg text-sm ${s===!0?"bg-green-50 text-green-700":s===!1?"bg-red-50 text-red-700":"bg-yellow-50 text-yellow-700"}`,children:s===!0?"✓ Valid invitation code":s===!1?"✗ Invalid or expired invitation":"Validating invitation..."})]}),e.jsxs("form",{onSubmit:J,className:"space-y-6",children:[!l&&e.jsxs("div",{children:[e.jsxs("label",{htmlFor:"inviteCode",className:"block text-sm font-medium text-gray-700 mb-2",children:["Invitation Code ",e.jsx("span",{className:"text-red-500",children:"*"})]}),e.jsx("input",{id:"inviteCode",type:"text",value:c,onChange:async i=>{const t=i.target.value;C(t),t.trim()?await E(t):w(null)},className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter admin invitation code",required:!0}),c&&e.jsx("div",{className:`mt-2 text-xs ${s===!0?"text-green-600":s===!1?"text-red-600":"text-gray-500"}`,children:s===!0?"✓ Valid invitation code":s===!1?"✗ Invalid or expired invitation code":"Validating..."}),e.jsx("p",{className:"mt-1 text-xs text-gray-500",children:"An invitation code from an admin is required to create an account."})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"email",className:"block text-sm font-medium text-gray-700 mb-2",children:"Email Address"}),e.jsx("input",{id:"email",type:"email",value:g,onChange:i=>b(i.target.value),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter your email",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"password",className:"block text-sm font-medium text-gray-700 mb-2",children:"Password"}),e.jsx("input",{id:"password",type:"password",value:h,onChange:i=>A(i.target.value),className:"w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",placeholder:"Enter your password",required:!0})]}),y&&e.jsxs("div",{className:"bg-red-50 border border-red-200 rounded-lg p-3",children:[e.jsx("p",{className:"text-red-600 text-sm",children:y}),y.includes("Invalid login credentials")&&e.jsx("button",{type:"button",onClick:()=>P(!0),className:"mt-2 text-blue-600 hover:text-blue-700 text-sm underline",children:"Fix Admin Account"})]}),R&&e.jsxs("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-4",children:[e.jsx("p",{className:"text-yellow-800 text-sm mb-3",children:"Click below to fix the admin account authentication:"}),e.jsx(B,{type:"button",onClick:q,disabled:p,className:"w-full bg-yellow-600 hover:bg-yellow-700",children:p?"Fixing...":"Fix Admin Account"})]}),e.jsx(B,{type:"submit",className:"w-full",disabled:!!(p||!l&&(!c||c.trim()===""||s===!1)),children:p?"Processing...":l?"Sign In":"Create Account"})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsx("button",{onClick:()=>S(!l),className:"text-blue-600 hover:text-blue-700 text-sm font-medium",children:l?"Don't have an account? Sign up":"Already have an account? Sign in"})})]})})}export{H as default};
