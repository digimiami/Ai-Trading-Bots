import{a as B,r as o,s as L,j as e}from"./index-2e73d2fc.js";import{H as O}from"./Header-0462d24a.js";import{C as U}from"./Card-78cb4995.js";import{B as x}from"./Button-5c616256.js";import{u as I}from"./useBots-603bab49.js";const A=()=>{var n;try{const c=new Uint8Array(18);if((n=window==null?void 0:window.crypto)!=null&&n.getRandomValues)return window.crypto.getRandomValues(c),Array.from(c,r=>r.toString(16).padStart(2,"0")).join("")}catch(c){console.warn("Falling back to Math.random for webhook secret generation:",c)}return Math.random().toString(36).slice(2,12)+Math.random().toString(36).slice(2,12)};function V(){B();const{bots:n,updateBot:c}=I(),[r,j]=o.useState(""),[d,w]=o.useState(""),[l,k]=o.useState(""),[h,b]=o.useState(""),[i,g]=o.useState(null),[C,N]=o.useState(!1),[S,p]=o.useState([]),[v,T]=o.useState(!1),[u,E]=o.useState(!1);o.useEffect(()=>{n.length>0&&!r&&j(n[0].id)},[n,r]),o.useEffect(()=>{if(r){const t=n.find(s=>s.id===r);if(t){const s={}.VITE_PUBLIC_SUPABASE_URL||{}.VITE_SUPABASE_URL||"";s?w(`${s}/functions/v1/tradingview-webhook`):(console.error("âš ï¸ Supabase URL not configured"),w("/functions/v1/tradingview-webhook"));const a=t.webhook_secret||t.webhookSecret||"";k(a);const m={secret:a,botId:t.id,action:"buy",marketPosition:"long",prevMarketPosition:"flat",marketPositionSize:"1.0",prevMarketPositionSize:"0.0",instrument:"BTCUSDT",timestamp:new Date().toISOString(),maxLag:"300",investmentType:"base",amount:"1.0",mode:"paper",reason:"Test webhook from testing interface"};b(JSON.stringify(m,null,2))}}},[r,n]),o.useEffect(()=>{f()},[r]);const f=async()=>{var t;if(r){T(!0);try{const{data:s,error:a}=await L.from("webhook_calls").select("*").eq("bot_id",r).order("created_at",{ascending:!1}).limit(50);if(a){console.error("âŒ Error fetching webhook calls:",a),(a.code==="42P01"||(t=a.message)!=null&&t.includes("does not exist"))&&console.error("âš ï¸ webhook_calls table does not exist. Please run the migration: 20250113_create_webhook_calls_table.sql"),p([]);return}console.log(`âœ… Fetched ${(s==null?void 0:s.length)||0} webhook calls`),p(s||[])}catch(s){console.error("âŒ Error fetching webhook calls:",s),p([])}finally{T(!1)}}},W=async()=>{if(!r||!h){alert("Please select a bot and provide a test payload");return}N(!0),g(null);try{const t=JSON.parse(h);let s=d;if(!d.startsWith("http")){const P={}.VITE_PUBLIC_SUPABASE_URL||{}.VITE_SUPABASE_URL||"";if(P)s=`${P}${d.startsWith("/")?"":"/"}${d}`;else throw new Error("Supabase URL not configured. Please check your environment variables.")}console.log("ğŸš€ Sending webhook to:",s),console.log("ğŸ“¦ Payload:",t);const a=await fetch(s,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)}),m=await a.text();let y;try{y=JSON.parse(m)}catch{y={raw:m.substring(0,500)}}g({status:a.status,statusText:a.statusText,ok:a.ok,data:y,timestamp:new Date().toISOString()}),setTimeout(()=>{f()},2e3)}catch(t){console.error("âŒ Webhook test error:",t),g({error:t instanceof Error?t.message:String(t),timestamp:new Date().toISOString()})}finally{N(!1)}},_=t=>new Date(t).toLocaleString(),R=t=>{switch(t){case"processed":return"text-green-600 bg-green-50";case"failed":return"text-red-600 bg-red-50";case"rejected":return"text-orange-600 bg-orange-50";default:return"text-gray-600 bg-gray-50"}};return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(O,{title:"Webhook Testing"}),e.jsx("div",{className:"pt-16 pb-6 px-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto space-y-6",children:[e.jsxs(U,{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-semibold mb-4",children:"Test Webhook"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Select Bot"}),e.jsxs("select",{value:r,onChange:t=>j(t.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent",children:[e.jsx("option",{value:"",children:"Select a bot..."}),n.map(t=>e.jsxs("option",{value:t.id,children:[t.name," (",t.symbol,")"]},t.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Webhook URL"}),e.jsx("input",{type:"text",value:d,readOnly:!0,className:"w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Webhook Secret"}),l?e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:u?"text":"password",value:l,readOnly:!0,className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50"}),e.jsx(x,{variant:"secondary",onClick:()=>E(!u),children:e.jsx("i",{className:u?"ri-eye-off-line":"ri-eye-line"})})]}):e.jsxs("div",{className:"p-3 bg-orange-50 border border-orange-200 rounded-lg",children:[e.jsx("p",{className:"text-sm text-orange-800 mb-2",children:"âš ï¸ No webhook secret configured for this bot"}),e.jsxs(x,{onClick:async()=>{if(!r)return;const t=A();try{console.log("ğŸ”„ Generating webhook secret for bot:",r),await c(r,{webhookSecret:t}),k(t),console.log("âœ… Webhook secret state updated:",t);const s=n.find(a=>a.id===r);if(s){const a={secret:t,botId:s.id,action:"buy",marketPosition:"long",prevMarketPosition:"flat",marketPositionSize:"1.0",prevMarketPositionSize:"0.0",instrument:"BTCUSDT",timestamp:new Date().toISOString(),maxLag:"300",investmentType:"base",amount:"1.0",mode:"paper",reason:"Test webhook from testing interface"};b(JSON.stringify(a,null,2)),console.log("âœ… Test payload updated with new secret")}setTimeout(()=>{console.log("âœ… Webhook secret generated! Button should now be enabled.")},100),alert("âœ… Webhook secret generated! You can now test the webhook.")}catch(s){console.error("âŒ Error generating webhook secret:",s),alert("âŒ Failed to generate webhook secret. Please try again.")}},variant:"primary",size:"sm",children:[e.jsx("i",{className:"ri-refresh-line mr-2"}),"Generate Webhook Secret"]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"Test Payload (JSON)"}),e.jsx("textarea",{value:h,onChange:t=>b(t.target.value),rows:8,className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent font-mono text-sm",placeholder:'{"secret": "...", "botId": "...", "action": "{{strategy.order.action}}", "mode": "paper"}'})]}),e.jsxs(x,{onClick:W,loading:C,disabled:!l||l.trim()===""||!r,className:"w-full",children:[e.jsx("i",{className:"ri-send-plane-line mr-2"}),"Send Test Webhook"]}),(!l||l.trim()==="")&&e.jsx("p",{className:"text-xs text-orange-600 mt-1",children:"âš ï¸ Please generate a webhook secret first"}),l&&l.trim()!==""&&r&&e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"âœ… Ready to test! Secret is configured."}),i&&e.jsxs("div",{className:`p-4 rounded-lg border-2 ${i.ok?"border-green-300 bg-green-50":"border-red-300 bg-red-50"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h3",{className:"font-semibold",children:i.ok?"âœ… Success":"âŒ Error"}),e.jsx("span",{className:"text-xs text-gray-500",children:_(i.timestamp)})]}),e.jsxs("div",{className:"text-sm",children:[e.jsxs("p",{className:"mb-2",children:[e.jsx("strong",{children:"Status:"})," ",i.status," ",i.statusText]}),e.jsx("pre",{className:"bg-white p-3 rounded border text-xs overflow-x-auto",children:JSON.stringify(i.data||i.error,null,2)})]})]})]})]}),e.jsxs(U,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h2",{className:"text-xl font-semibold",children:"Recent Webhook Calls"}),e.jsxs(x,{variant:"secondary",size:"sm",onClick:f,loading:v,children:[e.jsx("i",{className:"ri-refresh-line mr-2"}),"Refresh"]})]}),v?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin text-2xl text-gray-400"}),e.jsx("p",{className:"mt-2 text-gray-500",children:"Loading webhook calls..."})]}):S.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx("i",{className:"ri-file-list-line text-3xl mb-2"}),e.jsx("p",{children:"No webhook calls recorded yet"}),e.jsx("p",{className:"text-sm mt-1",children:"Send a test webhook to see it here"}),e.jsxs("div",{className:"mt-4 p-3 bg-orange-50 border border-orange-200 rounded-lg text-left max-w-md mx-auto",children:[e.jsx("p",{className:"text-xs font-semibold text-orange-800 mb-2",children:"âš ï¸ Troubleshooting:"}),e.jsxs("ul",{className:"text-xs text-orange-700 space-y-1 list-disc list-inside",children:[e.jsx("li",{children:"Ensure the webhook_calls table migration has been run"}),e.jsx("li",{children:"Check that the webhook function is deployed"}),e.jsx("li",{children:"Open browser console (F12) to see detailed logs"}),e.jsx("li",{children:"Verify the webhook URL is correct (should start with https://)"})]})]})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-sm",children:[e.jsx("thead",{className:"bg-gray-100",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-4 py-2 text-left",children:"Time"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Status"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Side"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Mode"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Response"}),e.jsx("th",{className:"px-4 py-2 text-left",children:"Error"})]})}),e.jsx("tbody",{children:S.map(t=>e.jsxs("tr",{className:"border-t border-gray-200 hover:bg-gray-50",children:[e.jsx("td",{className:"px-4 py-2 whitespace-nowrap",children:_(t.created_at)}),e.jsx("td",{className:"px-4 py-2",children:e.jsx("span",{className:`px-2 py-1 rounded text-xs font-medium ${R(t.status)}`,children:t.status})}),e.jsx("td",{className:"px-4 py-2 uppercase font-semibold",children:t.side||"â€”"}),e.jsx("td",{className:"px-4 py-2 capitalize",children:t.mode||"â€”"}),e.jsx("td",{className:"px-4 py-2",children:t.response_status?e.jsx("span",{className:`font-semibold ${t.response_status>=200&&t.response_status<300?"text-green-600":"text-red-600"}`,children:t.response_status}):"â€”"}),e.jsx("td",{className:"px-4 py-2",children:t.error_message?e.jsxs("span",{className:"text-red-600 text-xs",title:t.error_message,children:[t.error_message.substring(0,50),"..."]}):"â€”"})]},t.id))})]})})]})]})})]})}export{V as default};
