import{u as O,r,j as e,s as L}from"./index-f36c5022.js";import{H as B}from"./Header-c2d6f07f.js";import{N as q}from"./Navigation-ee81f1aa.js";import{C as g}from"./Card-7c3642f0.js";import{B as H}from"./Button-26b28a57.js";const b={totalTrades:0,longTrades:0,shortTrades:0,wins:0,losses:0,winRate:0,grossPnl:0,fees:0,netPnl:0};function Q(){const{user:l}=O(),[c,C]=r.useState("7d"),[h,T]=r.useState("all"),[p,D]=r.useState(""),[y,F]=r.useState(""),[j,_]=r.useState([]),[m,R]=r.useState("all"),[x,P]=r.useState({summary:b,breakdown:{bySymbol:[]},entries:[]}),[N,f]=r.useState(!1),[v,u]=r.useState(null),[S,$]=r.useState(null),i=r.useMemo(()=>x.summary||b,[x.summary]),A=()=>{const t=new Date,a=t.toISOString();return c==="24h"?{start:new Date(t.getTime()-24*60*60*1e3).toISOString(),end:a}:c==="7d"?{start:new Date(t.getTime()-7*24*60*60*1e3).toISOString(),end:a}:c==="30d"?{start:new Date(t.getTime()-30*24*60*60*1e3).toISOString(),end:a}:{start:p?new Date(p).toISOString():null,end:y?new Date(y).toISOString():null}},E=async()=>{if(l)try{const{data:t,error:a}=await L.from("transaction_log_entries").select("symbol",{distinct:!0}).eq("user_id",l.id);if(a)throw a;const d=Array.from(new Set((t||[]).map(s=>s.symbol).filter(s=>!!s))).sort();_(d)}catch(t){console.error("Failed to load available symbols",t)}},w=async()=>{var d;if(!l)return;const{start:t,end:a}=A();if(c==="custom"&&(!t||!a)){u("Please select both start and end date for custom range.");return}f(!0),u(null);try{const{data:s,error:k}=await L.rpc("transaction_log_report",{p_user_id:l.id,p_symbols:m!=="all"?[m]:null,p_mode:h,p_start:t,p_end:a,p_limit:200,p_offset:0});if(k)throw k;const z={summary:(s==null?void 0:s.summary)||b,breakdown:{bySymbol:((d=s==null?void 0:s.breakdown)==null?void 0:d.bySymbol)||[]},entries:(s==null?void 0:s.entries)||[]};P(z),$(new Date)}catch(s){console.error("Failed to load transaction log report:",s),u((s==null?void 0:s.message)||"Failed to load transaction log report")}finally{f(!1)}};r.useEffect(()=>{E()},[l==null?void 0:l.id]),r.useEffect(()=>{l&&w()},[l==null?void 0:l.id,c,h,m]);const I=t=>{R(t.target.value)},o=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(t||0),U=(t,a=4)=>new Intl.NumberFormat("en-US",{minimumFractionDigits:a,maximumFractionDigits:a}).format(t??0),n=(t,a,d,s="text-gray-900")=>e.jsx(g,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:t}),e.jsx("p",{className:`text-2xl font-semibold ${s}`,children:a})]}),e.jsx("i",{className:`${d} text-2xl text-gray-300`})]})},t),M=[n("Total Trades",i.totalTrades,"ri-bar-chart-line"),n("Net PnL",o(i.netPnl),"ri-funds-line",i.netPnl>=0?"text-green-600":"text-red-600"),n("Fees",o(i.fees),"ri-hand-coin-fill","text-amber-600"),n("Win Rate",`${(i.winRate*100||0).toFixed(1)}%`,"ri-trophy-line","text-blue-600"),n("Long Trades",i.longTrades,"ri-arrow-up-line","text-emerald-600"),n("Short Trades",i.shortTrades,"ri-arrow-down-line","text-rose-600"),n("Wins",i.wins,"ri-checkbox-circle-line","text-green-600"),n("Losses",i.losses,"ri-close-circle-line","text-red-600")];return e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[e.jsx(B,{title:"Transaction Log",subtitle:"Analyze executed trades, fees, and performance across your bots"}),e.jsxs("div",{className:"pt-20 pb-20 px-4 space-y-4 max-w-6xl mx-auto w-full",children:[e.jsxs(g,{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:[{key:"24h",label:"Last 24h"},{key:"7d",label:"Last 7d"},{key:"30d",label:"Last 30d"},{key:"custom",label:"Custom"}].map(t=>e.jsx("button",{onClick:()=>C(t.key),className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${c===t.key?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-300"}`,children:t.label},t.key))}),c==="custom"&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-sm text-gray-600 mb-1",children:"Start date"}),e.jsx("input",{type:"datetime-local",value:p,onChange:t=>D(t.target.value),className:"bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm"})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-sm text-gray-600 mb-1",children:"End date"}),e.jsx("input",{type:"datetime-local",value:y,onChange:t=>F(t.target.value),className:"bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-sm text-gray-600 mb-1",children:"Mode"}),e.jsx("div",{className:"flex items-center gap-2",children:["all","real","paper"].map(t=>e.jsx("button",{onClick:()=>T(t),className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors capitalize ${h===t?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-300"}`,children:t},t))})]}),e.jsxs("div",{className:"flex flex-col md:col-span-2",children:[e.jsx("label",{className:"text-sm text-gray-600 mb-1",children:"Symbol"}),e.jsxs("select",{value:m,onChange:I,className:"bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"All Pairs"}),j.length===0&&e.jsx("option",{value:"",disabled:!0,children:"No symbols available yet"}),j.map(t=>e.jsx("option",{value:t,children:t},t))]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-gray-500",children:S?`Last updated: ${S.toLocaleString()}`:"Results update automatically when filters change."}),e.jsxs(H,{variant:"secondary",size:"sm",onClick:w,loading:N,children:[e.jsx("i",{className:"ri-refresh-line mr-1"}),"Refresh"]})]}),v&&e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 text-sm px-4 py-2 rounded-lg flex items-center gap-2",children:[e.jsx("i",{className:"ri-error-warning-line"}),v]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:M}),e.jsxs(g,{className:"space-y-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Symbol breakdown"}),x.breakdown.bySymbol.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"No trades recorded for the selected filters."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-500 uppercase tracking-wider",children:[e.jsx("th",{className:"px-3 py-2",children:"Symbol"}),e.jsx("th",{className:"px-3 py-2",children:"Mode"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Trades"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"PnL"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Fees"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:x.breakdown.bySymbol.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900 dark:text-white",children:t.symbol}),e.jsx("td",{className:"px-3 py-2 capitalize",children:t.mode}),e.jsx("td",{className:"px-3 py-2 text-right",children:t.trades}),e.jsx("td",{className:`px-3 py-2 text-right ${t.pnl>=0?"text-green-600":"text-red-600"}`,children:o(t.pnl)}),e.jsx("td",{className:"px-3 py-2 text-right text-amber-600",children:o(t.fees)})]},`${t.symbol}-${t.mode}`))})]})})]}),e.jsxs(g,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Recent trades"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Showing up to 200 records"})]}),N?e.jsxs("div",{className:"text-center py-8 text-gray-500 flex items-center justify-center gap-2",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Loading transaction log..."]}):x.entries.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("i",{className:"ri-file-chart-line text-4xl text-gray-300 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"No trades found for the selected filters."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-500 uppercase tracking-wider",children:[e.jsx("th",{className:"px-3 py-2",children:"Time"}),e.jsx("th",{className:"px-3 py-2",children:"Bot"}),e.jsx("th",{className:"px-3 py-2",children:"Symbol"}),e.jsx("th",{className:"px-3 py-2",children:"Side"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Amount"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Price"}),e.jsx("th",{className:"px-3 py-2",children:"Status"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"PnL"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Fees"}),e.jsx("th",{className:"px-3 py-2",children:"Exchange"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Mode"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:x.entries.map(t=>{var a,d,s;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors",children:[e.jsx("td",{className:"px-3 py-2 text-gray-600 dark:text-gray-300",children:new Date(t.executedAt??t.createdAt).toLocaleString()}),e.jsxs("td",{className:"px-3 py-2",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white",children:t.botName||"—"}),e.jsxs("div",{className:"text-xs text-gray-500",children:["#",t.botId.slice(0,6)]})]}),e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900 dark:text-white",children:t.symbol}),e.jsx("td",{className:`px-3 py-2 font-medium ${((a=t.side)==null?void 0:a.toLowerCase())==="buy"||((d=t.side)==null?void 0:d.toLowerCase())==="long"?"text-green-600":"text-red-600"}`,children:(s=t.side)==null?void 0:s.toUpperCase()}),e.jsx("td",{className:"px-3 py-2 text-right",children:U(t.amount)}),e.jsx("td",{className:"px-3 py-2 text-right",children:o(t.price??0)}),e.jsx("td",{className:"px-3 py-2 capitalize",children:t.status||"—"}),e.jsx("td",{className:`px-3 py-2 text-right ${t.pnl>=0?"text-green-600":"text-red-600"}`,children:o(t.pnl)}),e.jsx("td",{className:"px-3 py-2 text-right text-amber-600",children:o(t.fees)}),e.jsx("td",{className:"px-3 py-2 uppercase",children:t.exchange||"—"}),e.jsx("td",{className:"px-3 py-2 text-right capitalize",children:t.mode})]},t.id)})})]})})]})]}),e.jsx(q,{})]})}export{Q as default};
