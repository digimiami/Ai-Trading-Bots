import{u as W,r as l,j as e,s as F}from"./index-7db8efba.js";import{H as Y}from"./Header-51f5643b.js";import{N as G}from"./Navigation-03d82daa.js";import{C as p}from"./Card-5e232337.js";import{B as J}from"./Button-9007c314.js";const f={totalTrades:0,longTrades:0,shortTrades:0,wins:0,losses:0,winRate:0,grossPnl:0,fees:0,netPnl:0};function te(){const{user:i}=W(),[o,P]=l.useState("7d"),[y,$]=l.useState("all"),[u,A]=l.useState(""),[b,_]=l.useState(""),[w,E]=l.useState([]),[g,R]=l.useState("all"),[x,I]=l.useState({summary:f,breakdown:{bySymbol:[]},entries:[]}),[v,S]=l.useState(!1),[k,j]=l.useState(null),[L,M]=l.useState(null),d=l.useMemo(()=>x.summary||f,[x.summary]),U=()=>{const t=new Date,a=t.toISOString();return o==="24h"?{start:new Date(t.getTime()-24*60*60*1e3).toISOString(),end:a}:o==="7d"?{start:new Date(t.getTime()-7*24*60*60*1e3).toISOString(),end:a}:o==="30d"?{start:new Date(t.getTime()-30*24*60*60*1e3).toISOString(),end:a}:{start:u?new Date(u).toISOString():null,end:b?new Date(b).toISOString():null}},z=async()=>{if(i)try{const{data:t,error:a}=await F.from("transaction_log_entries").select("symbol",{distinct:!0}).eq("user_id",i.id);if(a)throw a;const r=Array.from(new Set((t||[]).map(s=>s.symbol).filter(s=>!!s))).sort();E(r)}catch(t){console.error("Failed to load available symbols",t)}},T=async()=>{var r;if(!i)return;const{start:t,end:a}=U();if(o==="custom"&&(!t||!a)){j("Please select both start and end date for custom range.");return}S(!0),j(null);try{const{data:s,error:C}=await F.rpc("transaction_log_report",{p_user_id:i.id,p_symbols:g!=="all"?[g]:null,p_mode:y,p_start:t,p_end:a,p_limit:200,p_offset:0});if(C)throw C;const H={summary:(s==null?void 0:s.summary)||f,breakdown:{bySymbol:((r=s==null?void 0:s.breakdown)==null?void 0:r.bySymbol)||[]},entries:(s==null?void 0:s.entries)||[]};I(H),M(new Date)}catch(s){console.error("Failed to load transaction log report:",s),j((s==null?void 0:s.message)||"Failed to load transaction log report")}finally{S(!1)}};l.useEffect(()=>{z()},[i==null?void 0:i.id]),l.useEffect(()=>{i&&T()},[i==null?void 0:i.id,o,y,g]);const O=t=>{R(t.target.value)},n=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:2,maximumFractionDigits:2}).format(t||0),B=(t,a=4)=>new Intl.NumberFormat("en-US",{minimumFractionDigits:a,maximumFractionDigits:a}).format(t??0),c=(t,a,r,s="text-gray-900")=>e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-gray-500 mb-1",children:t}),e.jsx("p",{className:`text-2xl font-semibold ${s}`,children:a})]}),e.jsx("i",{className:`${r} text-2xl text-gray-300`})]})},t);let N=0,D=0,m=0,h=0;[...x.entries].sort((t,a)=>new Date(t.executedAt||t.createdAt).getTime()-new Date(a.executedAt||a.createdAt).getTime()).forEach(t=>{const a=t.pnl||0;h+=a,h>m&&(m=h);const r=m-h;r>N&&(N=r,D=m>0?r/m*100:0)});const q=[c("Total Trades",d.totalTrades,"ri-bar-chart-line"),c("Net PnL",n(d.netPnl),"ri-funds-line",d.netPnl>=0?"text-green-600":"text-red-600"),c("Fees",n(d.fees),"ri-hand-coin-fill","text-amber-600"),c("Win Rate",`${(d.winRate*100||0).toFixed(1)}%`,"ri-trophy-line","text-blue-600"),c("Win/Loss",`${d.wins}/${d.losses}`,"ri-bar-chart-box-line","text-gray-900"),c("Max Drawdown",`${n(N)} (${D.toFixed(1)}%)`,"ri-arrow-down-line","text-red-600"),c("Long Trades",d.longTrades,"ri-arrow-up-line","text-emerald-600"),c("Short Trades",d.shortTrades,"ri-arrow-down-line","text-rose-600")];return e.jsxs("div",{className:"min-h-screen bg-gray-50 dark:bg-gray-900",children:[e.jsx(Y,{title:"Transaction Log",subtitle:"Analyze executed trades, fees, and performance across your bots"}),e.jsxs("div",{className:"pt-20 pb-20 px-4 space-y-4 max-w-6xl mx-auto w-full",children:[e.jsxs(p,{className:"space-y-4",children:[e.jsx("div",{className:"flex flex-wrap items-center gap-2",children:[{key:"24h",label:"Last 24h"},{key:"7d",label:"Last 7d"},{key:"30d",label:"Last 30d"},{key:"custom",label:"Custom"}].map(t=>e.jsx("button",{onClick:()=>P(t.key),className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors ${o===t.key?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-300"}`,children:t.label},t.key))}),o==="custom"&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-3",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-sm text-gray-600 mb-1",children:"Start date"}),e.jsx("input",{type:"datetime-local",value:u,onChange:t=>A(t.target.value),className:"bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm"})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-sm text-gray-600 mb-1",children:"End date"}),e.jsx("input",{type:"datetime-local",value:b,onChange:t=>_(t.target.value),className:"bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-3",children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsx("label",{className:"text-sm text-gray-600 mb-1",children:"Mode"}),e.jsx("div",{className:"flex items-center gap-2",children:["all","real","paper"].map(t=>e.jsx("button",{onClick:()=>$(t),className:`px-3 py-1.5 rounded-lg text-sm font-medium transition-colors capitalize ${y===t?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200 dark:bg-gray-800 dark:text-gray-300"}`,children:t},t))})]}),e.jsxs("div",{className:"flex flex-col md:col-span-2",children:[e.jsx("label",{className:"text-sm text-gray-600 mb-1",children:"Symbol"}),e.jsxs("select",{value:g,onChange:O,className:"bg-gray-100 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg px-3 py-2 text-sm",children:[e.jsx("option",{value:"all",children:"All Pairs"}),w.length===0&&e.jsx("option",{value:"",disabled:!0,children:"No symbols available yet"}),w.map(t=>e.jsx("option",{value:t,children:t},t))]})]})]}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("div",{className:"text-xs text-gray-500",children:L?`Last updated: ${L.toLocaleString()}`:"Results update automatically when filters change."}),e.jsxs(J,{variant:"secondary",size:"sm",onClick:T,loading:v,children:[e.jsx("i",{className:"ri-refresh-line mr-1"}),"Refresh"]})]}),k&&e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 text-sm px-4 py-2 rounded-lg flex items-center gap-2",children:[e.jsx("i",{className:"ri-error-warning-line"}),k]})]}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4",children:q}),e.jsxs(p,{className:"space-y-3",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Symbol breakdown"}),x.breakdown.bySymbol.length===0?e.jsx("div",{className:"text-sm text-gray-500",children:"No trades recorded for the selected filters."}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-500 uppercase tracking-wider",children:[e.jsx("th",{className:"px-3 py-2",children:"Symbol"}),e.jsx("th",{className:"px-3 py-2",children:"Mode"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Trades"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"PnL"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Fees"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:x.breakdown.bySymbol.map(t=>e.jsxs("tr",{children:[e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900 dark:text-white",children:t.symbol}),e.jsx("td",{className:"px-3 py-2 capitalize",children:t.mode}),e.jsx("td",{className:"px-3 py-2 text-right",children:t.trades}),e.jsx("td",{className:`px-3 py-2 text-right ${t.pnl>=0?"text-green-600":"text-red-600"}`,children:n(t.pnl)}),e.jsx("td",{className:"px-3 py-2 text-right text-amber-600",children:n(t.fees)})]},`${t.symbol}-${t.mode}`))})]})})]}),e.jsxs(p,{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 dark:text-white",children:"Recent trades"}),e.jsx("div",{className:"text-xs text-gray-500",children:"Showing up to 200 records"})]}),v?e.jsxs("div",{className:"text-center py-8 text-gray-500 flex items-center justify-center gap-2",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Loading transaction log..."]}):x.entries.length===0?e.jsxs("div",{className:"text-center py-8",children:[e.jsx("i",{className:"ri-file-chart-line text-4xl text-gray-300 mb-2"}),e.jsx("p",{className:"text-sm text-gray-500",children:"No trades found for the selected filters."})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full divide-y divide-gray-200 dark:divide-gray-700 text-sm",children:[e.jsx("thead",{children:e.jsxs("tr",{className:"text-left text-gray-500 uppercase tracking-wider",children:[e.jsx("th",{className:"px-3 py-2",children:"Time"}),e.jsx("th",{className:"px-3 py-2",children:"Bot"}),e.jsx("th",{className:"px-3 py-2",children:"Symbol"}),e.jsx("th",{className:"px-3 py-2",children:"Side"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Amount"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Price"}),e.jsx("th",{className:"px-3 py-2",children:"Status"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"PnL"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Fees"}),e.jsx("th",{className:"px-3 py-2",children:"Exchange"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Mode"})]})}),e.jsx("tbody",{className:"divide-y divide-gray-100 dark:divide-gray-800",children:x.entries.map(t=>{var a,r,s;return e.jsxs("tr",{className:"hover:bg-gray-50 dark:hover:bg-gray-800/50 transition-colors",children:[e.jsx("td",{className:"px-3 py-2 text-gray-600 dark:text-gray-300",children:new Date(t.executedAt??t.createdAt).toLocaleString()}),e.jsxs("td",{className:"px-3 py-2",children:[e.jsx("div",{className:"font-medium text-gray-900 dark:text-white",children:t.botName||"—"}),e.jsxs("div",{className:"text-xs text-gray-500",children:["#",t.botId.slice(0,6)]})]}),e.jsx("td",{className:"px-3 py-2 font-medium text-gray-900 dark:text-white",children:t.symbol}),e.jsx("td",{className:`px-3 py-2 font-medium ${((a=t.side)==null?void 0:a.toLowerCase())==="buy"||((r=t.side)==null?void 0:r.toLowerCase())==="long"?"text-green-600":"text-red-600"}`,children:(s=t.side)==null?void 0:s.toUpperCase()}),e.jsx("td",{className:"px-3 py-2 text-right",children:B(t.amount)}),e.jsx("td",{className:"px-3 py-2 text-right",children:n(t.price??0)}),e.jsx("td",{className:"px-3 py-2 capitalize",children:t.status||"—"}),e.jsx("td",{className:`px-3 py-2 text-right ${t.pnl>=0?"text-green-600":"text-red-600"}`,children:n(t.pnl)}),e.jsx("td",{className:"px-3 py-2 text-right text-amber-600",children:n(t.fees)}),e.jsx("td",{className:"px-3 py-2 uppercase",children:t.exchange||"—"}),e.jsx("td",{className:"px-3 py-2 text-right capitalize",children:t.mode})]},t.id)})})]})})]})]}),e.jsx(G,{})]})}export{te as default};
