import{r as l,s as J,a as Me,d as De,j as e}from"./index-eb0601e1.js";import{H as ze}from"./Header-b9b86de9.js";import{N as Ue}from"./Navigation-f69e8275.js";import{B as i}from"./Button-4b9a38c8.js";import{C as oe}from"./Card-e42fc851.js";import{u as Ve}from"./useBots-2b9e4612.js";import{u as We}from"./useBotActivity-7b69a2b5.js";const Oe=p=>{const[h,R]=l.useState(new Map),[M,v]=l.useState(!0),[H,m]=l.useState(null),b=async()=>{if(p.length===0){R(new Map),v(!1);return}try{v(!0),m(null);const n=new Date,Y=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),0,0,0,0)),g=new Date(Date.UTC(n.getUTCFullYear(),n.getUTCMonth(),n.getUTCDate(),23,59,59,999)),{data:j,error:S}=await J.from("trading_bots").select("id, strategy_config").in("id",p);if(S)throw S;const{data:k,error:D}=await J.from("trades").select("bot_id, id").in("bot_id",p).gte("executed_at",Y.toISOString()).lte("executed_at",g.toISOString()).in("status",["filled","completed","closed"]);if(D)throw D;const C=new Map;k&&k.forEach(c=>{const y=C.get(c.bot_id)||0;C.set(c.bot_id,y+1)});const N=new Map;j&&j.forEach(c=>{let y=8;try{const f=typeof c.strategy_config=="string"?JSON.parse(c.strategy_config):c.strategy_config;f&&typeof f.max_trades_per_day=="number"&&(y=f.max_trades_per_day)}catch{console.warn("Failed to parse strategy_config for bot:",c.id)}const $=C.get(c.id)||0,T=Math.max(0,y-$),u=$>=y;N.set(c.id,{botId:c.id,tradesToday:$,maxTradesPerDay:y,isLimitReached:u,remainingTrades:T})}),R(N)}catch(n){console.error("Error fetching trade limits:",n),m(n instanceof Error?n.message:"Failed to fetch trade limits")}finally{v(!1)}};return l.useEffect(()=>{b();const n=setInterval(b,3e4);return()=>clearInterval(n)},[p.join(",")]),{limits:h,getLimit:n=>h.get(n),loading:M,error:H,refresh:b}};function Xe(){const p=Me(),{bots:h,loading:R,startBot:M,stopBot:v,pauseBot:H,updateBot:m,deleteBot:b,createBot:n}=Ve(),{activities:Y,addLog:g}=We(h),{isExecuting:j,lastExecution:S,timeSync:k,executeBot:D,executeAllBots:C}=De(),[N,c]=l.useState("all"),[y,$]=l.useState("overview"),[T,u]=l.useState(!1),[f,me]=l.useState(null),[q,X]=l.useState(null),[Z,z]=l.useState(null),[_,A]=l.useState(null),[ee,U]=l.useState(null),[w,L]=l.useState(null),[V,xe]=l.useState(null),[B,ge]=l.useState({}),[E,se]=l.useState({}),[te,ae]=l.useState({}),[W,O]=l.useState({}),o=y==="webhook",ue=h.map(s=>s.id),{limits:Ie,getLimit:re,refresh:pe}=Oe(ue),ie=`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/tradingview-webhook`,he=()=>{var s;try{const t=new Uint8Array(18);if((s=window==null?void 0:window.crypto)!=null&&s.getRandomValues)return window.crypto.getRandomValues(t),Array.from(t,a=>a.toString(16).padStart(2,"0")).join("")}catch(t){console.warn("Falling back to Math.random for webhook secret generation:",t)}return Math.random().toString(36).slice(2,12)+Math.random().toString(36).slice(2,12)},G=async(s,t)=>{if(!s){alert("Nothing to copy yet.");return}try{await navigator.clipboard.writeText(s),alert(`âœ… ${t} copied to clipboard`)}catch(a){console.error("Failed to copy value:",a),alert("Unable to copy to clipboard. Please copy manually.")}},K=async s=>{se(t=>({...t,[s]:!0}));try{const{data:t,error:a}=await J.from("manual_trade_signals").select("*").eq("bot_id",s).order("created_at",{ascending:!1}).limit(20);if(a)throw a;ge(r=>({...r,[s]:t||[]}))}catch(t){console.error("Failed to load webhook signals:",t),alert(`Failed to load webhook signals: ${(t==null?void 0:t.message)||"Unknown error"}`)}finally{se(t=>({...t,[s]:!1}))}},ye=async s=>{if(o)return;const t=V===s;xe(t?null:s),t||await K(s)},fe=async s=>{if(!confirm("Regenerate webhook secret? All existing TradingView alerts must be updated to use the new value."))return;const t=he();O(a=>({...a,[s.id]:!0}));try{await m(s.id,{webhookSecret:t}),ae(a=>({...a,[s.id]:!0})),alert("âœ… Webhook secret regenerated. Update your TradingView alert settings.")}catch(a){console.error("Failed to regenerate webhook secret:",a),alert(`Failed to regenerate webhook secret: ${(a==null?void 0:a.message)||"Unknown error"}`)}finally{O(a=>({...a,[s.id]:!1}))}},we=async s=>{const t=!(s.webhookTriggerImmediate??!0);O(a=>({...a,[s.id]:!0}));try{await m(s.id,{webhookTriggerImmediate:t}),alert(`âœ… Immediate execution ${t?"enabled":"disabled"} for TradingView webhook signals.`)}catch(a){console.error("Failed to update webhook execution preference:",a),alert(`Failed to update webhook execution preference: ${(a==null?void 0:a.message)||"Unknown error"}`)}finally{O(a=>({...a,[s.id]:!1}))}};l.useEffect(()=>{o&&h.forEach(s=>{!B[s.id]&&!E[s.id]&&K(s.id)})},[o,h,B,E]);const le=s=>JSON.stringify({secret:s.webhookSecret||s.webhook_secret||"YOUR_TRADINGVIEW_WEBHOOK_SECRET",botId:s.id,action:"{{strategy.order.action}}",marketPosition:"{{strategy.market_position}}",prevMarketPosition:"{{strategy.prev_market_position}}",marketPositionSize:"{{strategy.market_position_size}}",prevMarketPositionSize:"{{strategy.prev_market_position_size}}",instrument:"{{ticker}}",timestamp:"{{timenow}}",maxLag:"300",investmentType:"base",amount:"{{strategy.order.contracts}}",mode:s.paperTrading?"paper":"real",reason:"TradingView alert signal"},null,2),ne=s=>{if(!s)return"â€”";try{return new Date(s).toLocaleString()}catch{return s}},je=s=>{switch((s||"").toLowerCase()){case"completed":return"bg-green-100 text-green-700";case"processing":return"bg-blue-100 text-blue-700";case"failed":return"bg-red-100 text-red-700";default:return"bg-gray-100 text-gray-700"}},x=h.filter(s=>N==="all"?!0:N==="live"?!s.paperTrading:s.status===N),Ne=async()=>{try{const{data:{session:s}}=await J.auth.getSession();if(!s){console.warn("âš ï¸ No session available when attempting to reset paper trading performance.");return}const t=`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/paper-trading`,a=await fetch(t,{method:"POST",headers:{Authorization:`Bearer ${s.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({action:"reset_performance"})});if(!a.ok){const r=await a.json().catch(()=>null);throw new Error((r==null?void 0:r.error)||`Failed to reset paper trading performance (status ${a.status})`)}console.log("âœ… Paper trading performance reset successfully via Reset All")}catch(s){console.error("Failed to reset paper trading performance:",s)}},ve=s=>Y.find(t=>t.botId===s),I=s=>{switch(s){case"info":return"text-blue-600 bg-blue-50";case"warning":return"text-yellow-600 bg-yellow-50";case"error":return"text-red-600 bg-red-50";case"success":return"text-green-600 bg-green-50";default:return"text-gray-600 bg-gray-50"}},de=s=>{switch(s){case"market":return"ri-line-chart-line";case"trade":return"ri-exchange-line";case"strategy":return"ri-brain-line";case"system":return"ri-settings-line";case"error":return"ri-error-warning-line";default:return"ri-information-line"}},ce=s=>new Date(s).toLocaleTimeString(),be=s=>{switch(s){case"running":return"bg-green-100 text-green-800";case"paused":return"bg-yellow-100 text-yellow-800";case"stopped":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}},ke=s=>{switch(s){case"low":return"text-green-600";case"medium":return"text-yellow-600";case"high":return"text-red-600";default:return"text-gray-600"}},Q=async(s,t)=>{try{if(console.log(`ðŸ”„ Attempting to ${t} bot ${s} from origin: ${window.location.origin}`),t==="start"){await M(s);try{await g(s,{level:"success",category:"system",message:"Bot started successfully",details:{action:"start",timestamp:new Date().toISOString()}})}catch(a){console.warn("âš ï¸ Failed to record start log:",a)}alert("âœ… Bot started successfully!")}else if(t==="stop"){await v(s);try{await g(s,{level:"info",category:"system",message:"Bot stopped by user",details:{action:"stop",timestamp:new Date().toISOString()}})}catch(a){console.warn("âš ï¸ Failed to record stop log:",a)}alert("âœ… Bot stopped successfully!")}else if(t==="pause"){await H(s);try{await g(s,{level:"warning",category:"system",message:"Bot paused by user",details:{action:"pause",timestamp:new Date().toISOString()}})}catch(a){console.warn("âš ï¸ Failed to record pause log:",a)}alert("âœ… Bot paused successfully!")}}catch(a){console.error(`âŒ Failed to ${t} bot:`,a);const r=(a==null?void 0:a.message)||String(a)||"Unknown error";console.error("Error details:",{message:r,stack:a==null?void 0:a.stack,origin:window.location.origin,url:window.location.href}),alert(`âŒ Failed to ${t} bot: ${r}

Please check the browser console (F12) for more details.`),await g(s,{level:"error",category:"error",message:`Failed to ${t} bot: ${r}`,details:{action:t,error:r,origin:window.location.origin}})}},Te=async()=>{u(!0);try{const s=x.filter(t=>t.status==="stopped"||t.status==="paused");await Promise.all(s.map(t=>M(t.id)))}catch(s){console.error("Failed to start all bots:",s)}finally{u(!1)}},Se=async()=>{u(!0);try{const s=x.filter(t=>t.status==="running"||t.status==="paused");await Promise.all(s.map(t=>v(t.id)))}catch(s){console.error("Failed to stop all bots:",s)}finally{u(!1)}},Ce=async()=>{if(confirm("Are you sure you want to reset all bot statistics? This will set PnL, trades count, and win rate to zero.")){u(!0);try{await Promise.all(x.map(s=>m(s.id,{total_trades:0,win_rate:0,pnl:0,pnl_percentage:0,last_trade_at:null}))),await Ne(),console.log("All bot statistics reset successfully")}catch(s){console.error("Failed to reset all bots:",s)}finally{u(!1)}}},$e=async()=>{if(confirm("Are you sure you want to delete all bots? This action cannot be undone.")){u(!0);try{await Promise.all(x.map(s=>b(s.id))),console.log("All bots deleted successfully")}catch(s){console.error("Failed to delete all bots:",s)}finally{u(!1)}}},_e=async(s,t)=>{if(confirm(`Are you sure you want to reset "${t}" statistics? This will set PnL, trades count, and win rate to zero.`))try{await m(s,{total_trades:0,win_rate:0,pnl:0,pnl_percentage:0,last_trade_at:null}),console.log(`Bot "${t}" statistics reset successfully`)}catch(a){console.error(`Failed to reset bot "${t}":`,a)}},Ae=async(s,t)=>{if(confirm(`Are you sure you want to delete "${t}"? This action cannot be undone.`))try{await b(s),console.log(`Bot "${t}" deleted successfully`)}catch(a){console.error(`Failed to delete bot "${t}":`,a)}},Le=async s=>{try{const t=s.name.replace(/\s*\(Copy(?: \d+)?\)\s*$/,"");let a=`${t} (Copy)`,r=1;for(;h.some(P=>P.name===a);)r++,a=`${t} (Copy ${r})`;let d=s.strategy||{};if(typeof d=="string")try{d=JSON.parse(d)}catch(P){console.warn("Failed to parse strategy, using empty object:",P),d={}}let F=s.strategyConfig||s.strategy_config||{};if(typeof F=="string")try{F=JSON.parse(F)}catch(P){console.warn("Failed to parse strategyConfig, using empty object:",P),F={}}const Pe={name:a,exchange:s.exchange,tradingType:s.tradingType||s.trading_type||"spot",symbol:s.symbol,timeframe:s.timeframe||"1h",leverage:s.leverage||1,riskLevel:s.riskLevel||s.risk_level||"medium",tradeAmount:s.tradeAmount||s.trade_amount||100,stopLoss:s.stopLoss||s.stop_loss||2,takeProfit:s.takeProfit||s.take_profit||4,strategy:d,strategyConfig:F,paperTrading:s.paperTrading||s.paper_trading||!1,status:"stopped",pnl:0,pnlPercentage:0,totalTrades:0,winRate:0,lastTradeAt:null,aiMlEnabled:s.aiMlEnabled||s.ai_ml_enabled||!1},Re=await n(Pe);alert(`âœ… Bot "${a}" cloned successfully!`),await g(s.id,{level:"info",category:"system",message:`Bot cloned as "${a}"`,details:{clonedBotId:Re.id}})}catch(t){console.error("Failed to clone bot:",t),alert(`âŒ Failed to clone bot: ${t.message||"Unknown error"}`)}},Be=s=>{p(`/edit-bot/${s}`)},Ee=async(s,t)=>{if(q===s){console.log("Already toggling AI/ML for this bot, please wait...");return}try{X(s),await m(s,{aiMlEnabled:!t}),g(s,{level:"info",category:"system",message:`AI/ML ${t?"disabled":"enabled"} for bot`})}catch(a){console.error("Failed to toggle AI/ML:",a),g(s,{level:"error",category:"system",message:"Failed to toggle AI/ML"})}finally{X(null)}},Fe=async s=>{const a=!(s.paperTrading||!1);if(!a){const r=["âœ… Real exchange API keys are connected and ACTIVE (non-testnet)","âœ… Wallets have sufficient available balance for this bot's trade size","âœ… Stop-loss, take-profit, and risk limits are reviewed for live execution","âœ… You understand trades will execute on your real exchange account"].join(`
`);if(!window.confirm(`âš ï¸ Enable REAL trading for "${s.name}"?

Before proceeding, make sure:

${r}

Continue to live trading mode?`))return}try{await m(s.id,{paperTrading:a}),await g(s.id,{level:a?"info":"warning",category:"system",message:a?"Bot switched to paper trading mode":"Bot switched to REAL trading mode",details:{paperTrading:a,switchedAt:new Date().toISOString()}}),alert(a?"âœ… Bot switched to Paper Trading mode. Orders will only simulate fills for testing.":`ðŸš¨ "${s.name}" is now in REAL trading mode.

Trades will execute on your connected exchange using live funds.`)}catch(r){console.error("Failed to toggle paper trading:",r),alert(`Failed to toggle trading mode: ${(r==null?void 0:r.message)||"Unknown error"}`)}};return e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx(ze,{title:"Trading Bots",action:e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(i,{variant:"warning",size:"sm",onClick:C,disabled:j||x.filter(s=>s.status==="running").length===0,children:[e.jsx("i",{className:"ri-play-circle-line mr-1"}),"Execute All"]}),e.jsxs(i,{variant:"success",size:"sm",onClick:Te,disabled:T||x.filter(s=>s.status==="stopped"||s.status==="paused").length===0,children:[e.jsx("i",{className:"ri-play-line mr-1"}),"Start All"]}),e.jsxs(i,{variant:"secondary",size:"sm",onClick:Se,disabled:T||x.filter(s=>s.status==="running"||s.status==="paused").length===0,children:[e.jsx("i",{className:"ri-stop-line mr-1"}),"Stop All"]}),e.jsxs(i,{variant:"secondary",size:"sm",onClick:Ce,disabled:T||x.length===0,children:[e.jsx("i",{className:"ri-refresh-line mr-1"}),"Reset All"]}),e.jsxs(i,{variant:"danger",size:"sm",onClick:$e,disabled:T||x.length===0,children:[e.jsx("i",{className:"ri-delete-bin-line mr-1"}),"Delete All"]}),e.jsxs(i,{variant:"primary",size:"sm",onClick:()=>p("/create-bot"),children:[e.jsx("i",{className:"ri-add-line mr-1"}),"New Bot"]})]})}),e.jsx("div",{className:"pt-20 pb-20 px-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto space-y-4",children:[e.jsx(oe,{className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("div",{className:`w-3 h-3 rounded-full ${j?"bg-yellow-500 animate-pulse":"bg-green-500"}`}),e.jsx("span",{className:"text-sm text-gray-600",children:j?"Executing...":"Ready"})]}),S&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Last execution: ",new Date(S).toLocaleTimeString()]}),k&&e.jsxs("div",{className:"text-xs text-gray-500",children:["Time sync: ",k.offset>0?"+":"",k.offset,"ms"]})]}),e.jsx("div",{className:"text-xs text-gray-500",children:"Auto-execution every 5 minutes"})]})}),e.jsx("div",{className:"flex space-x-2 overflow-x-auto",children:[{id:"all",label:"All"},{id:"running",label:"Running"},{id:"paused",label:"Paused"},{id:"stopped",label:"Stopped"},{id:"live",label:"Live Trading"}].map(s=>e.jsx("button",{onClick:()=>c(s.id),className:`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap ${N===s.id?"bg-blue-600 text-white":"bg-white text-gray-600 border border-gray-200"}`,children:s.label},s.id))}),e.jsx("div",{className:"flex space-x-2 overflow-x-auto",children:[{id:"overview",label:"Bot Overview"},{id:"webhook",label:"TradingView Webhooks"}].map(s=>e.jsx("button",{onClick:()=>$(s.id),className:`px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap ${y===s.id?"bg-purple-600 text-white":"bg-white text-gray-600 border border-gray-200"}`,children:s.label},s.id))}),e.jsx("div",{className:"space-y-4",children:R?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"}),e.jsx("p",{className:"text-gray-600",children:"Loading bots..."})]}):x.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx("i",{className:"ri-robot-line text-4xl text-gray-400 mb-4"}),e.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No bots found"}),e.jsx("p",{className:"text-gray-500 mb-4",children:"Create your first trading bot to get started"}),e.jsxs(i,{onClick:()=>p("/create-bot"),children:[e.jsx("i",{className:"ri-add-line mr-2"}),"Create Bot"]})]}):x.map(s=>e.jsxs(oe,{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsx("div",{className:"w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center",children:e.jsx("i",{className:`${s.exchange==="bybit"?"ri-currency-line":"ri-exchange-line"} text-blue-600 text-xl`})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:s.name}),e.jsxs("p",{className:"text-sm text-gray-500",children:[s.symbol," â€¢ ",s.exchange.toUpperCase()]}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1 flex-wrap gap-1",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${be(s.status)}`,children:s.status}),e.jsxs("span",{className:`text-xs font-medium ${ke(s.riskLevel)}`,children:[s.riskLevel," risk"]}),(()=>{const t=re(s.id);return t&&t.isLimitReached?e.jsxs("span",{className:"px-2 py-1 rounded-full text-xs font-medium bg-red-100 text-red-800 flex items-center gap-1",children:[e.jsx("i",{className:"ri-alert-line"}),"Limit Reached"]}):null})()]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:`text-lg font-bold ${(s.pnl??0)>=0?"text-green-600":"text-red-600"}`,children:[(s.pnl??0)>=0?"+":"","$",(s.pnl??0).toFixed(2)]}),e.jsxs("p",{className:`text-sm ${(s.pnlPercentage??0)>=0?"text-green-600":"text-red-600"}`,children:[(s.pnlPercentage??0)>=0?"+":"",(s.pnlPercentage??0).toFixed(2),"%"]})]})]}),!o&&(()=>{const t=re(s.id);return t?e.jsxs("div",{className:"pt-3 border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Daily Trades:"}),e.jsxs("span",{className:`text-sm font-semibold ${t.isLimitReached?"text-red-600":t.tradesToday/t.maxTradesPerDay>.8?"text-yellow-600":"text-green-600"}`,children:[t.tradesToday," / ",t.maxTradesPerDay]}),t.isLimitReached&&e.jsx("span",{className:"text-xs text-red-600",children:"(Limit Reached)"})]}),e.jsxs("button",{onClick:()=>{Z===s.id?(z(null),A(null)):(z(s.id),A(t.maxTradesPerDay))},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1",title:"Edit max trades per day",children:[e.jsx("i",{className:"ri-edit-line"}),"Edit Limit"]})]}),e.jsx("div",{className:"w-full bg-gray-200 rounded-full h-2 mb-2",children:e.jsx("div",{className:`h-2 rounded-full transition-all ${t.isLimitReached?"bg-red-500":t.tradesToday/t.maxTradesPerDay>.8?"bg-yellow-500":"bg-green-500"}`,style:{width:`${Math.min(100,t.tradesToday/t.maxTradesPerDay*100)}%`}})}),Z===s.id&&e.jsxs("div",{className:"mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"Max Trades Per Day:"}),e.jsx("input",{type:"number",min:"1",max:"200",value:_||t.maxTradesPerDay,onChange:a=>A(parseInt(a.target.value)||1),className:"w-20 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(i,{size:"sm",onClick:async()=>{if(_&&_>0)try{let a={};if(s.strategyConfig)if(typeof s.strategyConfig=="string")try{a=JSON.parse(s.strategyConfig)}catch(d){console.warn("Failed to parse strategyConfig:",d),a={}}else a={...s.strategyConfig};const r={bias_mode:a.bias_mode||"auto",regime_mode:a.regime_mode||"auto",htf_timeframe:a.htf_timeframe||"4h",...a,max_trades_per_day:_};console.log("Updating strategyConfig:",r),await m(s.id,{strategyConfig:r}),z(null),A(null),setTimeout(async()=>{await pe(),window.location.reload()},500),alert(`âœ… Max trades per day updated to ${_}`)}catch(a){console.error("Error updating limit:",a);const r=(a==null?void 0:a.message)||"Failed to update limit. Please try again.";alert(`Failed to update limit: ${r}`)}},className:"text-xs",children:"Save"}),e.jsx(i,{size:"sm",variant:"secondary",onClick:()=>{z(null),A(null)},className:"text-xs",children:"Cancel"})]})]})]}):null})(),!o&&e.jsxs("div",{className:"pt-3 border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"Trade Amount:"}),e.jsxs("span",{className:"text-sm font-semibold text-gray-900",children:["$",(s.tradeAmount||100).toFixed(2)," USD"]})]}),e.jsxs("button",{onClick:()=>{ee===s.id?(U(null),L(null)):(U(s.id),L(s.tradeAmount||100))},className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1",title:"Edit trade amount",children:[e.jsx("i",{className:"ri-edit-line"}),"Edit Amount"]})]}),e.jsxs("p",{className:"text-xs text-gray-500 mb-2",children:["Est. Order Value: $",((s.tradeAmount||100)*s.leverage*1.5).toFixed(2)," USD",e.jsxs("span",{className:"ml-2 text-gray-400",children:["(Amount Ã— Leverage ",s.leverage,"x Ã— 1.5 buffer)"]})]}),ee===s.id&&e.jsxs("div",{className:"mt-2 p-3 bg-blue-50 rounded-lg border border-blue-200",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx("label",{className:"text-xs font-medium text-gray-700",children:"Trade Amount (USD):"}),e.jsx("input",{type:"number",min:"10",max:"10000",step:"10",value:w||s.tradeAmount||100,onChange:t=>L(parseFloat(t.target.value)||10),className:"w-24 px-2 py-1 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"mb-2",children:[e.jsxs("p",{className:"text-xs text-gray-600",children:["New Est. Order Value: $",((w||s.tradeAmount||100)*s.leverage*1.5).toFixed(2)," USD"]}),(w||s.tradeAmount||100)>100&&e.jsx("p",{className:"text-xs text-yellow-600 mt-1",children:"âš ï¸ Higher amounts may require more balance"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(i,{size:"sm",onClick:async()=>{if(w&&w>=10&&w<=1e4)try{await m(s.id,{tradeAmount:w}),U(null),L(null),setTimeout(()=>{window.location.reload()},500),alert(`âœ… Trade amount updated to $${w.toFixed(2)}`)}catch(t){console.error("Error updating trade amount:",t);const a=(t==null?void 0:t.message)||"Failed to update trade amount. Please try again.";alert(`Failed to update trade amount: ${a}`)}else alert("Please enter a valid trade amount between $10 and $10,000")},className:"text-xs",children:"Save"}),e.jsx(i,{size:"sm",variant:"secondary",onClick:()=>{U(null),L(null)},className:"text-xs",children:"Cancel"})]})]})]}),!o&&e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-6 gap-4 pt-4 border-t border-gray-100 dark:border-gray-700",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Trades"}),e.jsx("p",{className:"font-semibold text-gray-900 dark:text-white",children:s.totalTrades??0})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Win Rate"}),e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-white",children:[(s.winRate??0).toFixed(1),"%"]})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Win/Loss"}),(()=>{const t=s.totalTrades??0,a=s.closedTrades??t,r=s.winTrades??(a>0?Math.round(a*(s.winRate??0)/100):0),d=s.lossTrades??Math.max(0,a-r);return e.jsxs("p",{className:"font-semibold text-gray-900 dark:text-white",children:[e.jsx("span",{className:"text-green-600 dark:text-green-400",children:r}),e.jsx("span",{className:"text-gray-400 dark:text-gray-500 mx-1",children:"/"}),e.jsx("span",{className:"text-red-600 dark:text-red-400",children:d})]})})()]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Fees"}),(()=>{const t=s.totalFees??s.total_fees??s.fees??0,a=Number.isFinite(t)?t:0,r=a>0?"-":"",d=Math.abs(a);return e.jsxs("p",{className:`font-semibold ${d>0?"text-red-600 dark:text-red-400":"text-gray-900 dark:text-white"}`,children:[r,"$",d.toFixed(2)]})})()]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"Drawdown"}),(()=>{const t=s.drawdown??s.maxDrawdown??0,a=Number.isFinite(t)?Math.abs(t):0,r=s.drawdownPercentage??s.drawdown_percentage??0,d=Number.isFinite(r)?Math.abs(r):0;return e.jsxs("div",{children:[e.jsxs("p",{className:`font-semibold ${a>0?"text-red-600 dark:text-red-400":"text-gray-900 dark:text-white"}`,children:[a>0?"-":"","$",a.toFixed(2)]}),e.jsxs("p",{className:"text-xs text-gray-500 dark:text-gray-400",children:[d.toFixed(1),"%"]})]})})()]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm text-gray-500 dark:text-gray-400",children:"PnL"}),(()=>{const t=s.realizedPnl!==void 0?s.realizedPnl:s.pnl??0;return e.jsxs("p",{className:`font-semibold ${t>=0?"text-green-600 dark:text-green-400":"text-red-600 dark:text-red-400"}`,children:[t>=0?"+":"","$",t.toFixed(2)]})})()]})]}),!o&&(()=>{const t=ve(s.id),a=(t==null?void 0:t.logs.slice(0,3))||[];return e.jsxs("div",{className:"pt-4 border-t border-gray-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-700",children:"Recent Activity"}),e.jsx("button",{onClick:()=>me(f===s.id?null:s.id),className:"text-xs text-blue-600 hover:text-blue-800",children:f===s.id?"Hide":"Show All"})]}),t&&e.jsxs("div",{className:"flex space-x-4 mb-3 text-xs",children:[e.jsxs("span",{className:"text-green-600",children:["âœ“ ",t.successCount]}),e.jsxs("span",{className:"text-yellow-600",children:["âš  ",t.logs.filter(r=>r.level==="warning").length]}),e.jsxs("span",{className:"text-red-600",children:["âœ— ",t.errorCount]}),e.jsxs("span",{className:"text-gray-500",children:["ðŸ“Š ",t.logs.length," total"]})]}),e.jsx("div",{className:"space-y-2",children:a.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-500 text-sm",children:[e.jsx("i",{className:"ri-file-list-line text-lg mb-1"}),e.jsx("p",{children:"No activity logs yet"})]}):a.map(r=>e.jsxs("div",{className:"flex items-start space-x-2 p-2 bg-gray-50 rounded text-xs",children:[e.jsx("div",{className:`w-5 h-5 rounded-full flex items-center justify-center ${I(r.level)}`,children:e.jsx("i",{className:`${de(r.category)} text-xs`})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`px-1 py-0.5 rounded text-xs font-medium ${I(r.level)}`,children:r.level}),e.jsx("span",{className:"text-gray-500",children:ce(r.timestamp)})]}),e.jsx("p",{className:"text-gray-700 mt-1 truncate",children:r.message})]})]},r.id))}),f===s.id&&t&&t.logs.length>3&&e.jsx("div",{className:"mt-3 space-y-2 max-h-48 overflow-y-auto",children:t.logs.slice(3).map(r=>e.jsxs("div",{className:"flex items-start space-x-2 p-2 bg-gray-50 rounded text-xs",children:[e.jsx("div",{className:`w-5 h-5 rounded-full flex items-center justify-center ${I(r.level)}`,children:e.jsx("i",{className:`${de(r.category)} text-xs`})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:`px-1 py-0.5 rounded text-xs font-medium ${I(r.level)}`,children:r.level}),e.jsx("span",{className:"text-gray-500",children:ce(r.timestamp)})]}),e.jsx("p",{className:"text-gray-700 mt-1",children:r.message}),r.details&&e.jsxs("details",{className:"mt-1",children:[e.jsx("summary",{className:"cursor-pointer text-gray-500 hover:text-gray-700",children:"Details"}),e.jsx("pre",{className:"mt-1 p-1 bg-white rounded border text-xs overflow-x-auto",children:JSON.stringify(r.details,null,2)})]})]})]},r.id))})]})})(),(()=>{const t=o||V===s.id;return e.jsxs("div",{className:`pt-4 border-t border-gray-100 ${o?"bg-blue-50 rounded-lg border-blue-100":""}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("i",{className:"ri-link-m text-blue-500"}),e.jsx("h4",{className:"text-sm font-medium text-gray-700",children:"TradingView Webhook"})]}),o?e.jsx("span",{className:"text-xs uppercase font-semibold text-blue-500 tracking-wide",children:"Webhook Dashboard"}):e.jsxs("button",{onClick:()=>ye(s.id),className:"text-xs text-blue-600 hover:text-blue-800 flex items-center gap-1",children:[e.jsx("i",{className:`ri-${V===s.id?"arrow-up-s-line":"arrow-down-s-line"}`}),V===s.id?"Hide":"Manage"]})]}),t&&e.jsxs("div",{className:`mt-3 space-y-4 ${o?"bg-white border border-blue-100":"bg-blue-50 border border-blue-100"} rounded-lg p-4`,children:[e.jsxs("div",{className:"grid gap-4 md:grid-cols-2",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase font-semibold text-gray-500",children:"Webhook Secret"}),e.jsx("div",{className:"mt-1 font-mono text-sm bg-white border border-gray-200 rounded px-3 py-2 flex items-center justify-between",children:e.jsx("span",{className:"truncate pr-3",children:te[s.id]?s.webhookSecret||"Not set yet":"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"})}),e.jsxs("div",{className:"mt-2 flex flex-wrap gap-2",children:[e.jsxs(i,{variant:"secondary",size:"sm",onClick:()=>ae(a=>({...a,[s.id]:!a[s.id]})),children:[e.jsx("i",{className:"ri-eye-line mr-1"}),te[s.id]?"Hide":"Reveal"]}),e.jsxs(i,{variant:"secondary",size:"sm",disabled:!s.webhookSecret,onClick:()=>G(s.webhookSecret||"","Webhook secret"),children:[e.jsx("i",{className:"ri-file-copy-line mr-1"}),"Copy Secret"]}),e.jsx(i,{variant:"warning",size:"sm",disabled:W[s.id],onClick:()=>fe(s),children:W[s.id]?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Updating..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-refresh-line mr-1"}),"Regenerate"]})})]}),e.jsx("p",{className:"mt-2 text-xs text-gray-500",children:"Regenerating the secret invalidates existing TradingView alertsâ€”remember to update them."})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs uppercase font-semibold text-gray-500",children:"Webhook URL"}),e.jsx("div",{className:"mt-1 font-mono text-sm bg-white border border-gray-200 rounded px-3 py-2 flex items-center justify-between",children:e.jsx("span",{className:"truncate pr-3",children:ie})}),e.jsx("div",{className:"mt-2 flex flex-wrap gap-2",children:e.jsxs(i,{variant:"secondary",size:"sm",onClick:()=>G(ie,"Webhook URL"),children:[e.jsx("i",{className:"ri-file-copy-line mr-1"}),"Copy URL"]})}),e.jsxs("div",{className:"mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-xs uppercase font-semibold text-gray-500",children:"Immediate Execution"}),e.jsx("button",{onClick:()=>we(s),disabled:W[s.id],className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${W[s.id]?"opacity-50 cursor-not-allowed":""} ${s.webhookTriggerImmediate?"bg-blue-600":"bg-gray-300"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${s.webhookTriggerImmediate?"translate-x-6":"translate-x-1"}`})})]}),e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"When enabled, the webhook calls bot-executor immediately after logging the signal."})]})]})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h5",{className:"text-xs font-semibold text-gray-600 uppercase",children:"TradingView Alert Payload"}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(i,{variant:"secondary",size:"sm",onClick:()=>G(le(s),"Alert payload JSON"),children:[e.jsx("i",{className:"ri-code-line mr-1"}),"Copy JSON"]})})]}),e.jsx("pre",{className:"bg-white border border-gray-200 rounded p-3 text-xs overflow-x-auto",children:le(s)})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("h5",{className:"text-xs font-semibold text-gray-600 uppercase",children:"Recent Webhook Signals"}),e.jsx("div",{className:"flex gap-2",children:e.jsx(i,{variant:"secondary",size:"sm",onClick:()=>K(s.id),disabled:E[s.id],children:E[s.id]?e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Refreshing..."]}):e.jsxs(e.Fragment,{children:[e.jsx("i",{className:"ri-refresh-line mr-1"}),"Refresh"]})})})]}),E[s.id]?e.jsxs("div",{className:"text-sm text-gray-600 flex items-center gap-2",children:[e.jsx("i",{className:"ri-loader-4-line animate-spin"}),"Loading signals..."]}):B[s.id]&&B[s.id].length>0?e.jsx("div",{className:"overflow-x-auto",children:e.jsxs("table",{className:"min-w-full text-xs bg-white border border-gray-200 rounded-lg overflow-hidden",children:[e.jsx("thead",{className:"bg-gray-100 text-gray-600 uppercase",children:e.jsxs("tr",{children:[e.jsx("th",{className:"px-3 py-2 text-left",children:"Created"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Side"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Mode"}),e.jsx("th",{className:"px-3 py-2 text-right",children:"Size x"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Reason"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Status"}),e.jsx("th",{className:"px-3 py-2 text-left",children:"Processed"})]})}),e.jsx("tbody",{children:B[s.id].map(a=>e.jsxs("tr",{className:"border-t border-gray-100",children:[e.jsx("td",{className:"px-3 py-2 whitespace-nowrap text-gray-700",children:ne(a.created_at)}),e.jsx("td",{className:"px-3 py-2 uppercase font-semibold text-gray-700",children:a.side||"â€”"}),e.jsx("td",{className:"px-3 py-2 capitalize text-gray-700",children:a.mode}),e.jsx("td",{className:"px-3 py-2 text-right text-gray-700",children:(a.size_multiplier??1).toFixed(2)}),e.jsxs("td",{className:"px-3 py-2 text-gray-700",children:[a.reason||"â€”",a.error&&e.jsxs("div",{className:"text-red-600 mt-1",children:["Error: ",a.error]})]}),e.jsx("td",{className:"px-3 py-2",children:e.jsx("span",{className:`px-2 py-1 rounded-full text-[10px] font-semibold ${je(a.status)}`,children:a.status.toUpperCase()})}),e.jsx("td",{className:"px-3 py-2 text-gray-700",children:a.processed_at?ne(a.processed_at):"Pending"})]},a.id))})]})}):e.jsxs("div",{className:"text-sm text-gray-600 flex items-center gap-2",children:[e.jsx("i",{className:"ri-information-line"}),"No webhook signals recorded yet."]})]})]})]})})(),!o&&e.jsxs("div",{className:"pt-4 border-t border-gray-100",children:[e.jsxs("div",{className:"flex space-x-2 mb-2",children:[s.status==="running"?e.jsxs(e.Fragment,{children:[e.jsxs(i,{variant:"warning",size:"sm",className:"flex-1",onClick:()=>D(s.id),disabled:j,children:[e.jsx("i",{className:"ri-play-circle-line mr-1"}),"Execute"]}),e.jsxs(i,{variant:"secondary",size:"sm",onClick:()=>Q(s.id,"pause"),children:[e.jsx("i",{className:"ri-pause-line mr-1"}),"Pause"]})]}):e.jsxs(i,{variant:"success",size:"sm",className:"flex-1",onClick:()=>Q(s.id,"start"),children:[e.jsx("i",{className:"ri-play-line mr-1"}),"Start"]}),e.jsx(i,{variant:"danger",size:"sm",onClick:()=>Q(s.id,"stop"),children:e.jsx("i",{className:"ri-stop-line"})}),e.jsx(i,{variant:"secondary",size:"sm",onClick:()=>p("/bot-activity"),children:e.jsx("i",{className:"ri-file-list-line"})})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-gray-50 rounded-lg",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("i",{className:"ri-brain-line text-purple-600"}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:"AI/ML System"})]}),e.jsx("button",{onClick:()=>Ee(s.id,s.aiMlEnabled||!1),disabled:q===s.id,className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${q===s.id?"opacity-50 cursor-not-allowed":""} ${s.aiMlEnabled?"bg-purple-600":"bg-gray-300"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${s.aiMlEnabled?"translate-x-6":"translate-x-1"}`})})]}),e.jsxs("div",{className:`flex items-center justify-between p-3 rounded-lg border ${s.paperTrading?"bg-yellow-50 border-yellow-200":"bg-red-50 border-red-200 shadow-inner"}`,children:[e.jsxs("div",{className:"flex flex-col",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx("i",{className:`ri-${s.paperTrading?"edit-box-line":"money-dollar-circle-line"} text-yellow-600`}),e.jsx("span",{className:"text-sm font-medium text-gray-700",children:s.paperTrading?"ðŸ“ Paper Trading":"ðŸ’° Real Trading"})]}),!s.paperTrading&&e.jsxs("div",{className:"flex items-center mt-1 text-xs font-semibold text-red-600 uppercase tracking-wide",children:[e.jsxs("span",{className:"relative flex h-2.5 w-2.5 mr-2",children:[e.jsx("span",{className:"animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"}),e.jsx("span",{className:"relative inline-flex rounded-full h-2.5 w-2.5 bg-red-500"})]}),"Live Trading Active"]})]}),e.jsx("button",{onClick:()=>Fe(s),className:`relative inline-flex h-6 w-11 items-center rounded-full transition-colors ${s.paperTrading?"bg-yellow-600":"bg-gray-300"}`,children:e.jsx("span",{className:`inline-block h-4 w-4 transform rounded-full bg-white transition-transform ${s.paperTrading?"translate-x-6":"translate-x-1"}`})})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(i,{variant:"primary",size:"sm",className:"flex-1",onClick:()=>Be(s.id),children:[e.jsx("i",{className:"ri-edit-line mr-1"}),"Edit"]}),e.jsxs(i,{variant:"secondary",size:"sm",className:"flex-1",onClick:()=>Le(s),title:"Clone this bot with all settings",children:[e.jsx("i",{className:"ri-file-copy-line mr-1"}),"Clone"]}),e.jsxs(i,{variant:"warning",size:"sm",className:"flex-1",onClick:()=>_e(s.id,s.name),children:[e.jsx("i",{className:"ri-refresh-line mr-1"}),"Reset"]}),e.jsxs(i,{variant:"danger",size:"sm",className:"flex-1",onClick:()=>Ae(s.id,s.name),children:[e.jsx("i",{className:"ri-delete-bin-line mr-1"}),"Delete"]})]})]})]},s.id))})]})}),e.jsx(Ue,{})]})}export{Xe as default};
