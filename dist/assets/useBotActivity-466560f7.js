import{r as u,s as m}from"./index-41a0ae00.js";function M(l){const[x,d]=u.useState([]),[h,w]=u.useState(!0),[A,y]=u.useState(null),S=async(r,t)=>{try{const{data:{user:e}}=await m.auth.getUser();if(!e)throw new Error("No active session");const s={bot_id:r,level:t.level,category:t.category,message:t.message,details:t.details,timestamp:new Date().toISOString()},{error:i}=await m.from("bot_activity_logs").insert(s);if(i){console.error("Error saving log to database:",i);const n=[...JSON.parse(localStorage.getItem(`bot_logs_${r}`)||"[]"),{...t,id:Date.now().toString(),botId:r,timestamp:new Date().toISOString()}];localStorage.setItem(`bot_logs_${r}`,JSON.stringify(n))}return d(a=>a.map(n=>n.botId===r?{...n,logs:[{...t,id:Date.now().toString(),botId:r,timestamp:new Date().toISOString()},...n.logs.slice(0,49)],lastActivity:new Date().toISOString(),errorCount:t.level==="error"?n.errorCount+1:n.errorCount,successCount:t.level==="success"?n.successCount+1:n.successCount}:n)),s}catch(e){throw console.error("Error adding bot log:",e),e}},v=async r=>{try{const{data:{user:t}}=await m.auth.getUser();if(!t)throw new Error("No active session");const{data:e,error:s}=await m.from("bot_activity_logs").select("*").eq("bot_id",r).order("timestamp",{ascending:!1}).limit(100);return s?(console.error("Error fetching bot logs from database:",s),JSON.parse(localStorage.getItem(`bot_logs_${r}`)||"[]").sort((a,n)=>new Date(n.timestamp).getTime()-new Date(a.timestamp).getTime())):e||[]}catch(t){return console.error("Error fetching bot logs:",t),JSON.parse(localStorage.getItem(`bot_logs_${r}`)||"[]").sort((s,i)=>new Date(i.timestamp).getTime()-new Date(s.timestamp).getTime())}},L=(r,t)=>{if(t!=="running")return{currentAction:`Bot is ${t}`,executionState:"idle"};if(r.length===0)return{currentAction:"Initializing...",waitingFor:"First execution",executionState:"waiting"};const e=r[0],s=new Date(e.timestamp).getTime(),i=Date.now(),a=i-s,n=5*60*1e3,f=60*1e3,c=r.filter(p=>p.level==="error"&&i-new Date(p.timestamp).getTime()<n);if(c.length>0)return{currentAction:`Error: ${c[0].message}`,executionState:"error"};const o=e.message.toLowerCase();if(o.includes("executing")||o.includes("execution")||o.includes("starting execution"))return{currentAction:e.message,executionState:"executing"};if(o.includes("analyzing")||o.includes("analysis")||o.includes("market data")||o.includes("rsi")||o.includes("adx"))return{currentAction:e.message,executionState:"analyzing"};if(o.includes("trade")&&(o.includes("placed")||o.includes("executed")||o.includes("opened")||o.includes("closed")))return{currentAction:e.message,executionState:"executing"};if(o.includes("waiting")||o.includes("monitoring")||o.includes("syncing time"))return{currentAction:e.message,waitingFor:o.includes("waiting")?"Market signal":"Next execution cycle",executionState:"waiting"};if(a>n)return{currentAction:`Last activity: ${_(a)}`,waitingFor:"Next cron execution",executionState:"waiting"};if(a<f)return{currentAction:e.message,executionState:e.category==="trade"?"executing":"analyzing"};const D={trade:"executing",market:"analyzing",strategy:"analyzing",system:"waiting",error:"error"};return{currentAction:e.message,waitingFor:e.category==="market"?"Market conditions":void 0,executionState:D[e.category]||"waiting"}},_=r=>{const t=Math.floor(r/1e3),e=Math.floor(t/60),s=Math.floor(e/60),i=Math.floor(s/24);return i>0?`${i}d ago`:s>0?`${s}h ago`:e>0?`${e}m ago`:`${t}s ago`},g=async()=>{try{if(w(!0),y(null),!l||l.length===0){d([]);return}const r=await Promise.all(l.map(async t=>{const e=await v(t.id),s=e.filter(c=>c.level==="error").length,i=e.filter(c=>c.level==="success").length,a=L(e,t.status),n=e.find(c=>c.category==="trade"),f=n?n.timestamp:null;return{botId:t.id,botName:t.name,status:t.status,lastActivity:e.length>0?e[0].timestamp:t.createdAt,lastExecutionTime:f,logs:e.slice(0,50),isActive:t.status==="running",currentAction:a.currentAction,waitingFor:a.waitingFor,executionState:a.executionState,errorCount:s,successCount:i}}));d(r)}catch(r){console.error("Error fetching bot activities:",r),y(r instanceof Error?r.message:"Failed to fetch activities")}finally{w(!1)}},E=async r=>{try{localStorage.removeItem(`bot_logs_${r}`),await g()}catch(t){console.error("Error clearing bot logs:",t)}},k=async r=>{const t=[{level:"info",category:"system",message:"Bot initialized successfully"},{level:"info",category:"market",message:"Analyzing market conditions..."},{level:"info",category:"strategy",message:"RSI: 45, ADX: 28 - Market trending"},{level:"success",category:"trade",message:"Long position opened at $45,250"},{level:"info",category:"market",message:"Monitoring position..."},{level:"warning",category:"market",message:"Price approaching stop loss"},{level:"success",category:"trade",message:"Position closed with +2.5% profit"}];for(const e of t)await S(r,e),await new Promise(s=>setTimeout(s,1e3))};return u.useEffect(()=>{g();const r=setInterval(g,1e4);return()=>clearInterval(r)},[l]),{activities:x,loading:h,error:A,addLog:S,fetchBotLogs:v,clearBotLogs:E,simulateBotActivity:k,refetch:g}}export{M as u};
