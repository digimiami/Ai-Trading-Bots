import{r as i,s as o,j as e}from"./index-41a0ae00.js";import{C as O}from"./Card-0516a8f2.js";import{B as g}from"./Button-0b498d06.js";function ee(){const[l,S]=i.useState(null),[M,A]=i.useState(!1),[B,j]=i.useState(""),[L,N]=i.useState(""),[z,P]=i.useState(!1),[$,_]=i.useState(""),[J,E]=i.useState(!1),[w,V]=i.useState(!0),[D,k]=i.useState(!1),[p,x]=i.useState([]),[v,T]=i.useState(!1),q=async()=>{const{data:{session:t}}=await o.auth.getSession();if(!t)return null;const a=await fetch(`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/paper-trading`,{method:"POST",headers:{Authorization:`Bearer ${t.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({action:"get_balance"})});if(!a.ok){const n=await a.json().catch(()=>({}));return console.error("Failed to ensure paper account exists:",(n==null?void 0:n.error)||a.statusText),null}const s=await a.json().catch(()=>null);return(s==null?void 0:s.account)??null};i.useEffect(()=>{f(),d();const t=setInterval(()=>{d()},1e4);return()=>clearInterval(t)},[]);const f=async()=>{const{data:{user:t}}=await o.auth.getUser();if(!t)return;const{data:a,error:s}=await o.from("paper_trading_accounts").select("*").eq("user_id",t.id).single();if(a){S(a);return}if((s==null?void 0:s.code)==="PGRST116"||!a){const n=await q();S(n||null)}},d=async()=>{try{T(!0);const{data:{user:t}}=await o.auth.getUser();if(!t){x([]);return}const{data:a,error:s}=await o.from("trading_bots").select("id, name").eq("user_id",t.id).eq("paper_trading",!0);if(s){console.error("Error fetching paper bots:",s),x([]);return}if(!a||a.length===0){x([]);return}const n=a.map(m=>m.id),u=new Map(a.map(m=>[m.id,m.name])),{data:c,error:C}=await o.from("bot_activity_logs").select("*").in("bot_id",n).order("timestamp",{ascending:!1}).limit(50);if(C){console.error("Error fetching logs:",C),x([]);return}if(console.log(`ðŸ“ [Paper Logs] Found ${(c==null?void 0:c.length)||0} total logs for ${n.length} paper bots`),c&&c.length>0){const m=c.filter(r=>{var y;const h=r.message||"",b=h.includes("[PAPER]")||h.includes("ðŸ“")||h.includes("PAPER")||((y=r.details)==null?void 0:y.paper_trading)===!0;return b&&console.log("ðŸ“ [Paper Logs] Found paper log:",r.message),b});console.log(`ðŸ“ [Paper Logs] Filtered to ${m.length} paper trading logs`);const Q=m.slice(0,20).map(r=>{var h,b,y,R,U;return{id:r.id,timestamp:r.timestamp,level:r.level,category:r.category,message:r.message,bot_name:u.get(r.bot_id),symbol:((h=r.details)==null?void 0:h.symbol)||((y=(b=r.details)==null?void 0:b.paper_trading)==null?void 0:y.symbol)||((U=(R=r.details)==null?void 0:R.paper_trading)==null?void 0:U.side)}});x(Q)}else console.log("ðŸ“ [Paper Logs] No logs found"),x([])}catch(t){console.error("Error fetching paper trading logs:",t),x([])}finally{T(!1)}},W=async()=>{const t=parseFloat(B);if(!t||t<=0){alert("Please enter a valid amount");return}A(!0);try{const{data:{session:a}}=await o.auth.getSession();if(!a)throw new Error("Not authenticated");const s=await fetch(`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/paper-trading`,{method:"POST",headers:{Authorization:`Bearer ${a==null?void 0:a.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({action:"add_funds",amount:t})});if(s.ok)await f(),j(""),alert(`âœ… Added $${t.toFixed(2)} to paper trading balance`),setTimeout(()=>d(),1e3);else{const n=await s.json();throw new Error(n.error||"Failed to add funds")}}catch(a){alert("Error adding funds: "+a.message)}finally{A(!1)}},G=async()=>{const t=parseFloat(L);if(isNaN(t)||t<0){alert("Please enter a valid amount (0 or greater)");return}P(!0);try{const{data:{session:a}}=await o.auth.getSession();if(!a)throw new Error("Not authenticated");const s=await fetch(`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/paper-trading`,{method:"POST",headers:{Authorization:`Bearer ${a==null?void 0:a.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({action:"set_balance",amount:t})});if(!s.ok){const n=await s.json();throw new Error(n.error||"Failed to set balance")}await f(),N(""),alert(`âœ… Paper trading balance set to $${t.toFixed(2)}`),setTimeout(()=>d(),1e3)}catch(a){alert("Error setting balance: "+a.message)}finally{P(!1)}},H=async()=>{const t=parseFloat($);if(!t||t<=0){alert("Please enter a valid initial balance greater than 0");return}E(!0);try{const{data:{session:a}}=await o.auth.getSession();if(!a)throw new Error("Not authenticated");const s=await fetch(`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/paper-trading`,{method:"POST",headers:{Authorization:`Bearer ${a==null?void 0:a.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({action:"set_initial_balance",amount:t,applyToBalance:w})});if(!s.ok){const n=await s.json();throw new Error(n.error||"Failed to set initial balance")}await f(),w&&(N(""),j("")),_(""),alert(`âœ… Initial balance set to $${t.toFixed(2)}${w?" (current balance updated too)":""}`),setTimeout(()=>d(),1e3)}catch(a){alert("Error setting initial balance: "+a.message)}finally{E(!1)}},K=async()=>{if(window.confirm("Resetting will restore your paper trading account to your initial balance and clear open paper trades. Continue?")){k(!0);try{const{data:{session:a}}=await o.auth.getSession();if(!a)throw new Error("Not authenticated");const s=await fetch(`${{}.VITE_PUBLIC_SUPABASE_URL}/functions/v1/paper-trading`,{method:"POST",headers:{Authorization:`Bearer ${a==null?void 0:a.access_token}`,"Content-Type":"application/json"},body:JSON.stringify({action:"reset_balance"})});if(!s.ok){const n=await s.json();throw new Error(n.error||"Failed to reset balance")}await f(),j(""),N(""),_(""),alert("âœ… Paper trading balance reset to your initial balance"),setTimeout(()=>d(),1e3)}catch(a){alert("Error resetting balance: "+a.message)}finally{k(!1)}}},F=t=>{switch(t){case"info":return"ri-information-line text-blue-600";case"warning":return"ri-alert-line text-yellow-600";case"error":return"ri-error-warning-line text-red-600";case"success":return"ri-checkbox-circle-line text-green-600";default:return"ri-information-line text-gray-600"}},I=t=>{const a=new Date(t),n=new Date().getTime()-a.getTime(),u=Math.floor(n/6e4),c=Math.floor(u/60);return u<1?"Just now":u<60?`${u}m ago`:c<24?`${c}h ago`:a.toLocaleDateString()+" "+a.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})};return l?e.jsxs(O,{className:"p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"ðŸ“ Paper Trading Balance"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Available Balance:"}),e.jsxs("span",{className:"text-xl font-bold text-green-600",children:["$",parseFloat(l.balance).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Initial Balance:"}),e.jsxs("span",{children:["$",parseFloat(l.initial_balance).toFixed(2)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-500",children:"Total Deposited:"}),e.jsxs("span",{className:"text-green-600",children:["$",parseFloat(l.total_deposited||0).toFixed(2)]})]}),e.jsxs("div",{className:"border-t pt-3 mt-3 space-y-3",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",value:B,onChange:t=>j(t.target.value),placeholder:"Amount to add",className:"flex-1 px-3 py-2 border rounded-lg",min:"1",step:"0.01"}),e.jsx(g,{onClick:W,loading:M,variant:"primary",children:"Add Funds"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("input",{type:"number",value:L,onChange:t=>N(t.target.value),placeholder:`Set balance${l&&typeof l.balance<"u"?` (current $${parseFloat(l.balance).toFixed(2)})`:""}`,className:"flex-1 px-3 py-2 border rounded-lg",min:"0",step:"0.01"}),e.jsx(g,{onClick:G,loading:z,variant:"secondary",children:"Set Balance"})]}),e.jsxs("div",{className:"border border-blue-200 bg-blue-50 rounded-lg px-3 py-3 space-y-3",children:[e.jsxs("div",{className:"flex flex-col gap-2 md:flex-row md:items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("label",{className:"block text-xs font-semibold text-blue-700 mb-1",children:"Set Initial Balance"}),e.jsx("input",{type:"number",value:$,onChange:t=>_(t.target.value),placeholder:`Initial balance${l&&typeof l.initial_balance<"u"?` (current $${parseFloat(l.initial_balance).toFixed(2)})`:""}`,className:"w-full px-3 py-2 border rounded-lg",min:"1",step:"0.01"})]}),e.jsx(g,{onClick:H,loading:J,variant:"success",className:"md:w-auto w-full",children:"Save Initial Balance"})]}),e.jsxs("label",{className:"flex items-center gap-2 text-xs text-blue-800",children:[e.jsx("input",{type:"checkbox",checked:w,onChange:t=>V(t.target.checked)}),"Also update current available balance when saving initial balance"]})]}),e.jsxs("div",{className:"flex items-center justify-between bg-red-50 border border-red-200 rounded-lg px-3 py-2",children:[e.jsxs("div",{className:"text-sm text-red-700",children:[e.jsx("p",{className:"font-medium",children:"Reset Paper Account"}),e.jsx("p",{className:"text-xs text-red-600",children:"Restores your initial balance setting and clears paper positions/trades."})]}),e.jsx(g,{onClick:K,loading:D,variant:"danger",children:"Reset Balance"})]})]}),e.jsxs("div",{className:"border-t pt-4 mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"Recent Activity"}),e.jsx(g,{onClick:d,variant:"secondary",size:"sm",loading:v,children:e.jsx("i",{className:"ri-refresh-line"})})]}),v&&p.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-500 text-sm",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{children:"Loading activity..."})]}):p.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-500 text-sm",children:[e.jsx("i",{className:"ri-file-list-line text-2xl mb-2 block"}),e.jsx("p",{children:"No paper trading activity yet"}),e.jsx("p",{className:"text-xs mt-1",children:"Activity will appear here when bots execute trades"}),e.jsx("p",{className:"text-xs mt-1 text-gray-400",children:"Make sure you have paper trading bots running"})]}):e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:p.map(t=>e.jsx("div",{className:"p-2 bg-gray-50 rounded-lg border border-gray-200 text-sm hover:bg-gray-100 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("i",{className:`${F(t.level)} mt-0.5 flex-shrink-0`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 flex-wrap",children:[t.bot_name&&e.jsx("span",{className:"font-medium text-gray-900 text-xs",children:t.bot_name}),t.symbol&&e.jsx("span",{className:"text-xs text-gray-500 bg-gray-200 px-1.5 py-0.5 rounded",children:t.symbol}),e.jsx("span",{className:"text-xs text-gray-400 ml-auto",children:I(t.timestamp)})]}),e.jsx("p",{className:"text-xs text-gray-700 break-words",children:t.message}),t.category&&e.jsx("span",{className:"inline-block mt-1 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded",children:t.category})]})]})},t.id))})]})]})]}):e.jsxs(O,{className:"p-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-3",children:"ðŸ“ Paper Trading Balance"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"text-center py-4 text-gray-500 text-sm",children:[e.jsx("i",{className:"ri-wallet-line text-2xl mb-2 block"}),e.jsx("p",{children:"Account will be created on first trade"}),e.jsx("p",{className:"text-xs mt-1",children:"Default balance: $10,000"})]}),e.jsxs("div",{className:"border-t pt-4 mt-4",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsx("h4",{className:"text-sm font-semibold text-gray-700",children:"Recent Activity"}),e.jsx(g,{onClick:d,variant:"secondary",size:"sm",loading:v,children:e.jsx("i",{className:"ri-refresh-line"})})]}),v&&p.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-500 text-sm",children:[e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-blue-600 mx-auto mb-2"}),e.jsx("p",{children:"Loading activity..."})]}):p.length===0?e.jsxs("div",{className:"text-center py-4 text-gray-500 text-sm",children:[e.jsx("i",{className:"ri-file-list-line text-2xl mb-2 block"}),e.jsx("p",{children:"No paper trading activity yet"}),e.jsx("p",{className:"text-xs mt-1",children:"Activity will appear here when bots execute trades"}),e.jsx("p",{className:"text-xs mt-1 text-gray-400",children:"Make sure you have paper trading bots running"})]}):e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:p.map(t=>e.jsx("div",{className:"p-2 bg-gray-50 rounded-lg border border-gray-200 text-sm hover:bg-gray-100 transition-colors",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("i",{className:`${F(t.level)} mt-0.5 flex-shrink-0`}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 flex-wrap",children:[t.bot_name&&e.jsx("span",{className:"font-medium text-gray-900 text-xs",children:t.bot_name}),t.symbol&&e.jsx("span",{className:"text-xs text-gray-500 bg-gray-200 px-1.5 py-0.5 rounded",children:t.symbol}),e.jsx("span",{className:"text-xs text-gray-400 ml-auto",children:I(t.timestamp)})]}),e.jsx("p",{className:"text-xs text-gray-700 break-words",children:t.message}),t.category&&e.jsx("span",{className:"inline-block mt-1 px-2 py-0.5 bg-blue-100 text-blue-700 text-xs rounded",children:t.category})]})]})},t.id))})]})]})]})}export{ee as P};
