name: ğŸš€ Deploy to Supabase & VPS

on:
  push:
    branches: [master]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-supabase:
    name: ğŸ“¦ Deploy to Supabase
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
          
      - name: debug
        run: |
            cat -A .env
      
      - name: ğŸ”— Link to Supabase project
        run: |
            cat -A .env | head
            echo "Linking project without loading .env"
            supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --debug
        
      
      - name: ğŸš€ Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
        run: |
          echo "ğŸš€ Deploying all Edge Functions..."
          
          # Deploy each function with error handling
          supabase functions deploy bot-executor --no-verify-jwt || echo "âš ï¸ bot-executor deployment failed"
          supabase functions deploy bot-management --no-verify-jwt || echo "âš ï¸ bot-management deployment failed"
          supabase functions deploy admin-management-enhanced --no-verify-jwt || echo "âš ï¸ admin-management-enhanced deployment failed"
          supabase functions deploy trading-engine --no-verify-jwt || echo "âš ï¸ trading-engine deployment failed"
          supabase functions deploy telegram-notifier --no-verify-jwt || echo "âš ï¸ telegram-notifier deployment failed"
          supabase functions deploy market-data --no-verify-jwt || echo "âš ï¸ market-data deployment failed"
          supabase functions deploy ml-predictions --no-verify-jwt || echo "âš ï¸ ml-predictions deployment failed"
          supabase functions deploy alerts-system --no-verify-jwt || echo "âš ï¸ alerts-system deployment failed"
          supabase functions deploy api-keys --no-verify-jwt || echo "âš ï¸ api-keys deployment failed"
          supabase functions deploy profile-management --no-verify-jwt || echo "âš ï¸ profile-management deployment failed"
          supabase functions deploy risk-management --no-verify-jwt || echo "âš ï¸ risk-management deployment failed"
          supabase functions deploy invitation-management --no-verify-jwt || echo "âš ï¸ invitation-management deployment failed"
          
          echo "âœ… Edge functions deployment completed!"
      
      - name: ğŸ“‹ Deploy Info
        run: |
          echo "ğŸ“… Date: $(date)"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"

  deploy-vps:
    name: ğŸŒ Deploy to VPS
    runs-on: ubuntu-latest
    needs: deploy-supabase # Wait for Supabase deployment first
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“‹ Deploy Info
        run: |
          echo "ğŸš€ Starting VPS deployment..."
          echo "ğŸ“… Date: $(date)"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
      
      - name: ğŸ”‘ Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
      
      - name: ğŸš€ Deploy via SSH
        run: |
          # Connect to the VPS and run commands remotely
          ssh -o StrictHostKeyChecking=no ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            
            # Navigate to project directory
            cd "/var/www/Ai-Trading-Bots"
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes..."
            git fetch origin master
            git reset --hard origin/master
            
            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            npm install
            
            # Build the application
            echo "ğŸ”¨ Building application..."
            npm run build
            
            # Restart PM2 process
            echo "ğŸ”„ Restarting application..."
            pm2 restart pablobots || pm2 start --name pablobots npm -- run preview
            
            # Save PM2 process
            echo "ğŸ’¾ Saving PM2 process..."
            pm2 save
            
            # Show recent logs
            echo "ğŸ“‹ Recent logs:"
            pm2 logs pablobots --lines 10 --nostream
          EOF
      
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "âœ… VPS deployment completed!"
          echo "ğŸŒ Your trading bot should be live at: https://${{ secrets.VPS_HOST }}"
          echo "ğŸ“± Check PM2 status: ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} 'pm2 status'"
