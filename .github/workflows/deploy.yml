name: ğŸš€ Deploy to Supabase & VPS

on:
  push:
    branches: [master]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-supabase:
    name: ğŸ“¦ Deploy to Supabase
    runs-on: ubuntu-latest
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ”§ Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: ğŸ”— Link to Supabase project
        env:
            SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
            SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
            SUPABASE_DOTENV: "0"
        run: |
            echo "Linking project without loading .env"
            if [ -f .env ]; then
              echo "âš ï¸ .env file found (this should not be committed)"
              head -5 .env || echo "Could not read .env"
            else
              echo "âœ… No .env file (as expected - environment variables via secrets)"
            fi
            supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --debug
        
      
      - name: ğŸš€ Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DOTENV: "0"
        run: |
          echo "ğŸš€ Deploying all Edge Functions..."
          
          # Deploy each function with error handling
          supabase functions deploy bot-executor --no-verify-jwt || echo "âš ï¸ bot-executor deployment failed"
          supabase functions deploy bot-management --no-verify-jwt || echo "âš ï¸ bot-management deployment failed"
          supabase functions deploy admin-management-enhanced --no-verify-jwt || echo "âš ï¸ admin-management-enhanced deployment failed"
          supabase functions deploy trading-engine --no-verify-jwt || echo "âš ï¸ trading-engine deployment failed"
          supabase functions deploy telegram-notifier --no-verify-jwt || echo "âš ï¸ telegram-notifier deployment failed"
          supabase functions deploy market-data --no-verify-jwt || echo "âš ï¸ market-data deployment failed"
          supabase functions deploy futures-pairs --no-verify-jwt || echo "âš ï¸ futures-pairs deployment failed"
          supabase functions deploy ml-predictions --no-verify-jwt || echo "âš ï¸ ml-predictions deployment failed"
          supabase functions deploy alerts-system --no-verify-jwt || echo "âš ï¸ alerts-system deployment failed"
          supabase functions deploy api-keys --no-verify-jwt || echo "âš ï¸ api-keys deployment failed"
          supabase functions deploy profile-management --no-verify-jwt || echo "âš ï¸ profile-management deployment failed"
          supabase functions deploy risk-management --no-verify-jwt || echo "âš ï¸ risk-management deployment failed"
          supabase functions deploy invitation-management --no-verify-jwt || echo "âš ï¸ invitation-management deployment failed"
          supabase functions deploy check-ai-keys --no-verify-jwt || echo "âš ï¸ check-ai-keys deployment failed"
          supabase functions deploy paper-trading --no-verify-jwt || echo "âš ï¸ paper-trading deployment failed"
          
          echo "âœ… Edge functions deployment completed!"
      
      - name: ğŸ“‹ Deploy Info
        run: |
          echo "ğŸ“… Date: $(date)"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"

  deploy-vps:
    name: ğŸŒ Deploy to VPS
    runs-on: ubuntu-latest
    needs: deploy-supabase # Wait for Supabase deployment first
    
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ“‹ Deploy Info
        run: |
          echo "ğŸš€ Starting VPS deployment..."
          echo "ğŸ“… Date: $(date)"
          echo "ğŸŒ¿ Branch: ${{ github.ref_name }}"
          echo "ğŸ‘¤ Actor: ${{ github.actor }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
      
      - name: ğŸ”‘ Set up SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
      
      - name: ğŸš€ Deploy via SSH
        run: |
          # Connect to the VPS and run commands remotely
          ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} bash << 'ENDSSH'
            set -euo pipefail
            
            echo "ğŸš€ Starting VPS deployment..."
            echo "ğŸ“‚ Current directory: $(pwd)"
            echo "ğŸ‘¤ User: $(whoami)"
            
            # Navigate to project directory
            echo "ğŸ“‚ Navigating to project directory..."
            if [ ! -d "/var/www/Ai-Trading-Bots" ]; then
              echo "âŒ Directory /var/www/Ai-Trading-Bots does not exist!"
              exit 1
            fi
            cd "/var/www/Ai-Trading-Bots" || {
              echo "âŒ Failed to navigate to project directory"
              exit 1
            }
            echo "âœ… In project directory: $(pwd)"
            
            # Check git status
            echo "ğŸ“¥ Checking git status..."
            git status || {
              echo "âš ï¸ Git status check failed, but continuing..."
            }
            
            # Pull latest changes
            echo "ğŸ“¥ Pulling latest changes..."
            if ! git fetch origin master 2>&1; then
              echo "âš ï¸ Git fetch failed, but continuing..."
            fi
            
            if ! git reset --hard origin/master 2>&1; then
              echo "âŒ Git reset failed"
              echo "ğŸ“‹ Git log:"
              git log --oneline -5 || true
              exit 1
            fi
            echo "âœ… Git reset successful"
            
            # Check Node.js and npm versions
            echo "ğŸ“‹ Node.js version: $(node --version || echo 'not found')"
            echo "ğŸ“‹ npm version: $(npm --version || echo 'not found')"
            
            # Install dependencies
            echo "ğŸ“¦ Installing dependencies..."
            if ! npm install 2>&1; then
              echo "âŒ npm install failed"
              exit 1
            fi
            echo "âœ… Dependencies installed"
            
            # Build the application
            echo "ğŸ”¨ Building application..."
            if ! npm run build 2>&1; then
              echo "âŒ npm run build failed"
              echo "ğŸ“‹ Build output (last 50 lines):"
              npm run build 2>&1 | tail -50 || true
              exit 1
            fi
            echo "âœ… Build successful"
            
            # Check PM2
            echo "ğŸ“‹ Checking PM2..."
            if ! command -v pm2 &> /dev/null; then
              echo "âŒ PM2 is not installed or not in PATH"
              exit 1
            fi
            echo "âœ… PM2 found: $(pm2 --version || echo 'version check failed')"
            
            # Restart PM2 process
            echo "ğŸ”„ Checking PM2 processes..."
            pm2 list || echo "âš ï¸ PM2 list failed, but continuing..."
            
            echo "ğŸ”„ Restarting application..."
            if pm2 list | grep -q "pablobots"; then
              echo "ğŸ“Œ Process 'pablobots' exists, restarting..."
              if ! pm2 restart pablobots 2>&1; then
                echo "âš ï¸ PM2 restart failed, trying to start..."
                pm2 delete pablobots 2>&1 || true
                if ! pm2 start --name pablobots npm -- run preview 2>&1; then
                  echo "âŒ PM2 start failed"
                  exit 1
                fi
              fi
            else
              echo "ğŸ“Œ Starting new PM2 process..."
              if ! pm2 start --name pablobots npm -- run preview 2>&1; then
                echo "âŒ PM2 start failed"
                exit 1
              fi
            fi
            echo "âœ… PM2 process restarted"
            
            # Save PM2 process
            echo "ğŸ’¾ Saving PM2 process..."
            pm2 save 2>&1 || {
              echo "âš ï¸ PM2 save failed, but continuing..."
            }
            
            # Show PM2 status
            echo "ğŸ“Š PM2 status:"
            pm2 status || echo "âš ï¸ Could not get PM2 status"
            
            # Show recent logs
            echo "ğŸ“‹ Recent logs (last 10 lines):"
            pm2 logs pablobots --lines 10 --nostream 2>&1 || {
              echo "âš ï¸ Could not retrieve logs"
            }
            
            echo "âœ… Deployment completed successfully!"
          ENDSSH
      
      - name: ğŸ“Š Deployment Summary
        run: |
          echo "âœ… VPS deployment completed!"
          echo "ğŸŒ Your trading bot should be live at: https://${{ secrets.VPS_HOST }}"
          echo "ğŸ“± Check PM2 status: ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} 'pm2 status'"
