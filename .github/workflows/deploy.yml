name: üöÄ Deploy to Supabase & VPS

on:
  push:
    branches: [master]
  workflow_dispatch: # Allow manual trigger

jobs:
  deploy-supabase:
    name: üì¶ Deploy to Supabase
    runs-on: ubuntu-latest
    
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
      
      - name: üîß Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest
      
      - name: üîó Link to Supabase project
        env:
            SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
            SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
            SUPABASE_DOTENV: "0"
        run: |
            echo "Linking project without loading .env"
            if [ -f .env ]; then
              echo "‚ö†Ô∏è .env file found (this should not be committed)"
              head -5 .env || echo "Could not read .env"
            else
              echo "‚úÖ No .env file (as expected - environment variables via secrets)"
            fi
            supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --debug
        
      
      - name: üöÄ Deploy Edge Functions
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_DOTENV: "0"
        run: |
          echo "üöÄ Deploying all Edge Functions..."
          
          # Deploy each function with error handling
          supabase functions deploy bot-executor --no-verify-jwt || echo "‚ö†Ô∏è bot-executor deployment failed"
          supabase functions deploy bot-management --no-verify-jwt || echo "‚ö†Ô∏è bot-management deployment failed"
          supabase functions deploy admin-management-enhanced --no-verify-jwt || echo "‚ö†Ô∏è admin-management-enhanced deployment failed"
          supabase functions deploy trading-engine --no-verify-jwt || echo "‚ö†Ô∏è trading-engine deployment failed"
          supabase functions deploy telegram-notifier --no-verify-jwt || echo "‚ö†Ô∏è telegram-notifier deployment failed"
          supabase functions deploy market-data --no-verify-jwt || echo "‚ö†Ô∏è market-data deployment failed"
          supabase functions deploy futures-pairs --no-verify-jwt || echo "‚ö†Ô∏è futures-pairs deployment failed"
          supabase functions deploy ml-predictions --no-verify-jwt || echo "‚ö†Ô∏è ml-predictions deployment failed"
          supabase functions deploy alerts-system --no-verify-jwt || echo "‚ö†Ô∏è alerts-system deployment failed"
          supabase functions deploy api-keys --no-verify-jwt || echo "‚ö†Ô∏è api-keys deployment failed"
          supabase functions deploy profile-management --no-verify-jwt || echo "‚ö†Ô∏è profile-management deployment failed"
          supabase functions deploy risk-management --no-verify-jwt || echo "‚ö†Ô∏è risk-management deployment failed"
          supabase functions deploy invitation-management --no-verify-jwt || echo "‚ö†Ô∏è invitation-management deployment failed"
          supabase functions deploy check-ai-keys --no-verify-jwt || echo "‚ö†Ô∏è check-ai-keys deployment failed"
          supabase functions deploy paper-trading --no-verify-jwt || echo "‚ö†Ô∏è paper-trading deployment failed"
          supabase functions deploy backtest-engine --no-verify-jwt || echo "‚ö†Ô∏è backtest-engine deployment failed"
          supabase functions deploy tradingview-webhook --no-verify-jwt || echo "‚ö†Ô∏è tradingview-webhook deployment failed"
          
          echo "‚úÖ Edge functions deployment completed!"
      
      - name: üìã Deploy Info
        run: |
          echo "üìÖ Date: $(date)"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üë§ Actor: ${{ github.actor }}"
          echo "üìù Commit: ${{ github.sha }}"

  deploy-vps:
    name: üåê Deploy to VPS
    runs-on: ubuntu-latest
    needs: deploy-supabase # Wait for Supabase deployment first
    continue-on-error: true # Don't fail entire workflow if VPS deployment fails
    
    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v4
      
      - name: üìã Deploy Info
        run: |
          echo "üöÄ Starting VPS deployment..."
          echo "üìÖ Date: $(date)"
          echo "üåø Branch: ${{ github.ref_name }}"
          echo "üë§ Actor: ${{ github.actor }}"
          echo "üìù Commit: ${{ github.sha }}"
      
      - name: üîç Check VPS Connectivity
        id: check_vps
        run: |
          echo "üîç Checking VPS connectivity..."
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "‚ö†Ô∏è VPS_HOST secret is not set"
            echo "vps_available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "‚ö†Ô∏è VPS_SSH_KEY secret is not set"
            echo "vps_available=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Try to ping the host first
          echo "üì° Testing connectivity to ${{ secrets.VPS_HOST }}..."
          if timeout 5 ping -c 1 ${{ secrets.VPS_HOST }} 2>/dev/null || timeout 5 nc -zv ${{ secrets.VPS_HOST }} 22 2>/dev/null; then
            echo "‚úÖ VPS is reachable"
            echo "vps_available=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è VPS is not reachable (timeout or connection refused)"
            echo "vps_available=false" >> $GITHUB_OUTPUT
          fi
      
      - name: üîë Set up SSH
        if: steps.check_vps.outputs.vps_available == 'true'
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.VPS_SSH_KEY }}
      
      - name: üöÄ Deploy via SSH
        if: steps.check_vps.outputs.vps_available == 'true'
        timeout-minutes: 10
        run: |
          # Connect to the VPS and run commands remotely with retry logic
          MAX_RETRIES=3
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = false ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "üîÑ Attempt $RETRY_COUNT of $MAX_RETRIES..."
            
            # Try SSH connection with retry
            if ssh -o StrictHostKeyChecking=no -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3 ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} bash << 'ENDSSH'
          set -euo pipefail
          
          echo "üöÄ Starting VPS deployment..."
          echo "üìÇ Current directory: $(pwd)"
          echo "üë§ User: $(whoami)"
          
          # Navigate to project directory
          echo "üìÇ Navigating to project directory..."
          if [ ! -d "/var/www/Ai-Trading-Bots" ]; then
            echo "‚ùå Directory /var/www/Ai-Trading-Bots does not exist!"
            exit 1
          fi
          cd "/var/www/Ai-Trading-Bots" || {
            echo "‚ùå Failed to navigate to project directory"
            exit 1
          }
          echo "‚úÖ In project directory: $(pwd)"
          
          # Check git status
          echo "üì• Checking git status..."
          git status || {
            echo "‚ö†Ô∏è Git status check failed, but continuing..."
          }
          
          # Pull latest changes
          echo "üì• Pulling latest changes..."
          if ! git fetch origin master 2>&1; then
            echo "‚ö†Ô∏è Git fetch failed, but continuing..."
          fi
          
          if ! git reset --hard origin/master 2>&1; then
            echo "‚ùå Git reset failed"
            echo "üìã Git log:"
            git log --oneline -5 || true
            exit 1
          fi
          echo "‚úÖ Git reset successful"
          
          # Check Node.js and npm versions
          echo "üìã Node.js version: $(node --version || echo 'not found')"
          echo "üìã npm version: $(npm --version || echo 'not found')"
          
          # Install dependencies
          echo "üì¶ Installing dependencies..."
          if ! npm install 2>&1; then
            echo "‚ùå npm install failed"
            exit 1
          fi
          echo "‚úÖ Dependencies installed"
          
          # Build the application
          echo "üî® Building application..."
          if ! npm run build 2>&1; then
            echo "‚ùå npm run build failed"
            echo "üìã Build output (last 50 lines):"
            npm run build 2>&1 | tail -50 || true
            exit 1
          fi
          echo "‚úÖ Build successful"
          
          # Check PM2
          echo "üìã Checking PM2..."
          if ! command -v pm2 &> /dev/null; then
            echo "‚ùå PM2 is not installed or not in PATH"
            exit 1
          fi
          echo "‚úÖ PM2 found: $(pm2 --version || echo 'version check failed')"
          
          # Restart PM2 process
          echo "üîÑ Checking PM2 processes..."
          pm2 list || echo "‚ö†Ô∏è PM2 list failed, but continuing..."
          
          echo "üîÑ Restarting application..."
          if pm2 list | grep -q "pablobots"; then
            echo "üìå Process 'pablobots' exists, restarting..."
            if ! pm2 restart pablobots 2>&1; then
              echo "‚ö†Ô∏è PM2 restart failed, trying to start..."
              pm2 delete pablobots 2>&1 || true
              if ! pm2 start --name pablobots npm -- run preview 2>&1; then
                echo "‚ùå PM2 start failed"
                exit 1
              fi
            fi
          else
            echo "üìå Starting new PM2 process..."
            if ! pm2 start --name pablobots npm -- run preview 2>&1; then
              echo "‚ùå PM2 start failed"
              exit 1
            fi
          fi
          echo "‚úÖ PM2 process restarted"
          
          # Save PM2 process
          echo "üíæ Saving PM2 process..."
          pm2 save 2>&1 || {
            echo "‚ö†Ô∏è PM2 save failed, but continuing..."
          }
          
          # Show PM2 status
          echo "üìä PM2 status:"
          pm2 status || echo "‚ö†Ô∏è Could not get PM2 status"
          
          # Show recent logs
          echo "üìã Recent logs (last 10 lines):"
          pm2 logs pablobots --lines 10 --nostream 2>&1 || {
            echo "‚ö†Ô∏è Could not retrieve logs"
          }
          
          echo "‚úÖ Deployment completed successfully!"
          ENDSSH
            then
              SUCCESS=true
              echo "‚úÖ SSH deployment successful!"
            else
              SSH_EXIT_CODE=$?
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è SSH deployment failed (exit code: $SSH_EXIT_CODE), retrying in 10 seconds..."
                sleep 10
              else
                echo "‚ùå SSH deployment failed after $MAX_RETRIES attempts (last exit code: $SSH_EXIT_CODE)"
                echo "üí° Common issues:"
                echo "   - VPS is down or unreachable"
                echo "   - SSH port 22 is blocked by firewall"
                echo "   - SSH key authentication failed"
                echo "   - Network connectivity issues"
                exit 1
              fi
            fi
          done
      
      - name: ‚ö†Ô∏è VPS Deployment Skipped
        if: steps.check_vps.outputs.vps_available != 'true'
        run: |
          echo "‚ö†Ô∏è VPS deployment skipped - VPS is not reachable or secrets are not configured"
          echo "üìù Supabase deployment completed successfully"
          echo "üí° To deploy to VPS manually, check:"
          echo "   1. VPS is running and accessible"
          echo "   2. SSH port 22 is open"
          echo "   3. VPS_HOST, VPS_USERNAME, and VPS_SSH_KEY secrets are configured"
      
      - name: üìä Deployment Summary
        if: always()
        run: |
          if [ "${{ steps.check_vps.outputs.vps_available }}" = "true" ]; then
            echo "‚úÖ VPS deployment completed!"
            echo "üåê Your trading bot should be live at: https://${{ secrets.VPS_HOST }}"
            echo "üì± Check PM2 status: ssh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} 'pm2 status'"
          else
            echo "‚ö†Ô∏è VPS deployment was skipped"
            echo "‚úÖ Supabase deployment completed successfully"
          fi
